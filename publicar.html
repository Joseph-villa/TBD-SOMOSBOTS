<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hacer una Publicaci√≥n</title>
    <link rel="stylesheet" href="styles/estilos.css"> 
    <style>
    /* Variables de color */
    :root {
        --verde: #2F9A34;
        --verde-dark: #036d19;
        --verde-light: #e8f5e9;
        --bg: #f6faf6;
        --card: #ffffff;
        --text: #333;
        --muted: #666;
        --border: #e6e6e6;
    }

    /* Base */
    * {
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
        margin: 0;
        padding: 0;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    /* Contenedor principal */
    .publicar-container {
        max-width: 600px;
        margin: 40px auto;
        padding: 32px;
        background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.95));
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.03);
    }

    /* Bot√≥n Volver */
    .back-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 16px;
        background: rgba(47, 154, 52, 0.1);
        color: var(--verde-dark);
        border: 1px solid rgba(47, 154, 52, 0.15);
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        text-decoration: none;
    }

    .back-btn:hover {
        background: rgba(47, 154, 52, 0.15);
        border-color: rgba(47, 154, 52, 0.25);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(47, 154, 52, 0.15);
    }

    .back-btn:active {
        transform: translateY(0);
    }

    /* T√≠tulo */
    h2 {
        color: var(--verde);
        font-size: 1.6rem;
        margin: 0 0 24px 0;
        font-weight: 800;
        text-align: center;
    }

    /* Formulario */
    .form-publicar {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .field-row {
        margin-top: 0;
    }

    /* Etiquetas */
    label {
        display: block;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 8px;
        font-size: 0.95rem;
    }

    /* Inputs y Textareas */
    input[type="text"],
    input[type="number"],
    input[type="file"],
    textarea,
    select {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 1rem;
        font-family: inherit;
        color: var(--text);
        background: var(--card);
        transition: all 0.2s ease;
        outline: none;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    textarea:focus,
    select:focus {
        border-color: var(--verde);
        box-shadow: 0 0 0 3px rgba(47, 154, 52, 0.15);
        background: #fafffe;
    }

    textarea {
        resize: vertical;
        min-height: 100px;
        font-family: inherit;
    }

    select {
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%232F9A34' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        padding-right: 36px;
    }

    /* Preview de imagen */
    #preview {
        display: none;
        margin-top: 12px;
        max-width: 100%;
        max-height: 240px;
        border-radius: 8px;
        border: 2px solid var(--border);
        object-fit: cover;
    }

    /* Wrapper de "Otros" */
    #categoriaOtrosWrap {
        margin-top: 12px;
        padding: 12px;
        background: var(--verde-light);
        border-radius: 8px;
        border-left: 4px solid var(--verde);
    }

    #categoriaOtrosWrap input {
        margin-top: 8px;
    }

    /* Clase hidden */
    .hidden {
        display: none !important;
    }

    /* Bot√≥n Publicar */
    .btn-publicar {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, var(--verde), var(--verde-dark));
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        margin-top: 12px;
        transition: all 0.3s ease;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        box-shadow: 0 4px 12px rgba(47, 154, 52, 0.25);
    }

    .btn-publicar:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(47, 154, 52, 0.35);
    }

    .btn-publicar:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(47, 154, 52, 0.2);
    }

    .btn-publicar:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* Small input (Clase auxiliar) */
    .small-input {
        width: 100%;
        box-sizing: border-box;
    }

    /* Responsive */
    @media (max-width: 640px) {
        .publicar-container {
            margin: 20px;
            padding: 20px;
            border-radius: 10px;
        }

        h2 {
            font-size: 1.4rem;
            margin-bottom: 18px;
        }

        label {
            font-size: 0.9rem;
        }

        input,
        textarea,
        select {
            font-size: 16px; /* Evita zoom en iOS */
        }

        .btn-publicar {
            padding: 12px;
            font-size: 0.95rem;
        }
    }
</style>
</head>
<body class="publicar-body">

    <div class="publicar-container">
        <button id="backBtn" class="back-btn">‚Üê Volver</button>
        <h2>üì§ Hacer una Publicaci√≥n</h2>

        <form class="form-publicar" id="formPublicar">
            <label for="titulo">T√≠tulo del bien o servicio</label>
            <input type="text" id="titulo" placeholder="Ej. Laptop Lenovo, Corte de cabello..." required class="small-input">

            <label for="descripcion" class="field-row">Descripci√≥n</label>
            <textarea id="descripcion" placeholder="Agrega una descripci√≥n breve..." class="small-input" rows="4"></textarea>

            <label for="precio" class="field-row">Precio (en cr√©ditos)</label>
            <input type="number" id="precio" placeholder="Ej. 100" min="1" value="100" class="small-input">

            <div class="field-row">
                <label for="categoria">Categor√≠a</label>
                <select id="categoria" class="small-input" required>
                    <option value="">Cargando categor√≠as...</option>
                </select>
            </div>

            <div id="categoriaOtrosWrap" class="field-row hidden">
                <label for="categoriaOtros">Especificar categor√≠a</label>
                <input type="text" id="categoriaOtros" class="small-input" placeholder="Escribe la categor√≠a">
            </div>

            <label for="imagen" class="field-row">Subir imagen (opcional)</label>
            <input type="file" id="imagen" accept="image/*">
            <img id="preview" src="" alt="Vista previa" style="display:none; margin-top:10px; max-width:100%; border-radius:8px; max-height: 200px;">

            <div style="margin-top:20px;">
                <button type="submit" class="btn-publicar">Publicar</button>
            </div>
        </form>
    </div>

<script type="module">
    import { supabase } from './config/db.js';

    // --- FUNCI√ìN PARA CARGAR CATEGOR√çAS ---
    async function fetchCategories() {
        const select = document.getElementById('categoria');
        
        try {
            console.log('Cargando categor√≠as...');
            
            // Intentar cargar desde la tabla categoria
            const { data, error } = await supabase
                .from('categoria')
                .select('nombre')
                .order('nombre', { ascending: true });

            if (error) {
                console.error('Error al cargar categor√≠as:', error);
                // Si falla, usar categor√≠as por defecto
                useDefaultCategories();
                return;
            }

            // Limpiar el select
            select.innerHTML = '';
            
            // Opci√≥n por defecto
            select.appendChild(new Option('Selecciona una categor√≠a', ''));
            
            // Llenar con categor√≠as de la base de datos
            if (data && data.length > 0) {
                data.forEach(cat => {
                    const option = new Option(cat.nombre, cat.nombre);
                    select.appendChild(option);
                });
                console.log('Categor√≠as cargadas desde BD:', data);
            } else {
                // Si no hay categor√≠as en la BD, usar las por defecto
                useDefaultCategories();
            }
            
            // A√±adir la opci√≥n 'Otros'
            select.appendChild(new Option('Otros (Especificar)', 'OTROS'));
            
            // Configurar el listener
            setupCategoryChangeListener();

        } catch (err) {
            console.error('Error al cargar categor√≠as:', err);
            useDefaultCategories();
        }
    }

    // Categor√≠as por defecto en caso de error
    function useDefaultCategories() {
        const select = document.getElementById('categoria');
        const defaultCategories = [
            'Electr√≥nica',
            'Hogar',
            'Ropa',
            'M√∫sica',
            'Jard√≠n',
            'Juguetes',
            'Libros',
            'Deportes',
            'Herramientas',
            'Otros'
        ];
        
        select.innerHTML = '';
        select.appendChild(new Option('Selecciona una categor√≠a', ''));
        
        defaultCategories.forEach(cat => {
            const option = new Option(cat, cat);
            select.appendChild(option);
        });
        
        select.appendChild(new Option('Otros (Especificar)', 'OTROS'));
        setupCategoryChangeListener();
        
        console.log('Usando categor√≠as por defecto');
    }

    // --- FUNCI√ìN PARA MANEJAR EL CAMPO 'OTROS' ---
    function setupCategoryChangeListener() {
        const categoriaSelect = document.getElementById('categoria');
        const categoriaOtrosWrap = document.getElementById('categoriaOtrosWrap');
        const categoriaOtrosInput = document.getElementById('categoriaOtros');

        categoriaSelect.addEventListener('change', () => {
            if (categoriaSelect.value === 'OTROS') {
                categoriaOtrosWrap.classList.remove('hidden');
                categoriaOtrosInput.setAttribute('required', 'required');
            } else {
                categoriaOtrosWrap.classList.add('hidden');
                categoriaOtrosInput.removeAttribute('required');
                categoriaOtrosInput.value = '';
            }
        });
    }

    // --- INICIALIZACI√ìN ---
    document.addEventListener('DOMContentLoaded', async () => {
        const form = document.getElementById('formPublicar');
        const backBtn = document.getElementById('backBtn');
        const imagenInput = document.getElementById('imagen');
        const preview = document.getElementById('preview');

        // Cargar categor√≠as al iniciar
        await fetchCategories();

        // Vista previa de imagen
        imagenInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                // Validar tipo de archivo
                if (!file.type.startsWith('image/')) {
                    alert('Por favor, selecciona un archivo de imagen v√°lido');
                    imagenInput.value = '';
                    return;
                }
                
                // Validar tama√±o (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('La imagen es demasiado grande. M√°ximo 5MB permitido');
                    imagenInput.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                preview.src = '';
                preview.style.display = 'none';
            }
        });

        // Bot√≥n volver
        backBtn.addEventListener('click', () => {
            if (history.length > 1) {
                history.back();
            } else {
                window.location.href = 'perfil.html';
            }
        });

        // Env√≠o del formulario
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Obtener datos del formulario
            const title = document.getElementById('titulo').value.trim();
            const description = document.getElementById('descripcion').value.trim();
            const price = parseInt(document.getElementById('precio').value);
            const imageFile = document.getElementById('imagen').files[0];
            const categoriaSelectValue = document.getElementById('categoria').value;
            const categoriaOtros = document.getElementById('categoriaOtros').value.trim();

            // Validaciones
            if (!title) {
                alert('El t√≠tulo es obligatorio.');
                return;
            }

            if (!categoriaSelectValue) {
                alert('Por favor selecciona una categor√≠a.');
                return;
            }

            // Determinar categor√≠a final
            let finalCategoryName = categoriaSelectValue === 'OTROS' ? categoriaOtros : categoriaSelectValue;
            
            if (categoriaSelectValue === 'OTROS' && !categoriaOtros) {
                alert('Debes especificar la categor√≠a.');
                return;
            }

            try {
                // Obtener usuario actual
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                if (userError || !user) {
                    alert('Error: No se pudo verificar el usuario. Por favor, inicia sesi√≥n nuevamente.');
                    return;
                }

                let imageUrl = null;

                // Subir imagen si existe
                if (imageFile) {
                    console.log('Subiendo imagen...');
                    
                    // Crear nombre √∫nico para el archivo
                    const fileExt = imageFile.name.split('.').pop();
                    const fileName = `${user.id}_${Date.now()}.${fileExt}`;
                    const filePath = `publicaciones/${fileName}`;

                    // Subir archivo
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('imagenes')
                        .upload(filePath, imageFile);

                    if (uploadError) {
                        console.error('Error al subir imagen:', uploadError);
                        throw new Error('No se pudo subir la imagen: ' + uploadError.message);
                    }

                    // Obtener URL p√∫blica
                    const { data: publicUrlData } = supabase.storage
                        .from('imagenes')
                        .getPublicUrl(filePath);

                    imageUrl = publicUrlData.publicUrl;
                    console.log('Imagen subida:', imageUrl);
                }

                // Insertar publicaci√≥n en la base de datos
                console.log('Insertando publicaci√≥n...');
                const { data: inserted, error: insertError } = await supabase
                    .from('Publicacion')
                    .insert([{
                        titulo: title,
                        descripcion: description,
                        precio: price,
                        nombre_categoria: finalCategoryName,
                        imagen_url: imageUrl,
                        usuario_id: user.id
                    }])
                    .select();

                if (insertError) {
                    console.error('Error al insertar publicaci√≥n:', insertError);
                    throw new Error('No se pudo crear la publicaci√≥n: ' + insertError.message);
                }

                console.log('Publicaci√≥n creada:', inserted);
                alert('‚úÖ ¬°Publicaci√≥n creada exitosamente!');
                
                // Limpiar formulario
                form.reset();
                preview.style.display = 'none';
                document.getElementById('categoriaOtrosWrap').classList.add('hidden');
                
                // Redirigir al perfil despu√©s de 1 segundo
                setTimeout(() => {
                    window.location.href = 'perfil.html';
                }, 1000);

            } catch (error) {
                console.error('Error completo:', error);
                alert(`‚ùå Error: ${error.message}`);
            }
        });
    });
</script>
</body>
</html>