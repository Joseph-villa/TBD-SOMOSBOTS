<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hacer una Publicaci√≥n</title>
    <link rel="stylesheet" href="styles/estilos.css"> 
    <style>
        .hidden { display: none; }
        .field-row { margin-top: 8px; }
        .small-input { width: 100%; box-sizing: border-box; }

        /* Estilo para el bot√≥n "Volver" */
        .back-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            background-color: #2F9A34; /* Verde principal */
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.3s ease, box-shadow 0.2s ease;
        }

        .back-btn:hover {
            background-color: #036d19; /* Verde m√°s oscuro */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .back-btn:active {
            background-color: #025a14; /* Verde a√∫n m√°s oscuro */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Estilo general para el contenedor */
        .publicar-container {
            max-width: 600px;
            margin: 40px auto;
            padding: 24px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #2F9A34;
            font-size: 1.5rem;
            margin-bottom: 16px;
            text-align: center;
        }

        label {
            font-weight: 600;
            color: #333;
        }

        input, textarea, select {
            padding: 12px;
            border: 1px solid #e6e6e6;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        input:focus, textarea:focus, select:focus {
            border-color: #2F9A34;
            box-shadow: 0 0 0 3px rgba(47, 154, 52, 0.2);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn-publicar {
            display: inline-block;
            width: 100%;
            padding: 12px;
            background-color: #2F9A34;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, box-shadow 0.2s ease;
        }

        .btn-publicar:hover {
            background-color: #036d19;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-publicar:active {
            background-color: #025a14;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        img#preview {
            display: none;
            margin-top: 10px;
            max-width: 100%;
            border-radius: 8px;
        }
    </style>
</head>
<body class="publicar-body">

    <div class="publicar-container">
        <button id="backBtn" class="back-btn" style="margin-bottom:12px;">‚Üê Volver</button>
        <h2>üì§ Hacer una Publicaci√≥n</h2>

        <form class="form-publicar" id="formPublicar">
            <label for="titulo">T√≠tulo del bien o servicio</label>
            <input type="text" id="titulo" placeholder="Ej. Laptop Lenovo, Corte de cabello..." required class="small-input">

            <label for="descripcion" class="field-row">Descripci√≥n</label>
            <textarea id="descripcion" placeholder="Agrega una descripci√≥n breve..." class="small-input"></textarea>

            <label for="precio" class="field-row">Precio (en cr√©ditos)</label>
            <input type="number" id="precio" placeholder="Ej. 100" min="0" value="100" class="small-input">

            <div class="field-row">
                <label for="categoria">Categor√≠a</label>
                <select id="categoria" class="small-input"> 
                    <option value="">Cargando categor√≠as...</option>
                </select>
            </div>

            <div id="categoriaOtrosWrap" class="field-row hidden">
                <label for="categoriaOtros">Especificar categor√≠a</label>
                <input type="text" id="categoriaOtros" class="small-input" placeholder="Escribe la categor√≠a">
            </div>

            <label for="imagen" class="field-row">Subir imagen</label>
            <input type="file" id="imagen" accept="image/*">
            <img id="preview" src="" alt="Vista previa" style="display:none; margin-top:10px; max-width:100%; border-radius:8px;">


            <div style="margin-top:12px;">
                <button type="submit" class="btn-publicar">Publicar</button>
            </div>

            <div id="lista-publicaciones"></div>

        </form>
    </div>

<script type="module">

// Ya NO necesitamos importar supabase aqu√≠ para la carga de categor√≠as.
// La importaci√≥n de supabase se mantiene solo para la funci√≥n de SUBMIT,
// para manejar la subida de imagen a Storage y la inserci√≥n final.
import { supabase } from './config/db.js';

let selectedCategoryName = '';

// --- FUNCI√ìN CORREGIDA: Llama al Servidor Express ---
async function fetchCategories() {
    const select = document.getElementById('categoria');
    select.innerHTML = '<option value="">Cargando categor√≠as...</option>'; 

    try {
        // üö® CLAVE: Llama a la ruta API de tu servidor Express
        const response = await fetch('http://localhost:3000/api/categoria');
        
        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
        }
        
        const data = await response.json();

        // Limpiar el select y a√±adir la opci√≥n por defecto
        select.innerHTML = '';
        select.appendChild(new Option('Selecciona una categor√≠a', ''));
        
        // Llenar las opciones con los datos
        data.forEach(cat => {
            // Usamos la ID como valor, ya que tu endpoint de inserci√≥n Express espera `categoria_id`
            const option = new Option(cat.nombre, cat.id_categoria); 
            select.appendChild(option);
        });

        // A√±adir la opci√≥n 'Otros'
        select.appendChild(new Option('Otros (Especificar)', 'OTROS'));

        setupCategoryChangeListener(); 

    } catch (err) {
        console.error('‚ùå Error al cargar categor√≠as desde el servidor (Express):', err);
        select.innerHTML = '<option value="">Error al cargar categor√≠as</option>'; 
    }
}

// --- FUNCI√ìN PARA MANEJAR EL CAMPO 'OTROS' ---
function setupCategoryChangeListener() {
    const categoriaSelect = document.getElementById('categoria');
    const categoriaOtrosWrap = document.getElementById('categoriaOtrosWrap');
    const categoriaOtrosInput = document.getElementById('categoriaOtros');

    categoriaSelect.addEventListener('change', () => {
        if (categoriaSelect.value === 'OTROS') {
            categoriaOtrosWrap.classList.remove('hidden');
            categoriaOtrosInput.setAttribute('required', 'required'); 
        } else if (categoriaSelect.value) {
            // Guardar el texto visible de la opci√≥n seleccionada
selectedCategoryName = categoriaSelect.options[categoriaSelect.selectedIndex].text;        } else {
            selectedCategoryName = '';
        }
    });
}

document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('formPublicar');
    const backBtn = document.getElementById('backBtn');
    const imagenInput = document.getElementById('imagen');
    const preview = document.getElementById('preview');

    // L√≥gica para el bot√≥n 'Volver'
    if (backBtn) {
        backBtn.addEventListener('click', () => {
            if (history.length > 1) {
                history.back();
            } else {
                window.location.href = 'perfil.html';
            }
        });
    }

    // L√≥gica para la vista previa de la imagen
    imagenInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            preview.src = '';
            preview.style.display = 'none';
        }
    });


    // üöÄ Iniciar la carga de categor√≠as
    fetchCategories();

    // ----------------------------------------------------------------------
    // ‚ö†Ô∏è ADVERTENCIA: La l√≥gica de `form.addEventListener('submit')` es compleja
    // porque intenta subir a Storage (Supabase) y luego insertar en la BD (Express API).
    // Si usas Express, DEBER√çAS manejar la subida de imagen tambi√©n en Express
    // (usando Multer o similar) y luego desde ah√≠ llamar a Supabase.
    // MANTENEMOS la l√≥gica actual solo para que funcione la inserci√≥n con los campos correctos.
    // ----------------------------------------------------------------------

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const title = document.getElementById('titulo').value.trim();
        const description = document.getElementById('descripcion').value.trim();
        const price = document.getElementById('precio').value;
        const priceValue = price ? parseFloat(price) : null; 
        const imageFile = document.getElementById('imagen').files[0]; 
        
        const categoriaSelectValue = document.getElementById('categoria').value;
        const categoriaOtros = document.getElementById('categoriaOtros').value.trim();

let finalCategoryValueForDB = selectedCategoryName;

        // 1. Manejo de la categor√≠a
        if (categoriaSelectValue === 'OTROS') {
            if (!categoriaOtros) {
                alert('Debe especificar la nueva categor√≠a.');
                return;
            }
            // üö® ADVERTENCIA: Si usas el endpoint Express, el valor de la ID
            // debe ser un ID v√°lido. Necesitar√≠as insertar la categor√≠a primero 
            // en Supabase para obtener una ID antes de la publicaci√≥n.
            alert('Advertencia: La opci√≥n "Otros" no es compatible con el endpoint API de Express actual. Por favor, selecciona una categor√≠a existente.');
            return;
        } 
        
        if (!title || !finalCategoryValueForDB) { 
            alert('El t√≠tulo y la categor√≠a son obligatorios.'); 
            return; 
        }
        
        // 2. Subir Imagen a Supabase Storage (Se mantiene aqu√≠, no es lo ideal)
        let imageUrl = null;
        
        if (imageFile) {
            const filePath = `publicaciones/${Date.now()}_${imageFile.name}`; 

            // Esta parte utiliza el cliente Supabase directamente en el frontend,
            // lo que requiere que 'supabaseClient.js' est√© correctamente configurado.
            const { error: uploadError } = await supabase.storage
                .from('imagenes') 
                .upload(filePath, imageFile, {
                    cacheControl: '3600',
                    upsert: false 
                });
            
            if (!uploadError) {
                const { data: publicUrlData } = supabase
                    .storage
                    .from('imagenes')
                    .getPublicUrl(filePath); 

                imageUrl = publicUrlData.publicUrl;
            } else {
                console.error("Error al subir imagen:", uploadError);
                alert(`‚ùå ERROR DE IMAGEN: No se pudo subir la imagen. ${uploadError.message}`);
                return;
            }
        }
        
        // 3. Insertar la Publicaci√≥n usando la API de Express
        try {
const userId = localStorage.getItem('auth_id'); // üö® USAR 'auth_id'            if (!userId) {
                if (!userId) {
        alert('Debe iniciar sesi√≥n para publicar.');
        return;
    }
            const apiResponse = await fetch('http://localhost:3000/api/publicar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    titulo: title,
                    descripcion: description,
                    precio: priceValue, ¬† ¬† ¬† 
categoria_nombre: finalCategoryValueForDB, // Nuevo campo en el body    
 usuario_id: userId,                // ID del usuario
                    foto: imageUrl // URL de la imagen
                })
            });
            
            const result = await apiResponse.json();

            if (!apiResponse.ok) {
                console.error('Error del servidor al insertar:', result.error);
                throw new Error(result.error || 'Error desconocido al publicar.');
            }

            alert('‚úÖ ¬°Publicaci√≥n creada exitosamente!');
            form.reset();
            preview.src = '';
            preview.style.display = 'none';
            window.location.href = 'perfil.html';

        } catch (err) {
            console.error('Error al enviar la publicaci√≥n:', err);
            alert(`‚ùå ERROR DE PUBLICACI√ìN: ${err.message}.`);
        }
    });

    // ‚ùå ELIMINAMOS el listener duplicado que estaba al final del archivo.

});

</script>
</body>
</html>