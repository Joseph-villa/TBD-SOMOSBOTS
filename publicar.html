<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hacer una Publicaci√≥n</title>
    <link rel="stylesheet" href="styles/estilos.css"> 
    <style>
        .hidden { display:none; }
        .field-row { margin-top:8px; }
        .small-input { width:100%; box-sizing:border-box; }
        .back-btn {
            background: none;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            color: #007bff;
            font-size: 16px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .back-btn:hover {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body class="publicar-body">

    <div class="publicar-container">
        <button id="backBtn" class="back-btn">‚Üê Volver</button>
        <h2>üì§ Hacer una Publicaci√≥n</h2>

        <form class="form-publicar" id="formPublicar">
            <label for="titulo">T√≠tulo del bien o servicio</label>
            <input type="text" id="titulo" placeholder="Ej. Laptop Lenovo, Corte de cabello..." required class="small-input">

            <label for="descripcion" class="field-row">Descripci√≥n</label>
            <textarea id="descripcion" placeholder="Agrega una descripci√≥n breve..." class="small-input" rows="4"></textarea>

            <label for="precio" class="field-row">Precio (en cr√©ditos)</label>
            <input type="number" id="precio" placeholder="Ej. 100" min="1" value="100" class="small-input">

            <div class="field-row">
                <label for="categoria">Categor√≠a</label>
                <select id="categoria" class="small-input" required>
                    <option value="">Cargando categor√≠as...</option>
                </select>
            </div>

            <div id="categoriaOtrosWrap" class="field-row hidden">
                <label for="categoriaOtros">Especificar categor√≠a</label>
                <input type="text" id="categoriaOtros" class="small-input" placeholder="Escribe la categor√≠a">
            </div>

            <label for="imagen" class="field-row">Subir imagen (opcional)</label>
            <input type="file" id="imagen" accept="image/*">
            <img id="preview" src="" alt="Vista previa" style="display:none; margin-top:10px; max-width:100%; border-radius:8px; max-height: 200px;">

            <div style="margin-top:20px;">
                <button type="submit" class="btn-publicar">Publicar</button>
            </div>
        </form>
    </div>

<script type="module">
    import { supabase } from './config/db.js';

    // --- FUNCI√ìN PARA CARGAR CATEGOR√çAS ---
    async function fetchCategories() {
        const select = document.getElementById('categoria');
        
        try {
            console.log('Cargando categor√≠as...');
            
            // Intentar cargar desde la tabla categoria
            const { data, error } = await supabase
                .from('categoria')
                .select('nombre')
                .order('nombre', { ascending: true });

            if (error) {
                console.error('Error al cargar categor√≠as:', error);
                // Si falla, usar categor√≠as por defecto
                useDefaultCategories();
                return;
            }

            // Limpiar el select
            select.innerHTML = '';
            
            // Opci√≥n por defecto
            select.appendChild(new Option('Selecciona una categor√≠a', ''));
            
            // Llenar con categor√≠as de la base de datos
            if (data && data.length > 0) {
                data.forEach(cat => {
                    const option = new Option(cat.nombre, cat.nombre);
                    select.appendChild(option);
                });
                console.log('Categor√≠as cargadas desde BD:', data);
            } else {
                // Si no hay categor√≠as en la BD, usar las por defecto
                useDefaultCategories();
            }
            
            // A√±adir la opci√≥n 'Otros'
            select.appendChild(new Option('Otros (Especificar)', 'OTROS'));
            
            // Configurar el listener
            setupCategoryChangeListener();

        } catch (err) {
            console.error('Error al cargar categor√≠as:', err);
            useDefaultCategories();
        }
    }

    // Categor√≠as por defecto en caso de error
    function useDefaultCategories() {
        const select = document.getElementById('categoria');
        const defaultCategories = [
            'Electr√≥nica',
            'Hogar',
            'Ropa',
            'M√∫sica',
            'Jard√≠n',
            'Juguetes',
            'Libros',
            'Deportes',
            'Herramientas',
            'Otros'
        ];
        
        select.innerHTML = '';
        select.appendChild(new Option('Selecciona una categor√≠a', ''));
        
        defaultCategories.forEach(cat => {
            const option = new Option(cat, cat);
            select.appendChild(option);
        });
        
        select.appendChild(new Option('Otros (Especificar)', 'OTROS'));
        setupCategoryChangeListener();
        
        console.log('Usando categor√≠as por defecto');
    }

    // --- FUNCI√ìN PARA MANEJAR EL CAMPO 'OTROS' ---
    function setupCategoryChangeListener() {
        const categoriaSelect = document.getElementById('categoria');
        const categoriaOtrosWrap = document.getElementById('categoriaOtrosWrap');
        const categoriaOtrosInput = document.getElementById('categoriaOtros');

        categoriaSelect.addEventListener('change', () => {
            if (categoriaSelect.value === 'OTROS') {
                categoriaOtrosWrap.classList.remove('hidden');
                categoriaOtrosInput.setAttribute('required', 'required');
            } else {
                categoriaOtrosWrap.classList.add('hidden');
                categoriaOtrosInput.removeAttribute('required');
                categoriaOtrosInput.value = '';
            }
        });
    }

    // --- INICIALIZACI√ìN ---
    document.addEventListener('DOMContentLoaded', async () => {
        const form = document.getElementById('formPublicar');
        const backBtn = document.getElementById('backBtn');
        const imagenInput = document.getElementById('imagen');
        const preview = document.getElementById('preview');

        // Cargar categor√≠as al iniciar
        await fetchCategories();

        // Vista previa de imagen
        imagenInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                // Validar tipo de archivo
                if (!file.type.startsWith('image/')) {
                    alert('Por favor, selecciona un archivo de imagen v√°lido');
                    imagenInput.value = '';
                    return;
                }
                
                // Validar tama√±o (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('La imagen es demasiado grande. M√°ximo 5MB permitido');
                    imagenInput.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                preview.src = '';
                preview.style.display = 'none';
            }
        });

        // Bot√≥n volver
        backBtn.addEventListener('click', () => {
            if (history.length > 1) {
                history.back();
            } else {
                window.location.href = 'perfil.html';
            }
        });

        // Env√≠o del formulario
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Obtener datos del formulario
            const title = document.getElementById('titulo').value.trim();
            const description = document.getElementById('descripcion').value.trim();
            const price = parseInt(document.getElementById('precio').value);
            const imageFile = document.getElementById('imagen').files[0];
            const categoriaSelectValue = document.getElementById('categoria').value;
            const categoriaOtros = document.getElementById('categoriaOtros').value.trim();

            // Validaciones
            if (!title) {
                alert('El t√≠tulo es obligatorio.');
                return;
            }

            if (!categoriaSelectValue) {
                alert('Por favor selecciona una categor√≠a.');
                return;
            }

            // Determinar categor√≠a final
            let finalCategoryName = categoriaSelectValue === 'OTROS' ? categoriaOtros : categoriaSelectValue;
            
            if (categoriaSelectValue === 'OTROS' && !categoriaOtros) {
                alert('Debes especificar la categor√≠a.');
                return;
            }

            try {
                // Obtener usuario actual
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                if (userError || !user) {
                    alert('Error: No se pudo verificar el usuario. Por favor, inicia sesi√≥n nuevamente.');
                    return;
                }

                let imageUrl = null;

                // Subir imagen si existe
                if (imageFile) {
                    console.log('Subiendo imagen...');
                    
                    // Crear nombre √∫nico para el archivo
                    const fileExt = imageFile.name.split('.').pop();
                    const fileName = `${user.id}_${Date.now()}.${fileExt}`;
                    const filePath = `publicaciones/${fileName}`;

                    // Subir archivo
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('imagenes')
                        .upload(filePath, imageFile);

                    if (uploadError) {
                        console.error('Error al subir imagen:', uploadError);
                        throw new Error('No se pudo subir la imagen: ' + uploadError.message);
                    }

                    // Obtener URL p√∫blica
                    const { data: publicUrlData } = supabase.storage
                        .from('imagenes')
                        .getPublicUrl(filePath);

                    imageUrl = publicUrlData.publicUrl;
                    console.log('Imagen subida:', imageUrl);
                }

                // Insertar publicaci√≥n en la base de datos
                console.log('Insertando publicaci√≥n...');
                const { data: inserted, error: insertError } = await supabase
                    .from('Publicacion')
                    .insert([{
                        titulo: title,
                        descripcion: description,
                        precio: price,
                        nombre_categoria: finalCategoryName,
                        imagen_url: imageUrl,
                        usuario_id: user.id
                    }])
                    .select();

                if (insertError) {
                    console.error('Error al insertar publicaci√≥n:', insertError);
                    throw new Error('No se pudo crear la publicaci√≥n: ' + insertError.message);
                }

                console.log('Publicaci√≥n creada:', inserted);
                alert('‚úÖ ¬°Publicaci√≥n creada exitosamente!');
                
                // Limpiar formulario
                form.reset();
                preview.style.display = 'none';
                document.getElementById('categoriaOtrosWrap').classList.add('hidden');
                
                // Redirigir al perfil despu√©s de 1 segundo
                setTimeout(() => {
                    window.location.href = 'perfil.html';
                }, 1000);

            } catch (error) {
                console.error('Error completo:', error);
                alert(`‚ùå Error: ${error.message}`);
            }
        });
    });
</script>
</body>
</html>