<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hacer una Publicaci√≥n</title>
    <link rel="stylesheet" href="styles/estilos.css"> 
    <style>
    /* Variables de color */
    :root {
        --verde: #2F9A34;
        --verde-dark: #036d19;
        --verde-light: #e8f5e9;
        --bg: #f6faf6;
        --card: #ffffff;
        --text: #333;
        --muted: #666;
        --border: #e6e6e6;
    }

    /* Base */
    * {
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
        margin: 0;
        padding: 0;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    /* Contenedor principal */
    .publicar-container {
        max-width: 600px;
        margin: 40px auto;
        padding: 32px;
        background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.95));
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.03);
    }

    /* Bot√≥n Volver */
    .back-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 16px;
        background: rgba(47, 154, 52, 0.1);
        color: var(--verde-dark);
        border: 1px solid rgba(47, 154, 52, 0.15);
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        text-decoration: none;
    }

    .back-btn:hover {
        background: rgba(47, 154, 52, 0.15);
        border-color: rgba(47, 154, 52, 0.25);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(47, 154, 52, 0.15);
    }

    .back-btn:active {
        transform: translateY(0);
    }

    /* T√≠tulo */
    h2 {
        color: var(--verde);
        font-size: 1.6rem;
        margin: 0 0 24px 0;
        font-weight: 800;
        text-align: center;
    }

    /* Formulario */
    .form-publicar {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .field-row {
        margin-top: 0;
    }

    /* Etiquetas */
    label {
        display: block;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 8px;
        font-size: 0.95rem;
    }

    /* Inputs y Textareas */
    input[type="text"],
    input[type="number"],
    input[type="file"],
    textarea,
    select {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 1rem;
        font-family: inherit;
        color: var(--text);
        background: var(--card);
        transition: all 0.2s ease;
        outline: none;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    textarea:focus,
    select:focus {
        border-color: var(--verde);
        box-shadow: 0 0 0 3px rgba(47, 154, 52, 0.15);
        background: #fafffe;
    }

    textarea {
        resize: vertical;
        min-height: 100px;
        font-family: inherit;
    }

    select {
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%232F9A34' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        padding-right: 36px;
    }

    /* Preview de imagen */
    #preview {
        display: none;
        margin-top: 12px;
        max-width: 100%;
        max-height: 240px;
        border-radius: 8px;
        border: 2px solid var(--border);
        object-fit: cover;
    }

    /* Wrapper de "Otros" */
    #categoriaOtrosWrap {
        margin-top: 12px;
        padding: 12px;
        background: var(--verde-light);
        border-radius: 8px;
        border-left: 4px solid var(--verde);
    }

    #categoriaOtrosWrap input {
        margin-top: 8px;
    }

    /* Clase hidden */
    .hidden {
        display: none !important;
    }

    /* Bot√≥n Publicar */
    .btn-publicar {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, var(--verde), var(--verde-dark));
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        margin-top: 12px;
        transition: all 0.3s ease;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        box-shadow: 0 4px 12px rgba(47, 154, 52, 0.25);
    }

    .btn-publicar:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(47, 154, 52, 0.35);
    }

    .btn-publicar:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(47, 154, 52, 0.2);
    }

    .btn-publicar:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* Small input (Clase auxiliar) */
    .small-input {
        width: 100%;
        box-sizing: border-box;
    }

    /* Responsive */
    @media (max-width: 640px) {
        .publicar-container {
            margin: 20px;
            padding: 20px;
            border-radius: 10px;
        }

        h2 {
            font-size: 1.4rem;
            margin-bottom: 18px;
        }

        label {
            font-size: 0.9rem;
        }

        input,
        textarea,
        select {
            font-size: 16px; /* Evita zoom en iOS */
        }

        .btn-publicar {
            padding: 12px;
            font-size: 0.95rem;
        }
    }
</style>
</head>
<body class="publicar-body">

    <div class="publicar-container">
        <button id="backBtn" class="back-btn">‚Üê Volver</button>
        <h2>üì§ Hacer una Publicaci√≥n</h2>

        <form class="form-publicar" id="formPublicar">
            <label for="titulo">T√≠tulo del bien o servicio</label>
            <input type="text" id="titulo" placeholder="Ej. Laptop Lenovo, Corte de cabello..." required class="small-input">

            <label for="descripcion" class="field-row">Descripci√≥n</label>
            <textarea id="descripcion" placeholder="Agrega una descripci√≥n breve..." class="small-input" rows="4"></textarea>

            <label for="precio" class="field-row">Precio (en cr√©ditos)</label>
            <input type="number" id="precio" placeholder="Ej. 100" min="1" value="100" class="small-input">

            <div class="field-row">
                <label for="categoria">Categor√≠a</label>
                <select id="categoria" class="small-input" required>
                    <option value="">Cargando categor√≠as...</option>
                </select>
            </div>

            <div id="categoriaOtrosWrap" class="field-row hidden">
                <label for="categoriaOtros">Especificar categor√≠a</label>
                <input type="text" id="categoriaOtros" class="small-input" placeholder="Escribe la categor√≠a">
            </div>

            <label for="imagen" class="field-row">Subir imagen (opcional)</label>
            <input type="file" id="imagen" accept="image/*">
            <img id="preview" src="" alt="Vista previa" style="display:none; margin-top:10px; max-width:100%; border-radius:8px; max-height: 200px;">

            <div style="margin-top:20px;">
                <button type="submit" class="btn-publicar">Publicar</button>
            </div>

            <label>Tipo de Oferta:</label>
    <div class="form-check">
        <input class="form-check-input" type="radio" name="tipoOferta" id="tipoIntercambio" value="intercambio" checked>
        <label class="form-check-label" for="tipoIntercambio">
            Intercambio (Cr√©ditos por Bien/Servicio)
        </label>
    </div>
    <div class="form-check">
        <input class="form-check-input" type="radio" name="tipoOferta" id="tipoMonetizacion" value="monetizacion">
        <label class="form-check-label" for="tipoMonetizacion">
            Monetizaci√≥n (Solo para Emprendedores)
        </label>
    </div>
</div>

<button type="submit" onclick="enviarPublicacion(event)">Publicar</button>

        </form>
    </div>

<script type="module">
    import { supabase } from './config/db.js';

    // Variable global para almacenar categor√≠as
    window.categoriasData = [];

    // --- FUNCI√ìN PARA CARGAR CATEGOR√çAS CORREGIDA ---
    async function fetchCategories() {
        const select = document.getElementById('categoria');
        
        try {
            console.log('üîÑ Cargando categor√≠as desde la base de datos...');
            
            // Cargar categor√≠as con ID y nombre
            const { data: categorias, error } = await supabase
                .from('categoria')
                .select('id_categoria, nombre, descripcion')
                .order('nombre', { ascending: true });

            if (error) {
                console.error('‚ùå Error al cargar categor√≠as:', error);
                useDefaultCategories();
                return;
            }

            console.log('‚úÖ Categor√≠as cargadas:', categorias);

            // Limpiar el select
            select.innerHTML = '';
            select.appendChild(new Option('Selecciona una categor√≠a', ''));
            
            if (categorias && categorias.length > 0) {
                // Guardar categor√≠as en variable global para usar despu√©s
                window.categoriasData = categorias;
                
                categorias.forEach(cat => {
                    // Guardar ID como valor, mostrar nombre
                    const option = new Option(cat.nombre, cat.id_categoria);
                    select.appendChild(option);
                });
                console.log(`üìä ${categorias.length} categor√≠as cargadas desde BD`);
            } else {
                useDefaultCategories();
                return;
            }
            
            // A√±adir la opci√≥n 'Otros'
            select.appendChild(new Option('Otros (Especificar)', 'OTROS'));
            setupCategoryChangeListener();

        } catch (err) {
            console.error('üí• Error al cargar categor√≠as:', err);
            useDefaultCategories();
        }
    }

    // --- FUNCI√ìN PARA CATEGOR√çAS POR DEFECTO ---
    function useDefaultCategories() {
        const select = document.getElementById('categoria');
        
        // Para categor√≠as por defecto, usaremos nombres como valores
        const defaultCategories = [
            'Electr√≥nica',
            'Hogar',
            'Ropa', 
            'M√∫sica',
            'Jard√≠n',
            'Juguetes',
            'Libros',
            'Deportes',
            'Herramientas'
        ];
        
        select.innerHTML = '';
        select.appendChild(new Option('Selecciona una categor√≠a', ''));
        
        defaultCategories.forEach(cat => {
            const option = new Option(cat, cat); // Usar nombre como valor
            select.appendChild(option);
        });
        
        select.appendChild(new Option('Otros (Especificar)', 'OTROS'));
        setupCategoryChangeListener();
        
        console.log('üìã Usando categor√≠as por defecto (sin IDs reales)');
    }

    // --- FUNCI√ìN PARA CONFIGURAR EL CAMPO "OTROS" ---
    function setupCategoryChangeListener() {
        const categoriaSelect = document.getElementById('categoria');
        const categoriaOtrosWrap = document.getElementById('categoriaOtrosWrap');
        const categoriaOtrosInput = document.getElementById('categoriaOtros');

        if (!categoriaSelect || !categoriaOtrosWrap || !categoriaOtrosInput) {
            console.error('‚ùå Elementos del formulario no encontrados');
            return;
        }

        categoriaSelect.addEventListener('change', () => {
            if (categoriaSelect.value === 'OTROS') {
                categoriaOtrosWrap.classList.remove('hidden');
                categoriaOtrosInput.setAttribute('required', 'required');
                categoriaOtrosInput.focus();
            } else {
                categoriaOtrosWrap.classList.add('hidden');
                categoriaOtrosInput.removeAttribute('required');
                categoriaOtrosInput.value = '';
            }
        });

        console.log('‚úÖ Listener de categor√≠as configurado');
    }

    // --- FUNCIONES DE BONIFICACI√ìN POR PRIMERA PUBLICACI√ìN ---
    async function verificarPrimeraPublicacion(userId) {
        try {
            console.log('üîç Verificando si es primera publicaci√≥n del usuario:', userId);
            
            // Contar publicaciones existentes del usuario
            const { data: publicaciones, error } = await supabase
                .from('Publicacion')
                .select('id_publicacion')
                .eq('usuario_id', userId);

            if (error) {
                console.error('Error al verificar publicaciones:', error);
                return false;
            }

            const esPrimeraPublicacion = !publicaciones || publicaciones.length === 0;
            console.log('üìä Es primera publicaci√≥n:', esPrimeraPublicacion);
            
            return esPrimeraPublicacion;
        } catch (error) {
            console.error('Error en verificaci√≥n de primera publicaci√≥n:', error);
            return false;
        }
    }

    async function obtenerOcrearBilletera(userId) {
    try {
        console.log('üí∞ Buscando billetera para usuario:', userId);
        
        // Primero, verificar si el usuario YA TIENE una billetera
        const { data: billeteraExistente, error: billeteraError } = await supabase
            .from('billetera')
            .select('id_billetera, credito_actual, credito_retenido') // üóëÔ∏è QUITAR credito_total
            .eq('usuario_id', userId)
            .maybeSingle();

        if (billeteraError) {
            console.error('‚ùå Error al buscar billetera:', billeteraError);
        }

        // Si encontramos una billetera existente, la retornamos
        if (billeteraExistente) {
            console.log('‚úÖ Billetera encontrada:', billeteraExistente);
            return billeteraExistente;
        }

        // Si no existe, crear una nueva
        console.log('üÜï Creando nueva billetera para usuario...');
        const { data: nuevaBilletera, error: crearError } = await supabase
            .from('billetera')
            .insert([{
                usuario_id: userId,
                credito_actual: 0,        // üóëÔ∏è QUITAR credito_total
                credito_retenido: 0,
                ultima_actualizacion: new Date()
            }])
            .select()
            .single();

        if (crearError) {
            console.error('‚ùå Error al crear billetera:', crearError);
            
            // Si es error de duplicado, intentar buscar nuevamente
            if (crearError.code === '23505') {
                console.log('üîÑ Intentando recuperar billetera existente despu√©s de error de duplicado...');
                const { data: billeteraRecuperada, error: errorRecuperar } = await supabase
                    .from('billetera')
                    .select('id_billetera, credito_actual, credito_retenido') // üóëÔ∏è QUITAR credito_total
                    .eq('usuario_id', userId)
                    .single();
                
                if (errorRecuperar) {
                    throw crearError; // Lanzar el error original
                }
                
                console.log('‚úÖ Billetera recuperada despu√©s de error:', billeteraRecuperada);
                return billeteraRecuperada;
            }
            
            throw crearError;
        }

        console.log('‚úÖ Billetera creada:', nuevaBilletera);
        return nuevaBilletera;

    } catch (error) {
        console.error('‚ùå Error en obtenerOcrearBilletera:', error);
        throw error;
    }
}

    // --- INICIALIZACI√ìN ---
    document.addEventListener('DOMContentLoaded', async () => {
        const form = document.getElementById('formPublicar');
        const backBtn = document.getElementById('backBtn');
        const imagenInput = document.getElementById('imagen');
        const preview = document.getElementById('preview');

        // Bot√≥n volver
        backBtn.addEventListener('click', () => {
            if (history.length > 1) {
                history.back();
            } else {
                window.location.href = 'perfil.html';
            }
        });

        // Cargar categor√≠as al iniciar
        await fetchCategories();

        // Vista previa de imagen
        imagenInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                // Validar tipo de archivo
                if (!file.type.startsWith('image/')) {
                    alert('Por favor, selecciona un archivo de imagen v√°lido');
                    imagenInput.value = '';
                    return;
                }
                
                // Validar tama√±o (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('La imagen es demasiado grande. M√°ximo 5MB permitido');
                    imagenInput.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                preview.src = '';
                preview.style.display = 'none';
            }
        });

        // Env√≠o del formulario CORREGIDO SEG√öN TU SCHEMA
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Obtener datos del formulario
            const title = document.getElementById('titulo').value.trim();
            const description = document.getElementById('descripcion').value.trim();
            const price = parseInt(document.getElementById('precio').value);
            const imageFile = document.getElementById('imagen').files[0];
            const categoriaSelectValue = document.getElementById('categoria').value;
            const categoriaOtros = document.getElementById('categoriaOtros').value.trim();

            // Validaciones
            if (!title) {
                alert('El t√≠tulo es obligatorio.');
                return;
            }

            if (!categoriaSelectValue) {
                alert('Por favor selecciona una categor√≠a.');
                return;
            }

            // DETERMINAR CATEGOR√çA_ID CORRECTAMENTE
            let categoriaId = null;
            let nombreCategoriaPersonalizada = null;

            if (categoriaSelectValue === 'OTROS') {
                // Para "Otros", no tenemos ID, usar null y guardar el nombre
                categoriaId = null;
                nombreCategoriaPersonalizada = categoriaOtros;
                
                if (!categoriaOtros) {
                    alert('Debes especificar la categor√≠a.');
                    return;
                }
            } else {
                // Para categor√≠as normales, usar el ID de la categor√≠a seleccionada
                categoriaId = parseInt(categoriaSelectValue);
                nombreCategoriaPersonalizada = null;
            }

            try {
                // Obtener usuario actual
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                if (userError || !user) {
                    alert('Error: No se pudo verificar el usuario. Por favor, inicia sesi√≥n nuevamente.');
                    return;
                }

                // CREAR BILLETERA PRIMERO (para evitar el error del trigger)
                console.log('üí∞ Creando/Asegurando billetera primero...');
                const billetera = await obtenerOcrearBilletera(user.id);
                console.log('‚úÖ Billetera asegurada:', billetera);

                let imageUrl = null;

                // Subir imagen si existe
                if (imageFile) {
                    console.log('Subiendo imagen...');
                    
                    // Crear nombre √∫nico para el archivo
                    const fileExt = imageFile.name.split('.').pop();
                    const fileName = `${user.id}_${Date.now()}.${fileExt}`;
                    const filePath = `publicaciones/${fileName}`;

                    // Subir archivo
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('imagenes')
                        .upload(filePath, imageFile);

                    if (uploadError) {
                        console.error('Error al subir imagen:', uploadError);
                        throw new Error('No se pudo subir la imagen: ' + uploadError.message);
                    }

                    // Obtener URL p√∫blica
                    const { data: publicUrlData } = supabase.storage
                        .from('imagenes')
                        .getPublicUrl(filePath);

                    imageUrl = publicUrlData.publicUrl;
                    console.log('Imagen subida:', imageUrl);
                }

                // Antes de insertar la publicaci√≥n: determinar nombre de categor√≠a para c√°lculo
                let nombreCategoriaParaCalculo = null;
                if (categoriaSelectValue === 'OTROS') {
                    nombreCategoriaParaCalculo = categoriaOtros || 'Otros';
                } else {
                    const catObj = window.categoriasData.find(c => String(c.id_categoria) === String(categoriaSelectValue));
                    nombreCategoriaParaCalculo = catObj ? (catObj.nombre || categoriaSelectValue) : categoriaSelectValue;
                }

                // Calcular ahorros (cantidad = 1 por defecto; puedes a√±adir campo cantidad si quieres)
                const ahorros = calcularAhorrosPorCategoria(nombreCategoriaParaCalculo, 1);

                // Insertar publicaci√≥n en la base de datos CORREGIDO (agregar campos de ahorro)
                console.log('üìù Insertando publicaci√≥n con ahorros...', ahorros);
                const { data: inserted, error: insertError } = await supabase
                    .from('Publicacion')
                    .insert([{
                        titulo: title,
                        descripcion: description,
                        precio: price,
                        categoria_id: categoriaId,
                        nombre_categoria: nombreCategoriaPersonalizada || nombreCategoriaParaCalculo,
                        imagen_url: imageUrl,
                        usuario_id: user.id,
                        estado: 'activo',
                        fecha_publicacion: new Date().toISOString(),
                        fecha_actualizacion: new Date().toISOString(),
                        ahorro_co2: ahorros.co2,
                        ahorro_agua: ahorros.agua,
                        ahorro_energia: ahorros.energia
                    }])
                    .select();

                if (insertError) {
                    console.error('Error al insertar publicaci√≥n:', insertError);
                    throw new Error('No se pudo crear la publicaci√≥n: ' + insertError.message);
                }

                const publicacionId = inserted[0].id_publicacion;
                console.log('‚úÖ Publicaci√≥n creada con ID:', publicacionId);

                // REGISTRO MANUAL DE BONIFICACI√ìN SEG√öN TU SCHEMA
                const esPrimeraPublicacion = await verificarPrimeraPublicacion(user.id);

                if (esPrimeraPublicacion) {
                    console.log('üéâ ¬°Primera publicaci√≥n detectada! Otorgando 10 cr√©ditos...');
                    
                    try {
                        // 1. Obtener datos actualizados del usuario
                        const { data: usuarioActual, error: usuarioError } = await supabase
                            .from('usuario')
                            .select('saldo_creditos, nombre_completo')
                            .eq('auth_id', user.id)
                            .single();

                        if (usuarioError) throw usuarioError;

                        const saldoActual = usuarioActual.saldo_creditos || 0;
                        const nuevoSaldo = saldoActual + 10;

                        console.log('üí∞ Actualizando saldo:', saldoActual, '‚Üí', nuevoSaldo);

                        // 2. Actualizar saldo en usuario
                        const { error: updateError } = await supabase
                            .from('usuario')
                            .update({ 
                                saldo_creditos: nuevoSaldo 
                            })
                            .eq('auth_id', user.id);

                        if (updateError) throw updateError;

                        // 3. Actualizar billetera - SEG√öN TU SCHEMA
                        const { data: billeteraActual, error: billeteraError } = await supabase
                            .from('billetera')
                            .select('id_billetera, credito_actual')
                            .eq('usuario_id', user.id)
                            .single();

                        if (!billeteraError && billeteraActual) {                           
                            const nuevoCreditoActual = (billeteraActual.credito_actual || 0) + 10;

                            const { error: billeteraUpdateError } = await supabase
                                .from('billetera')
                                .update({
                                    credito_actual: nuevoCreditoActual,
                                    ultima_actualizacion: new Date()
                                })
                                .eq('id_billetera', billeteraActual.id_billetera);  // CORREGIDO

                            if (billeteraUpdateError) {
                                console.warn('‚ö†Ô∏è No se pudo actualizar billetera:', billeteraUpdateError);
                            }

                            // 4. Registrar movimiento de cr√©dito - SOLO si tenemos billetera_id
                            const { error: movimientoError } = await supabase
                                .from('Movimiento_Credito')
                                .insert([{
                                    tipo_movimiento: 'bonificaci√≥n',
                                    monto: 10,
                                    origen: 'primera_publicacion',
                                    fecha_mov: new Date(),
                                    descripcion: 'Bonificaci√≥n por primera publicaci√≥n',
                                    billetera_id: billeteraActual.id_billetera  // id_billetera existe
                                }]);

                            if (movimientoError) {
                                console.warn('‚ö†Ô∏è No se pudo registrar movimiento de cr√©dito:', movimientoError);
                            }
                        }

                        // 5. REGISTRAR EN BITACORA_USUARIO - SEG√öN TU SCHEMA
                        const { error: bitacoraError } = await supabase
                            .from('bitacora_usuario')
                            .insert([{
                                accion_realizada: 'bonificacion_primera_publicacion',
                                fecha_accion: new Date(),
                                detalle: `Bonificaci√≥n de 10 cr√©ditos por primera publicaci√≥n (ID: ${publicacionId})`,
                                usuario_id: user.id  // usuario_id UUID correcto
                            }]);

                        if (bitacoraError) {
                            console.warn('‚ö†Ô∏è No se pudo registrar en bit√°cora:', bitacoraError);
                        } else {
                            console.log('‚úÖ Registrado en bitacora_usuario');
                        }

                        // 6. REGISTRAR EN HISTORIAL - SEG√öN TU SCHEMA
                        const { error: historialError } = await supabase
                            .from('historial')
                            .insert([{
                                fecha: new Date(),
                                tipo: 'bonificaci√≥n',
                                total: 10,
                                auth_id: user.id  // auth_id UUID correcto
                            }]);

                        if (historialError) {
                            console.warn('‚ö†Ô∏è No se pudo registrar en historial:', historialError);
                        } else {
                            console.log('‚úÖ Registrado en historial');
                        }

                        // 7. Mostrar mensaje de √©xito
                        alert(`‚úÖ ¬°Publicaci√≥n creada exitosamente!\n\nüéÅ ¬°Felicidades! Por ser tu primera publicaci√≥n, has recibido 10 cr√©ditos de bonificaci√≥n.\n\nTu saldo actual: ${nuevoSaldo} cr√©ditos ‚ôªÔ∏è`);
                        
                        // Actualizar localStorage
                        localStorage.setItem('user_saldo', nuevoSaldo.toString());

                    } catch (bonusError) {
                        console.error('‚ùå Error en bonificaci√≥n:', bonusError);
                        alert('‚úÖ ¬°Publicaci√≥n creada exitosamente!\n\n‚ö†Ô∏è Hubo un problema con la bonificaci√≥n, pero tu publicaci√≥n se cre√≥ correctamente.');
                    }
                } else {
                    alert('‚úÖ ¬°Publicaci√≥n creada exitosamente!');
                }

                // Limpiar formulario
                form.reset();
                preview.style.display = 'none';
                document.getElementById('categoriaOtrosWrap').classList.add('hidden');
                
                // Redirigir al perfil despu√©s de 2 segundos
                setTimeout(() => {
                    window.location.href = 'perfil.html';
                }, 2000);

            } catch (error) {
                console.error('Error completo:', error);
                alert(`‚ùå Error: ${error.message}`);
            }
        });
    });

    // --- MAPA / FUNCI√ìN PARA CALCULAR AHORROS POR CATEGOR√çA ---
    // funci√≥n para calcular ahorros (mis mismos valores de ejemplo)
    function calcularAhorrosPorCategoria(nombreCategoria, cantidad = 1) {
        if (!nombreCategoria) nombreCategoria = 'otros';
        const key = nombreCategoria.toString().toLowerCase();

        const MAP = {
            deportes:    { co2: 0.05,  agua: 0.2,  energia: 0.02 },  // actividades deportivas: bajo impacto
            electronicos:{ co2: 2.5,   agua: 1.0,  energia: 3.5 },   // productos electr√≥nicos: alto impacto
            herramientas:{ co2: 0.9,   agua: 0.5,  energia: 0.6 },   // herramientas: medio
            hogar:       { co2: 0.7,   agua: 3.0,  energia: 0.8 },   // art√≠culos del hogar
            juguetes:    { co2: 0.25,  agua: 1.0,  energia: 0.15 },  // juguetes
            libros:      { co2: 0.1,   agua: 0.2,  energia: 0.05 },  // libros: muy bajo
            otros:       { co2: 0.15,  agua: 0.5,  energia: 0.1 }    // fallback para otras categor√≠as
        };

        // buscar coincidencia exacta/contiene
        for (const k in MAP) {
            if (key.includes(k)) {
                return {
                    co2: +(MAP[k].co2 * cantidad).toFixed(2),
                    agua: +(MAP[k].agua * cantidad).toFixed(2),
                    energia: +(MAP[k].energia * cantidad).toFixed(2)
                };
            }
        }

        const d = MAP.otros;
        return {
            co2: +(d.co2 * cantidad).toFixed(2),
            agua: +(d.agua * cantidad).toFixed(2),
            energia: +(d.energia * cantidad).toFixed(2)
        };
    }
</script>
</body>
</html>
