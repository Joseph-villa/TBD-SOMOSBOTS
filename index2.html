<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Reciclaje - Principal</title>
    <link rel="stylesheet" href="styles/estilos.css">

    <style>
        /* [ESTILOS DE PERFIL/MENU] */
        /* Asegura que el men√∫ est√© oculto por defecto */
        .profile-links { display: none; }
        .profile-open .profile-links { display: block; }
        .user-area { cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; background: transparent; border: none; padding: 0; font: inherit; color: inherit; }
        .user-area:focus { outline: 2px solid #6ca; outline-offset: 2px; }
        .sidebar .profile-links { margin: 0 0 1rem 0; padding: 0; list-style: none; }
        .sidebar .profile-links li { margin: 0.25rem 0; }
        
        /* [ESTILOS PARA LA CABECERA] */
        .topbar .right-area {
            display: flex; /* Asegura que los elementos est√©n en fila */
            align-items: center;
            gap: 15px; /* Espacio entre los nuevos botones */
        }

        .topbar-btn {
            background-color: #555;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none; /* Para el enlace de Publicar */
            transition: background-color 0.2s;
            font-size: 0.9em;
        }

        .topbar-btn:hover {
            background-color: #444;
        }

        /* [ESTILOS DEL MODAL] */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        #adminCode {
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
            font-size: 1.2em;
        }

        /* [ESTILOS DE CR√âDITOS COMO ENLACE] */
        .credits-link {
            text-decoration: none;
            color: inherit;
            display: inline-block;
            cursor: pointer;
        }

        .credits-link:hover .credits-bubble {
            background-color: #5bb34a; 
            transition: background-color 0.2s;
        }

        .credits-bubble {
            background-color: #4CAF50;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* [ESTILOS PARA EL GRID DE PRODUCTOS] */
        .layout { display: flex; align-items: flex-start; gap: 1rem; }
        .content { order: 1; flex: 1; min-width: 0; padding-left: 20px; } 
        .sidebar { order: 2; width: 240px; } 

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
            gap: 20px;
            padding: 20px 0;
        }

        .product-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            text-align: center;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .product-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .credits {
            background-color: #4CAF50; 
            color: white;
            padding: 5px 10px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .categories { list-style: none; padding: 0; }
        .categories li { padding: 8px 0; border-bottom: 1px solid #eee; cursor: pointer; }
        .categories li:hover { background-color: #f0f0f0; }

        #btn-comprar {
            background-color: #FF5722; 
            color: white;
            border: none;
            padding: 10px 15px;
            margin-bottom: 10px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 4px;
        }

        /* Responsive */
        @media (max-width: 800px) {
            .layout { flex-direction: column; }
            .content { order: 0; padding-left: 0; }
            .sidebar { order: 1; width: 100%; }
        }
    </style>
</head>
<body>
    <header class="topbar">
        <div class="logo-area">
            <img src="https://i.imgur.com/zQ0kV9R.png" alt="Logo Plataforma" class="logo-img">
            <h1>Plataforma de Trueque Digital</h1>
        </div>

        <div class="search-area">
            <input type="search" class="search-bar" placeholder="Buscar producto..." aria-label="Buscar producto">
        </div>

        <div class="right-area">
            
            <a href="/publicar.html" class="topbar-btn" title="Publicar un art√≠culo">
                ‚ûï Publicar
            </a>
            
            <button id="adminBtn" class="topbar-btn" title="Acceso de Administrador">
                üëë Admin
            </button>

            <a href="/compra.html" class="credits-link" title="Ir a la p√°gina de compra de cr√©ditos">
                <div class="credits-bubble">
                    <span class="coin">‚ôªÔ∏è</span>
                    <span id="topCredits">300</span>
                </div>
            </a>

            <a href="/perfil.html" class="user-area" id="profileToggle" title="Abrir men√∫ de perfil">
                <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Usuario" class="user-icon">
            </a>
        </div>
    </header>

    <div id="adminModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>Acceso de Administrador</h2>
            <p>Ingresa el c√≥digo de seguridad (6 d√≠gitos).</p>
            <form id="adminForm">
                <input type="text" id="adminCode" maxlength="6" inputmode="numeric" required placeholder="000000" pattern="[0-9]{6}">
                <button type="submit">Ingresar</button>
            </form>
            <p id="adminError" style="color: red; margin-top: 10px;"></p>
        </div>
    </div>

    <main class="layout">
        <!-- Contenedor para las publicaciones -->
        <div class="publicaciones-container">
            <h2>Publicaciones Disponibles</h2>
            <div class="grid publicaciones-grid" id="allPostsGrid">
                <!-- JS insertar√° las tarjetas aqu√≠ -->
            </div>
        </div>
    </main>

    <script>
        // Esperar a que el DOM est√© listo antes de buscar elementos
        document.addEventListener('DOMContentLoaded', function () {
            console.log('[DEBUG] DOM cargado ‚Äî inicializando UI.');

            const profileToggle = document.getElementById('profileToggle');
            const profileLinks = document.getElementById('profileLinks');

            const adminBtn = document.getElementById('adminBtn');
            const adminModal = document.getElementById('adminModal');
            const adminForm = document.getElementById('adminForm');
            const adminCodeInput = document.getElementById('adminCode');
            const adminError = document.getElementById('adminError');

            console.log('profileToggle:', !!profileToggle, 'profileLinks:', !!profileLinks);
            console.log('adminBtn:', !!adminBtn, 'adminModal:', !!adminModal, 'adminForm:', !!adminForm, 'adminCodeInput:', !!adminCodeInput);

            const SECRET_CODE = '123456';

            // Perfil toggle (igual que antes)
            if (profileToggle && profileLinks) {
                profileToggle.addEventListener('click', function (e) {
                    e.preventDefault();
                    profileLinks.style.display = profileLinks.style.display === 'block' ? 'none' : 'block';
                });
            }

            // Admin: abrir modal
            if (adminBtn && adminModal) {
                adminBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    adminModal.style.display = 'flex';
                    if (adminCodeInput) {
                        adminCodeInput.value = '';
                        adminCodeInput.focus();
                    }
                    if (adminError) adminError.textContent = '';
                    console.log('[DEBUG] admin modal abierto');
                });
            } else {
                console.warn('[WARN] adminBtn o adminModal no encontrados en DOM');
            }

            // Cerrar modal si se hace click fuera
            if (adminModal) {
                adminModal.addEventListener('click', function (e) {
                    if (e.target === adminModal) {
                        adminModal.style.display = 'none';
                    }
                });
            }

            // Manejo del submit del formulario de admin
            if (adminForm && adminCodeInput && adminError) {
                adminForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const code = adminCodeInput.value.trim();
                    if (code.length !== 6 || !/^\d{6}$/.test(code)) {
                        adminError.textContent = 'Debes ingresar exactamente 6 d√≠gitos.';
                        adminCodeInput.focus();
                        return;
                    }
                    if (code === SECRET_CODE) {
                        adminModal.style.display = 'none';
                        window.location.href = 'admin.html';
                    } else {
                        adminError.textContent = 'C√≥digo incorrecto. Intenta de nuevo.';
                        adminCodeInput.value = '';
                        adminCodeInput.focus();
                    }
                });
            } else {
                console.warn('[WARN] adminForm/adminCodeInput/adminError faltan ‚Äî el formulario no funcionar√°');
            }

            // Cerrar men√∫ de perfil si clic fuera
            document.addEventListener('click', function (e) {
                if (profileLinks && profileLinks.style.display === 'block' &&
                    !profileLinks.contains(e.target) && profileToggle && !profileToggle.contains(e.target)) {
                    profileLinks.style.display = 'none';
                }
            });

            // ESC cierra modal y men√∫
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    if (profileLinks) profileLinks.style.display = 'none';
                    if (adminModal) adminModal.style.display = 'none';
                }
            });

            // Funci√≥n de depuraci√≥n disponible en consola para forzar apertura
            window.__debugOpenAdmin = function () {
                if (adminModal) {
                    adminModal.style.display = 'flex';
                    adminCodeInput && adminCodeInput.focus();
                    console.log('[DEBUG] admin modal forzado a abrir');
                } else {
                    console.warn('[DEBUG] adminModal no encontrado');
                }
            };
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="db.js"></script>
    <script type="module" src="scripts/main.js"></script>

    <script type="module">
        import { supabase } from './config/db.js';

        const allPostsGrid = document.getElementById('allPostsGrid');

        // Renderizar todas las publicaciones
        function renderAllPublications(posts) {
            allPostsGrid.innerHTML = '';
            if (posts.length === 0) {
                allPostsGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px;">No hay publicaciones disponibles.</div>';
            } else {
                posts.forEach(p => {
                    const card = document.createElement('div');
                    card.className = 'pub-card';
                    card.dataset.id = p.id_publicacion;
                    card.innerHTML = `
                        ${p.imagen_url ? `<img src="${p.imagen_url}" alt="${p.titulo || 'Publicaci√≥n'}" />` : '<div style="width:100%; height:150px; background:#e0e0e0; display:flex; align-items:center; justify-content:center;">Sin imagen</div>'}
                        
                        <div style="padding: 12px;">
                            <strong style="display: block; font-size: 1.1rem; color: #333; margin-bottom: 8px;">${p.titulo || 'Sin t√≠tulo'}</strong>
                            
                            <p style="font-size: 0.9rem; color: #666; margin: 0 0 8px 0;">Descripci√≥n: ${p.descripcion || 'Sin descripci√≥n'}</p>
                            
                            <div class="pub-credit" style="display: inline-block; padding: 4px 8px; background-color: #e8f5e9; color: #2F9A34; font-weight: bold; border-radius: 6px; font-size: 0.9rem;">
                                ${p.precio || 0} ‚ôªÔ∏è
                            </div>

                            <p style="font-size: 0.8rem; color: #999; margin-top: 8px;">Por: ${p.usuario_nombre || 'Usuario'}</p>

                            <button class="btn-intercambiar" data-id="${p.id_publicacion}" data-precio="${p.precio || 0}" style="width: 100%; margin-top: 8px; padding: 8px; background-color: #2F9A34; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                Intercambiar
                            </button>
                        </div>
                    `;
                    allPostsGrid.appendChild(card);
                });
            }
        }

        // üö® NUEVA FUNCI√ìN: Cargar TODAS las publicaciones de todos los usuarios
        async function fetchAllPublications() {
            allPostsGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px;">Cargando publicaciones...</div>';
            try {
                const { data: posts, error } = await supabase
                    .from('Publicacion')
                    .select(`
                        id_publicacion, 
                        titulo, 
                        descripcion, 
                        precio, 
                        imagen_url,
                        usuario_id,
                        usuario(nombre_completo)
                    `)
                    .order('id_publicacion', { ascending: false });

                if (error) {
                    console.error('Error de Supabase:', error.message);
                    throw error;
                }

                // Mapear los datos para que sea m√°s f√°cil acceder al nombre del usuario
                const postsFormateadas = (posts || []).map(p => ({
                    ...p,
                    usuario_nombre: p.usuario?.nombre_completo || 'Usuario Desconocido'
                }));

                renderAllPublications(postsFormateadas);

            } catch (err) {
                console.error('Error al cargar publicaciones:', err);
                allPostsGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: red;">Error al cargar las publicaciones. Revisa la consola.</div>';
            }
        }

        // üö® NUEVA FUNCI√ìN: Procesar intercambio
        async function procesarIntercambio(publicacionId, precio) {
            const userId = localStorage.getItem('auth_id');
            
            if (!userId) {
                alert('Debes iniciar sesi√≥n para hacer intercambios.');
                window.location.href = 'index2.html';
                return;
            }

            try {
                // 1. Obtener saldo actual del usuario
                const { data: userData, error: fetchError } = await supabase
                    .from('usuario')
                    .select('saldo_creditos')
                    .eq('auth_id', userId)
                    .single();

                if (fetchError) throw fetchError;

                const saldoActual = userData.saldo_creditos || 0;

                // 2. Verificar si tiene suficientes cr√©ditos
                if (saldoActual < precio) {
                    alert(`‚ùå No tienes suficientes cr√©ditos. Necesitas ${precio} ‚ôªÔ∏è pero solo tienes ${saldoActual} ‚ôªÔ∏è`);
                    return;
                }

                // 3. Restar cr√©ditos
                const nuevoSaldo = saldoActual - precio;

                const { error: updateError } = await supabase
                    .from('usuario')
                    .update({ saldo_creditos: nuevoSaldo })
                    .eq('auth_id', userId);

                if (updateError) throw updateError;

                // 4. Guardar en localStorage
                localStorage.setItem('saldo', nuevoSaldo);

                // 5. Crear registro de transacci√≥n (opcional, pero recomendado)
                const { error: transError } = await supabase
                    .from('transacciones') // Si tienes esta tabla
                    .insert([{
                        usuario_id: userId,
                        publicacion_id: publicacionId,
                        tipo: 'intercambio',
                        cantidad: precio,
                        fecha: new Date().toISOString()
                    }]).then(() => ({ error: null })).catch(err => ({ error: err }));

                alert(`‚úÖ ¬°Intercambio completado! Saldo restante: ${nuevoSaldo} ‚ôªÔ∏è`);

                // 6. Recargar publicaciones
                fetchAllPublications();

            } catch (err) {
                console.error('Error al procesar intercambio:', err);
                alert('Error al procesar el intercambio. Intenta de nuevo.');
            }
        }

        // Event listener para botones de intercambio
        allPostsGrid.addEventListener('click', function(event) {
            if (event.target.classList.contains('btn-intercambiar')) {
                const publicacionId = event.target.dataset.id;
                const precio = parseInt(event.target.dataset.precio) || 0;

                if (confirm(`¬øDeseas intercambiar por ${precio} ‚ôªÔ∏è?`)) {
                    procesarIntercambio(publicacionId, precio);
                }
            }
        });

        // Cargar publicaciones al abrir la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            fetchAllPublications();
        });

        // Refrescar publicaciones cada 5 segundos
        setInterval(() => {
            fetchAllPublications();
        }, 5000);
    </script>
</body>
</html>