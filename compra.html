<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consigue Cr√©ditos Verdes</title>
  <link rel="stylesheet" href="styles/estilos.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <style>
    /* Estilos adicionales para la p√°gina de compra */
    .compra-container {
      max-width: 800px;
      margin: 40px auto;
      padding: 0 20px;
    }

    .compra-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.08);
      margin-bottom: 25px;
    }

    .user-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--muted);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .username {
      font-weight: 600;
      font-size: 1.3rem;
      color: #333;
    }

    .balance-info {
      display: flex;
      align-items: center;
      background: var(--soft-green-bg);
      padding: 8px 16px;
      border-radius: 25px;
      font-size: 1rem;
      font-weight: 600;
      color: var(--accent);
    }

    .balance-icon {
      margin-right: 8px;
    }

    .exchange-link {
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
      padding: 8px 16px;
      border: 2px solid var(--accent);
      border-radius: 8px;
      transition: all 0.3s;
    }

    .exchange-link:hover {
      background: var(--accent);
      color: white;
    }

    .packages-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 30px 0 20px;
      color: #333;
      text-align: center;
    }

    .credit-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .credit-option {
      background: var(--card-bg);
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }

    .credit-option:hover {
      border-color: var(--accent);
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(47, 154, 52, 0.15);
    }

    .credit-option.selected {
      border-color: var(--accent);
      background: var(--soft-green-bg);
    }

    .credit-amount {
      font-size: 1.4rem;
      font-weight: 700;
      color: #333;
      margin-bottom: 8px;
    }

    .credit-price {
      font-size: 1.1rem;
      color: #666;
      position: relative;
    }

    .bonus-badge {
      position: absolute;
      top: -10px;
      right: -10px;
      background: #ff9800;
      color: white;
      font-size: 0.8rem;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: 600;
    }

    .payment-section {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.08);
      margin-bottom: 25px;
    }

    .payment-title {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 20px;
      color: #333;
    }

    .payment-method {
      display: flex;
      align-items: center;
      padding: 20px;
      border: 2px solid #e8e8e8;
      border-radius: 10px;
      margin-bottom: 20px;
      transition: border-color 0.3s;
    }

    .payment-method:hover {
      border-color: var(--accent);
    }

    .payment-icon {
      background: #1a1f71;
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      font-weight: bold;
      margin-right: 15px;
      font-size: 0.9rem;
    }

    .payment-details {
      flex-grow: 1;
    }

    .payment-name {
      font-weight: 600;
      margin-bottom: 5px;
      color: #333;
    }

    .payment-info {
      font-size: 0.9rem;
      color: #666;
    }

    .payment-check {
      color: var(--accent);
      font-size: 1.5rem;
      font-weight: bold;
    }

    .total-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 20px;
      border-top: 2px solid var(--muted);
    }

    .total-label {
      font-size: 1.2rem;
      font-weight: 600;
      color: #333;
    }

    .total-amount {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--accent);
    }

    .recharge-button {
      width: 100%;
      background: var(--green);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 18px;
      font-size: 1.2rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 20px;
    }

    .recharge-button:hover {
      background: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(47, 154, 52, 0.3);
    }

    .recharge-button:disabled {
      background: #cccccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Modal de confirmaci√≥n */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      padding: 20px;
      display: none;
    }

    .modal-content {
      background: white;
      border-radius: 15px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      padding: 25px;
      border-bottom: 2px solid var(--muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 1.4rem;
      font-weight: 600;
      color: #333;
    }

    .close-button {
      background: none;
      border: none;
      font-size: 2rem;
      cursor: pointer;
      color: #888;
      transition: color 0.3s;
    }

    .close-button:hover {
      color: #333;
    }

    .modal-body {
      padding: 25px;
    }

    .summary-section {
      margin-bottom: 20px;
      text-align: center;
    }

    .summary-section p {
      margin: 10px 0;
      font-size: 1.1rem;
    }

    .confidential-checkbox {
      display: flex;
      align-items: flex-start;
      margin-bottom: 20px;
      padding: 15px;
      background: var(--soft-green-bg);
      border-radius: 8px;
    }

    .confidential-checkbox input {
      margin-right: 12px;
      margin-top: 3px;
    }

    .account-section {
      margin-bottom: 20px;
      text-align: center;
    }

    .account-title {
      font-weight: 600;
      margin-bottom: 10px;
      color: #333;
    }

    .total-credits {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
    }

    .divider-line {
      height: 2px;
      background: var(--muted);
      margin: 20px 0;
    }

    .payment-form {
      margin-top: 20px;
    }

    .form-title {
      font-weight: 600;
      margin-bottom: 15px;
      color: #333;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }

    .form-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e8e8e8;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    .form-input:focus {
      border-color: var(--accent);
      outline: none;
    }

    .form-row {
      display: flex;
      gap: 15px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .policy-text {
      font-size: 0.9rem;
      color: #666;
      line-height: 1.5;
      margin: 20px 0;
      text-align: center;
    }

    .policy-text a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
    }

    .user-payment-info {
      background: var(--soft-green-bg);
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
    }

    .user-payment-detail {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 1rem;
    }

    .modal-footer {
      padding: 25px;
      border-top: 2px solid var(--muted);
      text-align: center;
    }

    .modal-recharge-button {
      background: var(--green);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 15px 40px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .modal-recharge-button:hover {
      background: var(--accent);
      transform: translateY(-2px);
    }

    .modal-recharge-button:disabled {
      background: #cccccc;
      cursor: not-allowed;
      transform: none;
    }

    /* Estado de carga */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Mensajes de estado */
    .status-message {
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
      font-weight: 600;
    }

    .status-success {
      background: #e8f5e8;
      color: #2e7d32;
      border: 2px solid #4caf50;
    }

    .status-error {
      background: #ffebee;
      color: #c62828;
      border: 2px solid #f44336;
    }

    .status-info {
      background: #e3f2fd;
      color: #1565c0;
      border: 2px solid #2196f3;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .credit-options {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
      }
      
      .user-section {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .form-row {
        flex-direction: column;
        gap: 10px;
      }
    }
  </style>
</head>

<body>
  <!-- Topbar consistente con el resto de la aplicaci√≥n -->
  <header class="topbar">
    <div class="logo-area">
      <img src="https://i.imgur.com/zQ0kV9R.png" alt="Logo Plataforma" class="logo-img">
      <h1>Plataforma de Trueque Digital</h1>
    </div>

    <div class="search-area">
      <input type="search" class="search-bar" placeholder="Buscar..." aria-label="Buscar">
    </div>

    <div class="right-area">
      <div class="credits-bubble" title="Cr√©ditos disponibles">
        <span class="coin">‚ôªÔ∏è</span>
        <span id="topCredits">0</span>
      </div>

      <div class="user-area" id="profileToggle">
        <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Usuario" class="user-icon">
        <span id="userName">Usuario</span>
      </div>
    </div>
  </header>

  <!-- Contenido principal -->
  <div class="compra-container">
    <h1 class="page-title">Consigue Cr√©ditos Verdes</h1>

    <!-- Vista principal -->
    <div id="main-view">
      <div class="compra-card">
        <div class="user-section">
          <div class="user-info">
            <div class="username">
              <span class="balance-icon"><i class="fas fa-leaf"></i></span>
              <span id="currentBalance">0</span> cr√©ditos verdes
            </div>
          </div>
          <a href="perfil.html" class="exchange-link">‚Üê Volver al Perfil</a>
        </div>

        <div id="statusMessage"></div>
      </div>

      <h2 class="packages-title">Selecciona un paquete de cr√©ditos</h2>

      <div class="credit-options" id="credit-options">
        <div class="credit-option" data-credits="100" data-price="10">
          <div class="credit-amount">100 cr√©ditos</div>
          <div class="credit-price">Bs 10</div>
        </div>
        <div class="credit-option" data-credits="250" data-price="22">
          <div class="credit-amount">250 cr√©ditos</div>
          <div class="credit-price">Bs 22 <span class="bonus-badge"></span></div>
        </div>
        <div class="credit-option" data-credits="500" data-price="40">
          <div class="credit-amount">500 cr√©ditos</div>
          <div class="credit-price">Bs 40 <span class="bonus-badge"></span></div>
        </div>
        <div class="credit-option" data-credits="1000" data-price="75">
          <div class="credit-amount">1000 cr√©ditos</div>
          <div class="credit-price">Bs 75 <span class="bonus-badge"></span></div>
        </div>
        <div class="credit-option" data-credits="2000" data-price="130">
          <div class="credit-amount">2000 cr√©ditos</div>
          <div class="credit-price">Bs 130 <span class="bonus-badge"></span></div>
        </div>
        <div class="credit-option" data-credits="5000" data-price="300">
          <div class="credit-amount">5000 cr√©ditos</div>
          <div class="credit-price">Bs 300 <span class="bonus-badge"></span></div>
        </div>
      </div>

      <div class="payment-section">
        <h3 class="payment-title">M√©todo de pago</h3>

        <div class="payment-method">
          <div class="payment-icon">VISA</div>
          <div class="payment-details">
            <div class="payment-name">Tarjeta terminada en 4821</div>
            <div class="payment-info">Expira 12/27</div>
          </div>
          <div class="payment-check">‚úî</div>
        </div>

        <div class="total-section">
          <div class="total-label">Total a pagar</div>
          <div class="total-amount" id="total-amount">Bs 0</div>
        </div>
      </div>

      <button class="recharge-button" id="recharge-button" disabled>
        <span id="button-text">Selecciona un paquete</span>
      </button>
    </div>
  </div>

  <!-- Modal de confirmaci√≥n -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Confirmar Recarga</div>
        <button class="close-button" id="close-modal">&times;</button>
      </div>

      <div class="modal-body">
        <div class="summary-section">
          <p>Est√°s a punto de adquirir:</p>
          <p><strong id="summary-credits">0 cr√©ditos</strong> por un total de <strong id="summary-total">Bs 0</strong>.</p>
        </div>

        <div class="confidential-checkbox">
          <input type="checkbox" id="accept-policy">
          <label for="accept-policy">Confirmo que la informaci√≥n es correcta y acepto la pol√≠tica de privacidad.</label>
        </div>

        <div class="account-section">
          <div class="account-title">Saldo despu√©s de la compra:</div>
          <div class="total-credits" id="new-balance">0 cr√©ditos</div>
        </div>

        <div class="divider-line"></div>

        <div class="user-payment-info">
          <div class="user-payment-detail">
            <span>Usuario:</span>
            <span id="modal-user-name">Cargando...</span>
          </div>
          <div class="user-payment-detail">
            <span>Email:</span>
            <span id="modal-user-email">Cargando...</span>
          </div>
          <div class="user-payment-detail">
            <span>Saldo actual:</span>
            <span id="modal-current-balance">0 cr√©ditos</span>
          </div>
        </div>

        <div class="payment-form">
          <div class="form-title">Datos de la tarjeta</div>

          <div class="form-group">
            <label class="form-label" for="card-number">N√∫mero de tarjeta</label>
            <input type="text" id="card-number" class="form-input" placeholder="**** **** **** 4821" maxlength="19">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="exp-date">Fecha de expiraci√≥n</label>
              <input type="text" id="exp-date" class="form-input" placeholder="MM/AA" maxlength="5">
            </div>

            <div class="form-group">
              <label class="form-label" for="cvv">CVV</label>
              <input type="password" id="cvv" class="form-input" placeholder="***" maxlength="3">
            </div>
          </div>
        </div>

        <div class="policy-text">
          Esta transacci√≥n est√° protegida. Al confirmar, aceptas nuestros <a href="#">t√©rminos de uso</a>.
        </div>
      </div>

      <div class="modal-footer">
        <button class="modal-recharge-button" id="confirm-recharge" disabled>
          <span id="confirm-button-text">Confirmar Recarga</span>
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from '../config/db.js';

    let currentUserId = null;
    let currentUserData = null;
    let selectedCredits = 0;
    let selectedPrice = 0;
    let currentBalance = 0;

    // Elementos del DOM
    const creditOptions = document.querySelectorAll('.credit-option');
    const totalAmount = document.getElementById('total-amount');
    const rechargeButton = document.getElementById('recharge-button');
    const buttonText = document.getElementById('button-text');
    const currentBalanceEl = document.getElementById('currentBalance');
    const topCredits = document.getElementById('topCredits');
    const userName = document.getElementById('userName');
    const statusMessage = document.getElementById('statusMessage');

    // Elementos del modal
    const modal = document.getElementById('modal-overlay');
    const closeModal = document.getElementById('close-modal');
    const confirmRecharge = document.getElementById('confirm-recharge');
    const acceptPolicy = document.getElementById('accept-policy');
    const summaryCredits = document.getElementById('summary-credits');
    const summaryTotal = document.getElementById('summary-total');
    const newBalance = document.getElementById('new-balance');
    const modalUserName = document.getElementById('modal-user-name');
    const modalUserEmail = document.getElementById('modal-user-email');
    const modalCurrentBalance = document.getElementById('modal-current-balance');
    const confirmButtonText = document.getElementById('confirm-button-text');

    // ========== INICIALIZACI√ìN ==========

    async function init() {
      try {
        console.log('üîÑ Inicializando p√°gina de compra...');

        // Verificar autenticaci√≥n
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        
        if (authError || !user) {
          showStatus('Debes iniciar sesi√≥n para recargar cr√©ditos', 'error');
          setTimeout(() => window.location.href = 'index.html', 2000);
          return;
        }

        currentUserId = user.id;
        console.log('‚úÖ Usuario autenticado:', currentUserId);

        // Cargar datos del usuario
        await loadUserData();
        
        // Configurar event listeners
        setupEventListeners();

      } catch (error) {
        console.error('‚ùå Error en inicializaci√≥n:', error);
        showStatus('Error al cargar la p√°gina: ' + error.message, 'error');
      }
    }

    // ========== CARGA DE DATOS DEL USUARIO ==========

    async function loadUserData() {
      try {
        showStatus('Cargando informaci√≥n del usuario...', 'info');

        // Obtener datos del usuario desde la tabla 'usuario'
        const { data: usuario, error: userError } = await supabase
          .from('usuario')
          .select('*')
          .eq('auth_id', currentUserId)
          .single();

        if (userError) throw userError;

        if (!usuario) {
          throw new Error('No se encontraron datos del usuario');
        }

        currentUserData = usuario;
        currentBalance = usuario.saldo_creditos || 0;

        // Actualizar UI
        currentBalanceEl.textContent = currentBalance;
        topCredits.textContent = currentBalance;
        userName.textContent = usuario.nombre_completo || 'Usuario';
        modalUserName.textContent = usuario.nombre_completo || 'Usuario';
        modalUserEmail.textContent = usuario.correo_electronico || 'No especificado';

        clearStatus();
        console.log('‚úÖ Datos del usuario cargados:', usuario);

      } catch (error) {
        console.error('‚ùå Error cargando datos del usuario:', error);
        showStatus('Error al cargar datos del usuario: ' + error.message, 'error');
      }
    }

    // ========== CONFIGURACI√ìN DE EVENT LISTENERS ==========

    function setupEventListeners() {
      // Selecci√≥n de paquetes de cr√©ditos
      creditOptions.forEach(opt => {
        opt.addEventListener('click', () => {
          creditOptions.forEach(o => o.classList.remove('selected'));
          opt.classList.add('selected');
          
          selectedCredits = parseInt(opt.dataset.credits);
          selectedPrice = parseInt(opt.dataset.price);
          
          totalAmount.textContent = `Bs ${selectedPrice}`;
          rechargeButton.disabled = false;
          buttonText.textContent = `Recargar ${selectedCredits} cr√©ditos - Bs ${selectedPrice}`;
        });
      });

      // Bot√≥n de recarga
      rechargeButton.addEventListener('click', () => {
        if (selectedCredits > 0) {
          openConfirmationModal();
        }
      });

      // Modal events
      closeModal.addEventListener('click', closeConfirmationModal);
      
      acceptPolicy.addEventListener('change', () => {
        confirmRecharge.disabled = !acceptPolicy.checked;
      });

      // Confirmar recarga
      confirmRecharge.addEventListener('click', processRecharge);

      // Cerrar modal al hacer click fuera
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeConfirmationModal();
        }
      });

      // Formatear inputs de tarjeta
      document.getElementById('card-number').addEventListener('input', formatCardNumber);
      document.getElementById('exp-date').addEventListener('input', formatExpDate);
    }

    // ========== MODAL DE CONFIRMACI√ìN ==========

    function openConfirmationModal() {
      summaryCredits.textContent = `${selectedCredits} cr√©ditos`;
      summaryTotal.textContent = `Bs ${selectedPrice}`;
      
      const newBalanceValue = currentBalance + selectedCredits;
      newBalance.textContent = `${newBalanceValue} cr√©ditos`;
      modalCurrentBalance.textContent = `${currentBalance} cr√©ditos`;

      // Resetear formulario
      acceptPolicy.checked = false;
      confirmRecharge.disabled = true;
      document.getElementById('card-number').value = '';
      document.getElementById('exp-date').value = '';
      document.getElementById('cvv').value = '';

      modal.style.display = 'flex';
    }

    function closeConfirmationModal() {
      modal.style.display = 'none';
    }

// ========== PROCESAR RECARGA (Versi√≥n Corregida) ==========
async function processRecharge() {
    try {
        if (!validateCardData()) {
            showStatus('Por favor, completa correctamente los datos de la tarjeta', 'error');
            return;
        }

        confirmRecharge.disabled = true;
        confirmButtonText.innerHTML = '<div class="loading"></div> Procesando...';

        console.log('üîÑ Procesando recarga de cr√©ditos...');
        
        // Para la versi√≥n con NOTICE, necesitamos capturar el NOTICE
        const { data, error: rpcError } = await supabase.rpc('comprar_creditos', {
            p_usuario_id: currentUserId,
            p_monto_bs: selectedPrice,
            p_creditos: selectedCredits
        });

        if (rpcError) throw rpcError;

        // En esta versi√≥n, data ser√° null pero la operaci√≥n se ejecut√≥
        // Los cr√©ditos ya se actualizaron en la base de datos
        
        // Recargar los datos del usuario para obtener el nuevo saldo
        await loadUserData();
        
        // Mensaje de √©xito gen√©rico
        showStatus(`‚úÖ ¬°Recarga exitosa! Se han a√±adido cr√©ditos a tu cuenta.`, 'success');

        // Resetear y redirigir
        creditOptions.forEach(o => o.classList.remove('selected'));
        rechargeButton.disabled = true;
        buttonText.textContent = 'Selecciona un paquete';
        totalAmount.textContent = 'Bs 0';

        setTimeout(() => {
            window.location.href = 'perfil.html';
        }, 3000);

    } catch (error) {
        console.error('‚ùå Error procesando recarga:', error);
        showStatus('‚ùå Error al procesar la recarga: ' + error.message, 'error');
        confirmRecharge.disabled = false;
        confirmButtonText.textContent = 'Confirmar Recarga';
    }
}

    // ========== FUNCIONES AUXILIARES ==========

    async function updateBilletera(creditos) {
    try {
        console.log('üí∞ Actualizando billetera con:', creditos, 'cr√©ditos');
        
        // Verificar si existe billetera
        const { data: billetera, error: billeteraError } = await supabase
            .from('billetera')
            .select('*')
            .eq('usuario_id', currentUserId)
            .single();

        console.log('üìä Estado actual de billetera:', billetera);

        if (billeteraError && billeteraError.code !== 'PGRST116') {
            console.error('‚ùå Error al verificar billetera:', billeteraError);
            throw billeteraError;
        }

        if (billetera) {
            // Actualizar billetera existente - USAR LOS VALORES CORRECTOS
            const nuevoTotal = (parseFloat(billetera.credito_total) || 0) + creditos;
            const nuevoActual = (parseFloat(billetera.credito_actual) || 0) + creditos;
            
            console.log('üîÑ Actualizando billetera existente:', {
                anterior_total: billetera.credito_total,
                anterior_actual: billetera.credito_actual,
                nuevo_total: nuevoTotal,
                nuevo_actual: nuevoActual
            });

            const { data, error: updateError } = await supabase
                .from('billetera')
                .update({
                    credito_total: nuevoTotal,
                    credito_actual: nuevoActual,
                    credito_retenido: billetera.credito_retenido || 0,
                    ultima_actualizacion: new Date().toISOString()
                })
                .eq('usuario_id', currentUserId)
                .select();

            if (updateError) {
                console.error('‚ùå Error actualizando billetera:', updateError);
                throw updateError;
            }
            
            console.log('‚úÖ Billetera actualizada:', data);

        } else {
            // Crear nueva billetera
            console.log('üÜï Creando nueva billetera con:', creditos, 'cr√©ditos');
            
            const { data, error: insertError } = await supabase
                .from('billetera')
                .insert([{
                    usuario_id: currentUserId,
                    credito_total: creditos,
                    credito_actual: creditos,
                    credito_retenido: 0,
                    ultima_actualizacion: new Date().toISOString()
                }])
                .select();

            if (insertError) {
                console.error('‚ùå Error creando billetera:', insertError);
                throw insertError;
            }
            
            console.log('‚úÖ Nueva billetera creada:', data);
        }

        console.log('‚úÖ Billetera actualizada exitosamente');

    } catch (error) {
        console.error('‚ùå Error cr√≠tico en updateBilletera:', error);
        throw error;
    }
}
    async function registrarEnHistorial(creditos, precio) {
    try {
        const { error } = await supabase
            .from('historial')
            .insert([{
                fecha: new Date(),
                tipo: 'Recarga de cr√©ditos',
                total: creditos,
                auth_id: currentUserId // ‚Üê CORREGIDO: usar auth_id
            }]);

        if (error) throw error;
        console.log('‚úÖ Historial actualizado');
    } catch (error) {
        console.warn('‚ö†Ô∏è No se pudo registrar en el historial:', error);
        // No lanzar error, es opcional
    }
}

    function validateCardData() {
      const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
      const expDate = document.getElementById('exp-date').value;
      const cvv = document.getElementById('cvv').value;

      // Validaciones b√°sicas
      if (cardNumber.length !== 16 || !/^\d+$/.test(cardNumber)) {
        return false;
      }

      if (!/^\d{2}\/\d{2}$/.test(expDate)) {
        return false;
      }

      if (cvv.length !== 3 || !/^\d+$/.test(cvv)) {
        return false;
      }

      return true;
    }

    function formatCardNumber(e) {
      let value = e.target.value.replace(/\s/g, '').replace(/\D/g, '');
      if (value.length > 16) value = value.substr(0, 16);
      
      let formatted = '';
      for (let i = 0; i < value.length; i++) {
        if (i > 0 && i % 4 === 0) formatted += ' ';
        formatted += value[i];
      }
      
      e.target.value = formatted;
    }

    function formatExpDate(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 4) value = value.substr(0, 4);
      
      if (value.length >= 2) {
        value = value.substr(0, 2) + '/' + value.substr(2);
      }
      
      e.target.value = value;
    }

    function showStatus(message, type) {
      statusMessage.innerHTML = `
        <div class="status-${type} status-message">
          ${message}
        </div>
      `;
    }

    function clearStatus() {
      statusMessage.innerHTML = '';
    }

    // ========== INICIALIZAR APLICACI√ìN ==========

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>

</html>
