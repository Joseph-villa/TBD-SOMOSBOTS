<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Compras/Ventas</title>
    <link rel="stylesheet" href="styles/estilos.css">
    <style>
        /* Estilos b√°sicos para diferenciar el total, puedes mover esto a estilos.css */
        .credito.positivo { color: #28a745; font-weight: bold; } /* Verde */
        .credito.negativo { color: #dc3545; font-weight: bold; } /* Rojo */
        .tabla-historial { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .tabla-historial th, .tabla-historial td { padding: 12px 15px; border: 1px solid #ddd; text-align: left; }
        .tabla-historial th { background-color: #f8f8f8; }
        /* Estilo para el bot√≥n de volver */
        .back-btn {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            color: #007bff; /* Un color de enlace est√°ndar */
            font-size: 16px;
            margin-bottom: 15px;
            display: block;
        }
        .back-btn:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body class="historial-body">

    <div class="historial-container">
        <button id="backBtn" class="back-btn">‚Üê Volver</button> 
        
        <h2>üí∞ Historial de Compras/Ventas</h2>

        <table class="tabla-historial">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Tipo</th>
                    <th>Total (Cr√©ditos)</th>
                </tr>
            </thead>
            <tbody id="historialBody"> 
                <tr>
                    <td colspan="3">Cargando historial...</td>
                </tr>
            </tbody>
        </table>
    </div>

<script type="module">
    import { supabase } from './config/db.js';

    // üîë ID DE DEMOSTRACI√ìN
    const DEMO_USER_ID = 1; 

    // Funci√≥n para formatear la fecha
    const formatDate = (dateString) => {
        if (!dateString) return '-';
        const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
        return new Date(dateString).toLocaleDateString('es-ES', options);
    };

    /**
     * Carga el historial de transacciones
     */
    async function loadHistorial() {
    const historialBody = document.getElementById('historialBody');
    historialBody.innerHTML = '<tr><td colspan="3">Cargando historial...</td></tr>';
    
    try {
        // Obtener usuario autenticado
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        
        if (authError || !user) {
            historialBody.innerHTML = '<tr><td colspan="3">Error: Debes iniciar sesi√≥n para ver tu historial.</td></tr>';
            return;
        }

        const currentUserId = user.id;
        console.log('Usuario autenticado:', currentUserId);

        // Consultar historial usando auth_id - FORMA CORRECTA
        const { data: transacciones, error: fetchError } = await supabase
            .from('historial') 
.select(`
                    fecha, 
                    tipo, 
                    total,
                    Intercambio (
                        estado, 
                        creditos_verdes,
                        fecha_cierre
                    ) 
                `)
                .eq('auth_id', currentUserId)
            .order('fecha', { ascending: false }); 

        if (fetchError) {
                console.error('Error de Supabase:', fetchError);
                historialBody.innerHTML = `
                    <tr>
                        <td colspan="3">
                            ‚ö†Ô∏è Error al cargar: ${fetchError.message}
                            <br><small>Si el error es "PGRST200", necesitas crear la **Foreign Key** entre 'historial.intercambio_id' y 'Intercambio.id_intercambio'.</small>
                        </td>
                    </tr>
                `;
                return;
            }

            historialBody.innerHTML = '';

        if (!transacciones || transacciones.length === 0) {
            historialBody.innerHTML = '<tr><td colspan="3">A√∫n no hay transacciones registradas para este usuario.</td></tr>';
            return;
        }

        transacciones.forEach(transaccion => {
                const inter = transaccion.Intercambio;
                
                // 1. Determinar qu√© valores mostrar
                // Usamos los datos de Intercambio si existen, sino los de Historial
                
                const displayFecha = (inter && inter.fecha_cierre) ? inter.fecha_cierre : transaccion.fecha;
                const displayTipo = (inter && inter.estado) ? inter.estado : transaccion.tipo;
                // Usamos el total de Intercambio si existe, pero si es una compra,
                // el total en historial ya tiene el signo correcto (negativo)
                const displayTotal = (inter && inter.creditos_verdes) ? inter.creditos_verdes : transaccion.total;
                
                // 2. Determinar la clase de color (usamos el total de historial para el signo)
                const totalForColor = parseFloat(transaccion.total); 
                const esPositivo = totalForColor >= 0; 
                
                // 3. Formatear el total (usamos el total final)
                const finalTotal = parseFloat(displayTotal);
                const totalDisplay = `${esPositivo ? '+' : ''}${finalTotal.toFixed(0)}`; 
                
                
                const fila = `
                    <tr>
                        <td>${formatDate(displayFecha)}</td>
                        <td>${displayTipo}</td>
                        <td class="credito ${esPositivo ? 'positivo' : 'negativo'}">
                            üí∞ ${totalDisplay}
                        </td>
                    </tr>
                `;
                historialBody.insertAdjacentHTML('beforeend', fila);
            });

    } catch (err) {
        console.error('Error al cargar transacciones:', err);
        historialBody.innerHTML = `
            <tr>
                <td colspan="3">
                    Error al cargar el historial: ${err.message}
                    <br><small>Verifica que la tabla 'historial' exista y tenga los campos correctos</small>
                </td>
            </tr>
        `;
    }
}
    
    document.addEventListener('DOMContentLoaded', () => {
        // ‚≠ê CLAVE: Obtener el bot√≥n y a√±adir el listener
        const backBtn = document.getElementById('backBtn');
        
        backBtn.addEventListener('click', () => {
            // Vuelve a la p√°gina anterior en el historial del navegador
            history.back(); 
        });

        loadHistorial();
    });

</script>
</body>
</html>