<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Publicaci√≥n</title>
    <link rel="stylesheet" href="styles/estilos.css">
    <style>
        .publicar-container {
            max-width: 600px;
            margin: 40px auto;
            padding: 24px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #2F9A34;
            font-size: 1.5rem;
            margin-bottom: 16px;
            text-align: center;
        }

        label {
            font-weight: 600;
            color: #333;
            display: block;
            margin-top: 16px;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e6e6e6;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            box-sizing: border-box;
            margin-top: 8px;
        }

        input:focus, textarea:focus {
            border-color: #2F9A34;
            box-shadow: 0 0 0 3px rgba(47, 154, 52, 0.2);
            outline: none;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-publicar, .btn-delete, .btn-cancel {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, box-shadow 0.2s ease;
        }

        .btn-publicar {
            background-color: #2F9A34;
            color: white;
        }

        .btn-publicar:hover {
            background-color: #036d19;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-delete {
            background-color: #f44336;
            color: white;
        }

        .btn-delete:hover {
            background-color: #d32f2f;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-cancel {
            background-color: #f0f0f0;
            color: #333;
        }

        .btn-cancel:hover {
            background-color: #e0e0e0;
        }

        .hidden { display: none; }

        #currentImageContainer {
            margin: 16px 0;
            padding: 12px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }

        #currentImage {
            max-width: 200px;
            height: auto;
            border-radius: 8px;
            margin-top: 8px;
        }

        #loadingMessage {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .form-publicar {
            display: block;
        }
    </style>
</head>
<body class="publicar-body">
    <div class="publicar-container">
        <button class="back-btn" id="backBtn" title="Volver">‚Üê Volver</button>
        
        <h2>‚úèÔ∏è Editar Publicaci√≥n</h2>
        <p id="loadingMessage">Cargando datos de la publicaci√≥n...</p>
        
        <form id="editForm" class="form-publicar hidden">
            <input type="hidden" id="postId" name="postId">

            <label for="titulo">T√≠tulo *</label>
            <input type="text" id="titulo" name="titulo" required>

            <label for="descripcion">Descripci√≥n *</label>
            <textarea id="descripcion" name="descripcion" required></textarea>

            <label for="precio">Precio (‚ôªÔ∏è Cr√©ditos) *</label>
            <input type="number" id="precio" name="precio" required min="1">
            
            <label for="imagen">Cambiar Imagen (opcional)</label>
            <input type="file" id="imagen" name="imagen" accept="image/*">
            
            <div id="currentImageContainer">
                <p><strong>Imagen actual:</strong></p>
                <img id="currentImage" src="" alt="Imagen actual" style="max-width: 100%; height: auto;">
            </div>

            <div class="btn-group">
                <button type="submit" class="btn-publicar">üíæ Guardar Cambios</button>
                <button type="button" id="deleteBtn" class="btn-delete">üóëÔ∏è Eliminar</button>
                <button type="button" id="cancelBtn" class="btn-cancel">‚úï Cancelar</button>
            </div>
        </form>
    </div>

<script type="module">
    import { supabase } from './config/db.js'; // ‚úÖ CORREGIDO

    const editForm = document.getElementById('editForm');
    const loadingMessage = document.getElementById('loadingMessage');
    const currentImage = document.getElementById('currentImage');
    const cancelBtn = document.getElementById('cancelBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const backBtn = document.getElementById('backBtn');

    let currentPostId = null;
    let currentImageUrl = null;

    // 1. Obtener el ID de la URL
    function getPostIdFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get('id');
    }

    // 2. Cargar datos de la publicaci√≥n
    async function fetchPostData(postId) {
        try {
            const { data: post, error } = await supabase
                .from('Publicacion')
                .select('*')
                .eq('id_publicacion', postId)
                .single();

            if (error) throw error;
            if (!post) throw new Error('Publicaci√≥n no encontrada.');

            // Llenar el formulario con los datos
            document.getElementById('postId').value = post.id_publicacion;
            document.getElementById('titulo').value = post.titulo;
            document.getElementById('descripcion').value = post.descripcion;
            document.getElementById('precio').value = post.precio;
            
            currentPostId = post.id_publicacion;
            currentImageUrl = post.imagen_url;

            // Mostrar imagen actual
            if (currentImageUrl) {
                currentImage.src = currentImageUrl;
            } else {
                document.getElementById('currentImageContainer').innerHTML = '<p>No hay imagen actual.</p>';
            }

            // Mostrar el formulario
            loadingMessage.classList.add('hidden');
            editForm.classList.remove('hidden');

        } catch (err) {
            console.error('Error al cargar datos:', err);
            loadingMessage.textContent = '‚ùå Error: No se pudo cargar la publicaci√≥n. ' + err.message;
        }
    }

    // 3. Funci√≥n de subida de imagen
    async function uploadImage(imageFile, postId) {
        const filePath = `publicaciones/${postId}_${Date.now()}_${imageFile.name}`;
        
        const { data: uploadData, error: uploadError } = await supabase.storage
            .from('imagenes')
            .upload(filePath, imageFile, {
                cacheControl: '3600',
                upsert: false
            });
        
        if (uploadError) {
            console.error('Error de subida de imagen:', uploadError);
            throw new Error('‚ùå No se pudo subir la imagen.');
        }

        const { data: publicUrlData } = supabase
            .storage
            .from('imagenes')
            .getPublicUrl(filePath);

        return publicUrlData.publicUrl;
    }

    // 4. Manejar el env√≠o del formulario (EDITAR)
    editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const newTitle = document.getElementById('titulo').value.trim();
        const newDescription = document.getElementById('descripcion').value.trim();
        const newPrice = parseFloat(document.getElementById('precio').value);
        const imageFile = document.getElementById('imagen').files[0];
        const id = document.getElementById('postId').value;
        
        if (!newTitle || !newDescription) {
            alert('Por favor completa todos los campos.');
            return;
        }

        let newImageUrl = currentImageUrl;
        
        try {
            loadingMessage.textContent = 'Guardando cambios...';
            loadingMessage.classList.remove('hidden');
            editForm.classList.add('hidden');

            if (imageFile) {
                loadingMessage.textContent = 'Subiendo nueva imagen...';
                newImageUrl = await uploadImage(imageFile, id);
            }

            loadingMessage.textContent = 'Actualizando publicaci√≥n...';

            const { error: updateError } = await supabase
                .from('Publicacion')
                .update({
                    titulo: newTitle,
                    descripcion: newDescription,
                    precio: newPrice,
                    imagen_url: newImageUrl
                })
                .eq('id_publicacion', id);

            if (updateError) throw updateError;

            alert('‚úÖ Publicaci√≥n actualizada con √©xito.');
            window.location.href = 'perfil.html';

        } catch (err) {
            loadingMessage.textContent = '‚ùå Error: ' + err.message;
            editForm.classList.remove('hidden');
            console.error('Error:', err);
        }
    });

    // 5. üö® NUEVO: Manejar el bot√≥n de ELIMINAR
    deleteBtn.addEventListener('click', async () => {
        if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de que quieres ELIMINAR esta publicaci√≥n? Esta acci√≥n es irreversible.')) {
            return;
        }

        const id = document.getElementById('postId').value;

        try {
            loadingMessage.textContent = 'Eliminando publicaci√≥n...';
            loadingMessage.classList.remove('hidden');
            editForm.classList.add('hidden');

            const { error: deleteError } = await supabase
                .from('Publicacion')
                .delete()
                .eq('id_publicacion', id);

            if (deleteError) throw deleteError;

            alert('‚úÖ Publicaci√≥n eliminada con √©xito.');
            window.location.href = 'perfil.html';

        } catch (err) {
            loadingMessage.textContent = '‚ùå Error al eliminar: ' + err.message;
            editForm.classList.remove('hidden');
            console.error('Error:', err);
        }
    });

    // 6. Botones de cancelar y volver
    cancelBtn.addEventListener('click', () => {
        window.location.href = 'perfil.html';
    });

    backBtn.addEventListener('click', () => {
        window.location.href = 'perfil.html';
    });

    // 7. Cargar la publicaci√≥n al iniciar
    document.addEventListener('DOMContentLoaded', () => {
        const postId = getPostIdFromUrl();
        if (postId) {
            fetchPostData(postId);
        } else {
            loadingMessage.textContent = '‚ùå Error: ID de publicaci√≥n no encontrado en la URL.';
        }
    });

</script>
</body>
</html>