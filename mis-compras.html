<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Compras - Plataforma de Trueque</title>
    <link rel="stylesheet" href="styles/estilos.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .compra-card {
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* CORREGIDO: Clases de estado bien definidas */
        .estado-en_proceso {
            background: #fff3cd;
            color: #856404;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            text-transform: capitalize;
        }

        .estado-completado {
            background: #d4edda;
            color: #155724;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            text-transform: capitalize;
        }

        .estado-cancelado {
            background: #f8d7da;
            color: #721c24;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            text-transform: capitalize;
        }

        .btn-confirmar {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-confirmar:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-cancelar {
            background: #dc3545;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-cancelar:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-contactar {
            background: #17a2b8;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-contactar:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        .btn-calificar {
            background: #ffc107;
            color: #212529;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-calificar:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .acciones-container {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .creditos-retenidos {
            background: #e3f2fd;
            color: #1565c0;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #2196f3;
        }

        /* Modal de mensajer√≠a */
        .modal-mensajes {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content-mensajes {
            background: white;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header-mensajes {
            background: var(--green);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body-mensajes {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            max-height: 400px;
        }

        .mensaje {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 10px;
            max-width: 80%;
        }

        .mensaje-propio {
            background: #e3f2fd;
            margin-left: auto;
            text-align: right;
        }

        .mensaje-otro {
            background: #f5f5f5;
        }

        .input-mensaje {
            display: flex;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .input-mensaje input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        .btn-enviar {
            background: var(--green);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
        }

        /* Modal de calificaci√≥n */
        .modal-calificacion {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .estrellas {
            display: flex;
            gap: 5px;
            margin: 15px 0;
            justify-content: center;
        }

        .estrella {
            font-size: 2rem;
            color: #ddd;
            cursor: pointer;
            transition: color 0.2s;
        }

        .estrella:hover,
        .estrella.seleccionada {
            color: #ffc107;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.2rem;
        }

        /* Estado por defecto */
        .estado {
            background: #e9ecef;
            color: #495057;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            text-transform: capitalize;
        }

        .back-btn {
            background: none;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            color: #007bff;
            font-size: 16px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        .back-btn:hover {
            background-color: #f8f9fa;
        }
    </style>
</head>

<body class="perfil-body">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div style="text-align: center;">
            <i class="fas fa-spinner fa-spin" style="font-size: 3rem; margin-bottom: 15px;"></i>
            <div id="loadingText">Procesando...</div>
        </div>
    </div>

    <section class="perfil-container">
        <button class="back-btn" onclick="window.location.href='index2.html'">‚Üê Volver al Marketplace</button>

        <h2>üõí Mis Compras</h2>

        <div id="comprasList">
            <div>Cargando tus compras...</div>
        </div>
    </section>

    <!-- Modal de Mensajer√≠a -->
    <div class="modal-mensajes" id="modalMensajes">
        <div class="modal-content-mensajes">
            <div class="modal-header-mensajes">
                <h3 id="tituloChat">Chat con Vendedor</h3>
                <button onclick="cerrarModalMensajes()"
                    style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">√ó</button>
            </div>
            <div class="modal-body-mensajes" id="cuerpoMensajes">
                <!-- Los mensajes se cargar√°n aqu√≠ -->
            </div>
            <div class="input-mensaje">
                <input type="text" id="inputMensaje" placeholder="Escribe tu mensaje..."
                    onkeypress="if(event.key=='Enter')enviarMensaje()">
                <button class="btn-enviar" onclick="enviarMensaje()">Enviar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Calificaci√≥n -->
    <div class="modal-calificacion" id="modalCalificacion">
        <div style="background: white; padding: 30px; border-radius: 12px; text-align: center; max-width: 400px;">
            <h3>Calificar Transacci√≥n</h3>
            <p id="productoCalificar"></p>

            <div class="estrellas" id="estrellasCalificacion">
                <span class="estrella" data-puntuacion="1">‚òÖ</span>
                <span class="estrella" data-puntuacion="2">‚òÖ</span>
                <span class="estrella" data-puntuacion="3">‚òÖ</span>
                <span class="estrella" data-puntuacion="4">‚òÖ</span>
                <span class="estrella" data-puntuacion="5">‚òÖ</span>
            </div>

            <textarea id="comentarioCalificacion" placeholder="Comentario opcional..."
                style="width: 100%; height: 100px; margin: 15px 0; padding: 10px; border: 1px solid #ddd; border-radius: 6px;"></textarea>

            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn-confirmar" onclick="enviarCalificacion()">Enviar Calificaci√≥n</button>
                <button class="btn-cancelar" onclick="cerrarModalCalificacion()">Cancelar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabase } from './config/db.js';

        let currentUserId = null;
        let intercambioActual = null;
        let puntuacionSeleccionada = 0;

        // Funci√≥n para convertir money a n√∫mero
        function convertirMoneyANumero(valorMoney) {
            if (typeof valorMoney === 'number') return valorMoney;
            if (typeof valorMoney === 'string') {
                // Manejar formato money de PostgreSQL: "$1,234.56"
                const cleaned = valorMoney.replace(/[^\d.-]/g, '');
                return parseFloat(cleaned) || 0;
            }
            return 0;
        }

        // Funciones de loading
        function mostrarLoading(mensaje = 'Procesando...') {
            document.getElementById('loadingText').textContent = mensaje;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function ocultarLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Cargar compras del usuario
        async function cargarMisCompras() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    console.error('Usuario no autenticado');
                    document.getElementById('comprasList').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <h3>üîí Debes iniciar sesi√≥n</h3>
                            <p>Por favor inicia sesi√≥n para ver tus compras.</p>
                        </div>
                    `;
                    return;
                }
                
                currentUserId = user.id;
                console.log('üîÑ Cargando compras para usuario:', currentUserId);

                // Obtener intercambios b√°sicos
                const { data: intercambios, error } = await supabase
                    .from('Intercambio')
                    .select('*')
                    .eq('usuario_id', currentUserId)
                    .order('fecha_creacion', { ascending: false });

                if (error) {
                    console.error('Error al cargar intercambios:', error);
                    throw error;
                }

                console.log('üì¶ Intercambios encontrados:', intercambios);

                if (!intercambios || intercambios.length === 0) {
                    renderCompras([]);
                    return;
                }

                // Cargar datos relacionados
                const intercambiosCompletos = await Promise.all(
                    intercambios.map(async (intercambio) => {
                        console.log('üîÑ Procesando intercambio:', intercambio.id_intercambio);

                        // Cargar publicaci√≥n
                        let publicacion = null;
                        if (intercambio.publicacion_id) {
                            const { data: pubData } = await supabase
                                .from('Publicacion')
                                .select('*')
                                .eq('id_publicacion', intercambio.publicacion_id)
                                .single();
                            publicacion = pubData;
                        }

                        // Cargar mensajes
                        const { data: mensajes } = await supabase
                            .from('Mensaje')
                            .select('*')
                            .eq('intercambio_id', intercambio.id_intercambio)
                            .order('fecha_envio', { ascending: true });

                        // Cargar custodia (si existe) - VERSI√ìN MEJORADA
                        let custodia = null;
                        try {
                            const { data: custodiaData, error: custodiaError } = await supabase
                                .from('custodia_creditos')
                                .select('*')
                                .eq('intercambio_id', intercambio.id_intercambio)
                                .single();
                            
                            if (custodiaError) {
                                console.log('‚ùå Error cargando custodia:', {
                                    code: custodiaError.code,
                                    message: custodiaError.message,
                                    details: custodiaError.details,
                                    hint: custodiaError.hint
                                });
                                
                                if (custodiaError.code === 'PGRST116') {
                                    console.log('‚ÑπÔ∏è No hay registro de custodia para este intercambio');
                                } else if (custodiaError.code === '406') {
                                    console.log('‚ö†Ô∏è Error 406 - Problema de permisos RLS en custodia_creditos');
                                }
                            } else if (custodiaData) {
                                // Verificar que la custodia pertenece al usuario actual
                                if (custodiaData.comprador_id === currentUserId || custodiaData.oferente_id === currentUserId) {
                                    custodia = custodiaData;
                                    console.log('‚úÖ Custodia cargada:', custodia);
                                } else {
                                    console.log('üö´ Custodia no pertenece al usuario actual');
                                }
                            }
                        } catch (custodiaError) {
                            console.log('üí• Error inesperado en custodia:', custodiaError);
                        }

                        // Cargar calificaciones
                        const { data: calificaciones } = await supabase
                            .from('calificacion')
                            .select('*')
                            .eq('intercambio_id', intercambio.id_intercambio);

                        // Cargar datos del vendedor
                        let vendedor = null;
                        if (intercambio.usuario_vendedor_id) {
                            const { data: userData } = await supabase
                                .from('usuario')
                                .select('nombre_completo')
                                .eq('auth_id', intercambio.usuario_vendedor_id)
                                .single();
                            vendedor = userData;
                        }

                        return {
                            ...intercambio,
                            publicacion: publicacion,
                            mensajes: mensajes || [],
                            custodia: custodia,
                            calificaciones: calificaciones || [],
                            vendedor: vendedor
                        };
                    })
                );

                console.log('‚úÖ Intercambios completos cargados:', intercambiosCompletos);
                renderCompras(intercambiosCompletos);

            } catch (error) {
                console.error('‚ùå Error cargando compras:', error);
                document.getElementById('comprasList').innerHTML = `
                    <div class="no-posts" style="text-align: center; padding: 40px; color: #666;">
                        <h3>‚ùå Error al cargar las compras</h3>
                        <p>${error.message}</p>
                        <button onclick="location.reload()" 
                                style="margin-top: 15px; padding: 10px 20px; background: var(--green); color: white; border: none; border-radius: 5px; cursor: pointer;">
                            üîÑ Reintentar
                        </button>
                    </div>
                `;
            }
        }

        // CORREGIDO: Funci√≥n renderCompras bien definida
        function renderCompras(compras) {
            const comprasList = document.getElementById('comprasList');
            
            if (!compras || compras.length === 0) {
                comprasList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3>üì≠ No tienes compras realizadas</h3>
                        <p>Cuando realices compras, aparecer√°n aqu√≠.</p>
                        <button onclick="window.location.href='index2.html'" 
                                style="margin-top: 15px; padding: 10px 20px; background: var(--green); color: white; border: none; border-radius: 5px; cursor: pointer;">
                            üõçÔ∏è Ir al Marketplace
                        </button>
                    </div>
                `;
                return;
            }

            comprasList.innerHTML = compras.map(compra => {
                const precio = convertirMoneyANumero(compra.creditos_verdes);
                const tieneMensajes = compra.mensajes && compra.mensajes.length > 0;
                const tieneCalificacion = compra.calificaciones && compra.calificaciones.length > 0;
                const creditosRetenidos = compra.custodia && compra.custodia.estado === 'retenido';
                
                // Contar mensajes no le√≠dos de forma segura
                let mensajesNoLeidos = 0;
                if (tieneMensajes) {
                    mensajesNoLeidos = compra.mensajes.filter(m => 
                        m.receptor_id === currentUserId && !m.leido
                    ).length;
                }

                // Manejar datos de publicaci√≥n de forma segura
                const tituloProducto = compra.publicacion?.titulo || 'Producto';
                const nombreVendedor = compra.vendedor?.nombre_completo || 'Vendedor';

                // CORREGIDO: Manejo seguro del estado
                const estado = compra.estado || 'en_proceso';
                const estadoClass = `estado-${estado}`;
                const estadoTexto = estado.replace('_', ' ');

                return `
                    <div class="compra-card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <h3 style="margin: 0; flex: 1;">${tituloProducto}</h3>
                            <span class="${estadoClass}">${estadoTexto.toUpperCase()}</span>
                        </div>
                        
                        <p><strong>Precio:</strong> ${precio} ‚ôªÔ∏è</p>
                        <p><strong>Fecha:</strong> ${new Date(compra.fecha_creacion).toLocaleDateString()}</p>
                        <p><strong>Vendedor:</strong> ${nombreVendedor}</p>
                        
                        ${creditosRetenidos ? `
                            <div class="creditos-retenidos">
                                <i class="fas fa-lock"></i> 
                                <strong>${precio} cr√©ditos en custodia</strong>
                                <br>
                                <small>Confirma la recepci√≥n para liberar los cr√©ditos al vendedor</small>
                            </div>
                        ` : ''}
                        
                        ${compra.custodia && compra.custodia.estado === 'liberado' ? `
                            <div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #28a745;">
                                <i class="fas fa-check-circle"></i> 
                                <strong>Cr√©ditos liberados</strong>
                                <br>
                                <small>Has confirmado la recepci√≥n del producto</small>
                            </div>
                        ` : ''}
                        
                        ${tieneMensajes ? `
                            <p style="color: #17a2b8;">
                                <i class="fas fa-comments"></i> 
                                ${mensajesNoLeidos > 0 ? `<strong>${mensajesNoLeidos} mensaje(s) nuevo(s)</strong>` : 'Tienes mensajes'}
                            </p>
                        ` : ''}
                        
                        ${tieneCalificacion ? `
                            <p style="color: #28a745;">
                                <i class="fas fa-star"></i> Ya calificaste esta transacci√≥n
                            </p>
                        ` : ''}
                        
                        <div class="acciones-container">
                            ${estado === 'en_proceso' ? `
                                <button class="btn-confirmar" onclick="confirmarRecepcion(${compra.id_intercambio})">
                                    <i class="fas fa-check"></i> Confirmar Recepci√≥n
                                </button>
                                <button class="btn-cancelar" onclick="cancelarCompra(${compra.id_intercambio})">
                                    <i class="fas fa-times"></i> Cancelar Compra
                                </button>
                            ` : ''}
                            
                            ${estado === 'completado' && !tieneCalificacion ? `
                                <button class="btn-calificar" onclick="abrirModalCalificacion(${compra.id_intercambio}, '${tituloProducto.replace(/'/g, "\\'")}')">
                                    <i class="fas fa-star"></i> Calificar
                                </button>
                            ` : ''}
                            
                            <button class="btn-contactar" onclick="abrirChat(${compra.id_intercambio}, '${tituloProducto.replace(/'/g, "\\'")}', '${compra.usuario_vendedor_id}')">
                                <i class="fas fa-comment"></i> 
                                ${tieneMensajes ? 'Ver Chat' : 'Contactar Vendedor'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========== FUNCIONES PARA ACTUALIZAR PUBLICACIONES ==========

        async function marcarPublicacionComoVendida(intercambioId) {
            try {
                console.log('üè∑Ô∏è Marcando publicaci√≥n como vendida para intercambio:', intercambioId);
                
                // 1. Obtener el publicacion_id del intercambio
                const { data: intercambio, error: intercambioError } = await supabase
                    .from('Intercambio')
                    .select('publicacion_id')
                    .eq('id_intercambio', intercambioId)
                    .single();

                if (intercambioError) throw intercambioError;

                console.log('üì¶ Publicaci√≥n a marcar como vendida:', intercambio.publicacion_id);

                // 2. Marcar publicaci√≥n como vendida/inactiva
                const { error: updatePubError } = await supabase
                    .from('Publicacion')
                    .update({
                        estado: 'vendido'
                    })
                    .eq('id_publicacion', intercambio.publicacion_id);

                if (updatePubError) throw updatePubError;

                console.log('‚úÖ Publicaci√≥n marcada como vendida');

            } catch (error) {
                console.error('‚ùå Error marcando publicaci√≥n como vendida:', error);
                throw error;
            }
        }

        async function reactivarPublicacion(intercambioId) {
            try {
                console.log('üîÑ Reactivando publicaci√≥n para intercambio:', intercambioId);
                
                // 1. Obtener el publicacion_id del intercambio
                const { data: intercambio, error: intercambioError } = await supabase
                    .from('Intercambio')
                    .select('publicacion_id')
                    .eq('id_intercambio', intercambioId)
                    .single();

                if (intercambioError) throw intercambioError;

                // 2. Reactivar publicaci√≥n (volver a estado activo)
                const { error: updatePubError } = await supabase
                    .from('Publicacion')
                    .update({
                        estado: 'activo'
                    })
                    .eq('id_publicacion', intercambio.publicacion_id);

                if (updatePubError) throw updatePubError;

                console.log('‚úÖ Publicaci√≥n reactivada');

            } catch (error) {
                console.error('‚ùå Error reactivando publicaci√≥n:', error);
                throw error;
            }
        }

        // ========== SISTEMA DE CUSTODIA ==========

        window.confirmarRecepcion = async function (intercambioId) {
            if (!confirm('¬øConfirmas que has recibido el producto correctamente?\n\nLos cr√©ditos ser√°n liberados al vendedor y la publicaci√≥n se marcar√° como vendida.')) return;

            try {
                mostrarLoading('Confirmando recepci√≥n y actualizando estado...');

                // 1. Actualizar estado del intercambio
                const { error: intercambioError } = await supabase
                    .from('Intercambio')
                    .update({
                        estado: 'completado',
                        fecha_cierre: new Date()
                    })
                    .eq('id_intercambio', intercambioId);

                if (intercambioError) throw intercambioError;

                // 2. Liberar cr√©ditos al vendedor
                await liberarCreditosVendedor(intercambioId);

                // 3. Marcar publicaci√≥n como VENDIDA
                await marcarPublicacionComoVendida(intercambioId);

                // 4. Actualizar custodia si existe
                try {
                    const { error: custodiaError } = await supabase
                        .from('custodia_creditos')
                        .update({
                            estado: 'liberado',
                            fecha_liberacion: new Date()
                        })
                        .eq('intercambio_id', intercambioId);

                    if (custodiaError) console.warn('Advertencia custodia:', custodiaError);
                } catch (custodiaError) {
                    console.log('‚ÑπÔ∏è No se pudo actualizar custodia:', custodiaError.message);
                }

                ocultarLoading();
                alert('‚úÖ ¬°Gracias por confirmar! Los cr√©ditos han sido liberados al vendedor y la publicaci√≥n se ha marcado como vendida.');

                // Recargar compras
                cargarMisCompras();

            } catch (error) {
                ocultarLoading();
                console.error('Error confirmando recepci√≥n:', error);
                alert('‚ùå Error al confirmar la recepci√≥n: ' + error.message);
            }
        }

        // Liberar cr√©ditos al vendedor
        async function liberarCreditosVendedor(intercambioId) {
            try {
                console.log('üí∞ Liberando cr√©ditos al vendedor para intercambio:', intercambioId);
                
                // 1. Obtener datos del intercambio
                const { data: intercambio, error: intercambioError } = await supabase
                    .from('Intercambio')
                    .select('*')
                    .eq('id_intercambio', intercambioId)
                    .single();

                if (intercambioError) throw intercambioError;

                const monto = convertirMoneyANumero(intercambio.creditos_verdes);
                const vendedorId = intercambio.usuario_vendedor_id;

                console.log('üìä Datos intercambio:', { monto, vendedorId });

                // 2. Buscar billetera del vendedor
                const { data: billeteraVendedor, error: billeteraError } = await supabase
                    .from('billetera')
                    .select('*')
                    .eq('usuario_id', vendedorId)
                    .single();

                // Si no existe billetera, CREARLA
                if (billeteraError && billeteraError.code === 'PGRST116') {
                    console.log('üÜï Creando nueva billetera para vendedor:', vendedorId);
                    
                    const { data: nuevaBilletera, error: createError } = await supabase
                        .from('billetera')
                        .insert([{
                            usuario_id: vendedorId,
                            credito_total: parseFloat(monto),
                            credito_actual: parseFloat(monto),
                            credito_retenido: 0,
                            ultima_actualizacion: new Date().toISOString()
                        }])
                        .select();

                    if (createError) {
                        console.error('‚ùå Error creando billetera vendedor:', createError);
                        throw createError;
                    }
                    
                    console.log('‚úÖ Nueva billetera creada para vendedor:', nuevaBilletera);
                    
                } else if (billeteraError) {
                    console.error('‚ùå Error buscando billetera vendedor:', billeteraError);
                    throw billeteraError;
                    
                } else {
                    // Billetera existe - ACTUALIZAR
                    console.log('üìä Billetera vendedor encontrada:', billeteraVendedor);
                    
                    const creditoActual = parseFloat(billeteraVendedor.credito_actual) || 0;
                    const creditoTotal = parseFloat(billeteraVendedor.credito_total) || 0;
                    const montoNum = parseFloat(monto);

                    const nuevoActual = creditoActual + montoNum;
                    const nuevoTotal = creditoTotal + montoNum;

                    console.log('üîÑ Actualizando billetera vendedor:', {
                        anterior: { actual: creditoActual, total: creditoTotal },
                        nuevo: { actual: nuevoActual, total: nuevoTotal }
                    });

                    const { data: billeteraActualizada, error: updateError } = await supabase
                        .from('billetera')
                        .update({
                            credito_actual: nuevoActual,
                            credito_total: nuevoTotal,
                            ultima_actualizacion: new Date().toISOString()
                        })
                        .eq('usuario_id', vendedorId)
                        .select();

                    if (updateError) {
                        console.error('‚ùå Error actualizando billetera vendedor:', updateError);
                        throw updateError;
                    }
                    
                    console.log('‚úÖ Billetera vendedor actualizada:', billeteraActualizada);
                }

                // 3. Actualizar saldo del vendedor en tabla usuario
                await actualizarSaldoVendedor(vendedorId, monto);

                console.log('‚úÖ Cr√©ditos liberados al vendedor en billetera y usuario');

            } catch (error) {
                console.error('‚ùå Error liberando cr√©ditos:', error);
                throw error;
            }
        }

        async function actualizarSaldoVendedor(vendedorId, monto) {
    try {
        console.log('üí∞ Actualizando saldo del vendedor en tabla usuario:', { vendedorId, monto });
        
        // 1. Obtener saldo actual del vendedor desde la tabla usuario
        const { data: vendedor, error: vendedorError } = await supabase
            .from('usuario')
            .select('saldo_creditos')
            .eq('auth_id', vendedorId)
            .single();

        if (vendedorError) {
            console.error('‚ùå Error obteniendo saldo del vendedor:', vendedorError);
            throw vendedorError;
        }

        const saldoActual = parseFloat(vendedor.saldo_creditos) || 0;
        const montoNum = parseFloat(monto);
        const nuevoSaldo = saldoActual + montoNum;

        console.log('üí∞ Saldo vendedor - Actual:', saldoActual, 'Monto a agregar:', montoNum, 'Nuevo saldo:', nuevoSaldo);

        // 2. Actualizar tabla usuario del vendedor
        const { error: updateError } = await supabase
            .from('usuario')
            .update({
                saldo_creditos: nuevoSaldo
            })
            .eq('auth_id', vendedorId);

        if (updateError) {
            console.error('‚ùå Error actualizando saldo en usuario:', updateError);
            throw updateError;
        }

        console.log('‚úÖ Saldo vendedor actualizado en tabla usuario:', nuevoSaldo);

    } catch (error) {
        console.error('‚ùå Error actualizando saldo vendedor:', error);
        throw error;
    }
}

        window.cancelarCompra = async function (intercambioId) {
            if (!confirm('¬øEst√°s seguro de que quieres cancelar esta compra?\n\nLos cr√©ditos retenidos ser√°n devueltos a tu cuenta y la publicaci√≥n volver√° a estar disponible.')) return;

            try {
                mostrarLoading('Cancelando compra y devolviendo cr√©ditos...');

                // 1. Obtener datos del intercambio PRIMERO
                const { data: intercambio, error: getError } = await supabase
                    .from('Intercambio')
                    .select('creditos_verdes')
                    .eq('id_intercambio', intercambioId)
                    .single();

                if (getError) throw getError;

                const monto = convertirMoneyANumero(intercambio.creditos_verdes);

                // 2. Actualizar estado del intercambio
                const { error: intercambioError } = await supabase
                    .from('Intercambio')
                    .update({
                        estado: 'cancelado',
                        fecha_cierre: new Date()
                    })
                    .eq('id_intercambio', intercambioId);

                if (intercambioError) throw intercambioError;

                // 3. Devolver cr√©ditos al comprador
                await devolverCreditosComprador(currentUserId, monto);

                // 4. Reactivar publicaci√≥n
                await reactivarPublicacion(intercambioId);

                // 5. Actualizar custodia
                const { error: custodiaError } = await supabase
                    .from('custodia_creditos')
                    .update({
                        estado: 'cancelado',
                        fecha_liberacion: new Date().toISOString()
                    })
                    .eq('intercambio_id', intercambioId);

                if (custodiaError) console.warn('Advertencia custodia:', custodiaError);

                ocultarLoading();
                alert('‚úÖ Compra cancelada. Los cr√©ditos han sido devueltos a tu cuenta y la publicaci√≥n est√° disponible nuevamente.');

                // Recargar compras
                cargarMisCompras();

            } catch (error) {
                ocultarLoading();
                console.error('Error cancelando compra:', error);
                alert('‚ùå Error al cancelar la compra: ' + error.message);
            }
        }

        // Devolver cr√©ditos al comprador
        async function devolverCreditosComprador(usuarioId, monto) {
    try {
        console.log('üí≥ Devolviendo cr√©ditos al comprador:', { usuarioId, monto });
        
        // 1. Obtener saldo actual desde usuario
        const { data: usuario, error: usuarioError } = await supabase
            .from('usuario')
            .select('saldo_creditos')
            .eq('auth_id', usuarioId)
            .single();

        if (usuarioError) {
            console.error('‚ùå Error obteniendo saldo del comprador:', usuarioError);
            throw usuarioError;
        }

        const saldoActual = parseFloat(usuario.saldo_creditos) || 0;
        const montoNum = parseFloat(monto);
        const nuevoSaldo = saldoActual + montoNum;

        console.log('üí∞ Saldo comprador - Actual:', saldoActual, 'Monto a devolver:', montoNum, 'Nuevo saldo:', nuevoSaldo);

        // 2. Actualizar tabla usuario
        const { error: updateError } = await supabase
            .from('usuario')
            .update({
                saldo_creditos: nuevoSaldo
            })
            .eq('auth_id', usuarioId);

        if (updateError) {
            console.error('‚ùå Error actualizando saldo en usuario:', updateError);
            throw updateError;
        }

        // 3. Actualizar billetera
        await actualizarBilleteraDevolucion(usuarioId, monto);

        // 4. Actualizar UI de forma segura
        actualizarCreditosUI(nuevoSaldo);

        console.log('‚úÖ Cr√©ditos devueltos al comprador en tabla usuario y billetera');

    } catch (error) {
        console.error('‚ùå Error devolviendo cr√©ditos:', error);
        throw error;
    }
}

        async function actualizarBilleteraDevolucion(usuarioId, monto) {
            try {
                console.log('üîÑ Actualizando billetera para devoluci√≥n:', { usuarioId, monto });
                
                // Buscar billetera del usuario
                const { data: billetera, error: billeteraError } = await supabase
                    .from('billetera')
                    .select('*')
                    .eq('usuario_id', usuarioId)
                    .single();

                // Si no existe billetera, CREARLA
                if (billeteraError && billeteraError.code === 'PGRST116') {
                    console.log('üÜï Creando nueva billetera para usuario:', usuarioId);
                    
                    const { data: nuevaBilletera, error: createError } = await supabase
                        .from('billetera')
                        .insert([{
                            usuario_id: usuarioId,
                            credito_total: parseFloat(monto),
                            credito_actual: parseFloat(monto),
                            credito_retenido: 0,
                            ultima_actualizacion: new Date().toISOString()
                        }])
                        .select();

                    if (createError) {
                        console.error('‚ùå Error creando billetera:', createError);
                        throw createError;
                    }
                    
                    console.log('‚úÖ Nueva billetera creada:', nuevaBilletera);
                    
                } else if (billeteraError) {
                    console.error('‚ùå Error buscando billetera:', billeteraError);
                    throw billeteraError;
                    
                } else {
                    // Billetera existe - ACTUALIZAR
                    console.log('üìä Billetera actual encontrada:', billetera);
                    
                    const creditoActual = parseFloat(billetera.credito_actual) || 0;
                    const creditoTotal = parseFloat(billetera.credito_total) || 0;
                    const creditoRetenido = parseFloat(billetera.credito_retenido) || 0;
                    const montoNum = parseFloat(monto);

                    const nuevoActual = creditoActual + montoNum;
                    const nuevoTotal = creditoTotal + montoNum;
                    // Reducir cr√©ditos retenidos (si los hay)
                    const nuevoRetenido = Math.max(0, creditoRetenido - montoNum);

                    console.log('üîÑ Actualizando billetera:', {
                        anterior: { actual: creditoActual, total: creditoTotal, retenido: creditoRetenido },
                        nuevo: { actual: nuevoActual, total: nuevoTotal, retenido: nuevoRetenido }
                    });

                    const { data: billeteraActualizada, error: updateError } = await supabase
                        .from('billetera')
                        .update({
                            credito_actual: nuevoActual,
                            credito_total: nuevoTotal,
                            credito_retenido: nuevoRetenido,
                            ultima_actualizacion: new Date().toISOString()
                        })
                        .eq('usuario_id', usuarioId)
                        .select();

                    if (updateError) {
                        console.error('‚ùå Error actualizando billetera:', updateError);
                        throw updateError;
                    }
                    
                    console.log('‚úÖ Billetera actualizada:', billeteraActualizada);
                }

            } catch (error) {
                console.error('‚ùå Error en actualizarBilleteraDevolucion:', error);
                throw error;
            }
        }

        function actualizarCreditosUI(nuevoSaldo) {
            console.log('üîÑ Actualizando UI con nuevo saldo:', nuevoSaldo);
            
            // Lista de todos los elementos que pueden mostrar cr√©ditos
            const creditElements = [
                'topCredits', 'currentBalance', 'saldoBadge', 
                'userCredits', 'creditos-disponibles'
            ];
            
            let elementosActualizados = 0;
            
            creditElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = nuevoSaldo;
                    elementosActualizados++;
                    console.log(`‚úÖ Actualizado elemento: ${id}`);
                }
            });
            
            // Actualizar localStorage
            localStorage.setItem('user_saldo', nuevoSaldo);
            
            console.log(`üìä Elementos actualizados: ${elementosActualizados}`);
            
            // Si no se actualiz√≥ ning√∫n elemento, mostrar advertencia
            if (elementosActualizados === 0) {
                console.warn('‚ö†Ô∏è No se encontraron elementos de cr√©ditos para actualizar');
            }
        }

        // ========== SISTEMA DE MENSAJER√çA ==========

        window.abrirChat = async function (intercambioId, tituloProducto, vendedorId) {
            intercambioActual = intercambioId;
            document.getElementById('tituloChat').textContent = `Chat: ${tituloProducto}`;
            document.getElementById('modalMensajes').style.display = 'flex';

            await cargarMensajes(intercambioId);
        }

        window.cerrarModalMensajes = function () {
            document.getElementById('modalMensajes').style.display = 'none';
            intercambioActual = null;
        }

        async function cargarMensajes(intercambioId) {
            try {
                const { data: mensajes, error } = await supabase
                    .from('Mensaje')
                    .select('*')
                    .eq('intercambio_id', intercambioId)
                    .order('fecha_envio', { ascending: true });

                if (error) throw error;

                const cuerpoMensajes = document.getElementById('cuerpoMensajes');
                cuerpoMensajes.innerHTML = '';

                if (mensajes && mensajes.length > 0) {
                    mensajes.forEach(mensaje => {
                        const esPropio = mensaje.emisor_id === currentUserId;
                        const mensajeDiv = document.createElement('div');
                        mensajeDiv.className = `mensaje ${esPropio ? 'mensaje-propio' : 'mensaje-otro'}`;
                        mensajeDiv.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 5px;">
                        ${esPropio ? 'T√∫' : 'Vendedor'}
                    </div>
                    <div>${mensaje.contenido}</div>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                        ${new Date(mensaje.fecha_envio).toLocaleString()}
                    </div>
                `;
                        cuerpoMensajes.appendChild(mensajeDiv);
                    });
                } else {
                    cuerpoMensajes.innerHTML = '<p style="text-align: center; color: #666;">No hay mensajes a√∫n. S√© el primero en escribir.</p>';
                }

                // Scroll al final
                cuerpoMensajes.scrollTop = cuerpoMensajes.scrollHeight;

            } catch (error) {
                console.error('Error cargando mensajes:', error);
            }
        }

        window.enviarMensaje = async function () {
            const input = document.getElementById('inputMensaje');
            const mensaje = input.value.trim();

            if (!mensaje || !intercambioActual) return;

            try {
                // Obtener el vendedor_id del intercambio
                const { data: intercambio, error } = await supabase
                    .from('Intercambio')
                    .select('usuario_vendedor_id')
                    .eq('id_intercambio', intercambioActual)
                    .single();

                if (error) throw error;

                const { error: insertError } = await supabase
                    .from('Mensaje')
                    .insert([{
                        contenido: mensaje,
                        fecha_envio: new Date(),
                        intercambio_id: intercambioActual,
                        emisor_id: currentUserId,
                        receptor_id: intercambio.usuario_vendedor_id
                    }]);

                if (insertError) throw insertError;

                input.value = '';
                await cargarMensajes(intercambioActual);

            } catch (error) {
                console.error('Error enviando mensaje:', error);
                alert('Error al enviar el mensaje');
            }
        }

        // ========== SISTEMA DE CALIFICACIONES ==========

        window.abrirModalCalificacion = function (intercambioId, productoTitulo) {
            intercambioActual = intercambioId;
            puntuacionSeleccionada = 0;

            document.getElementById('productoCalificar').textContent = productoTitulo;
            document.getElementById('comentarioCalificacion').value = '';

            // Resetear estrellas
            document.querySelectorAll('.estrella').forEach(star => {
                star.classList.remove('seleccionada');
            });

            document.getElementById('modalCalificacion').style.display = 'flex';

            // Configurar event listeners para estrellas
            document.querySelectorAll('.estrella').forEach(star => {
                star.onclick = function () {
                    puntuacionSeleccionada = parseInt(this.dataset.puntuacion);

                    // Actualizar visualizaci√≥n de estrellas
                    document.querySelectorAll('.estrella').forEach(s => {
                        s.classList.toggle('seleccionada', parseInt(s.dataset.puntuacion) <= puntuacionSeleccionada);
                    });
                };
            });
        }

        window.cerrarModalCalificacion = function () {
            document.getElementById('modalCalificacion').style.display = 'none';
            intercambioActual = null;
        }

        window.enviarCalificacion = async function () {
            if (puntuacionSeleccionada === 0) {
                alert('Por favor selecciona una puntuaci√≥n');
                return;
            }

            try {
                // Obtener datos del intercambio
                const { data: intercambio, error } = await supabase
                    .from('Intercambio')
                    .select('usuario_vendedor_id')
                    .eq('id_intercambio', intercambioActual)
                    .single();

                if (error) throw error;

                const comentario = document.getElementById('comentarioCalificacion').value.trim();

                // Insertar calificaci√≥n
                const { error: calificacionError } = await supabase
                    .from('calificacion')
                    .insert([{
                        puntuacion: puntuacionSeleccionada,
                        comentario: comentario || null,
                        fecha_calificacion: new Date(),
                        intercambio_id: intercambioActual,
                        calificador_id: currentUserId,
                        calificado_id: intercambio.usuario_vendedor_id
                    }]);

                if (calificacionError) throw calificacionError;

                alert('‚úÖ Calificaci√≥n enviada correctamente');
                cerrarModalCalificacion();
                cargarMisCompras(); // Recargar para actualizar la UI

            } catch (error) {
                console.error('Error enviando calificaci√≥n:', error);
                alert('Error al enviar la calificaci√≥n: ' + error.message);
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', cargarMisCompras);
    </script>
</body>
</html>
