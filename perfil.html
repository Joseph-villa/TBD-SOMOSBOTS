<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - Trueque Digital</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .pub-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
            transition: transform 0.2s;
        }
        .pub-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .pub-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .pub-credit {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #22c55e;
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.875rem;
        }
        .pub-content {
            padding: 15px;
        }
        .menu-dots {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            cursor: pointer;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .menu-opciones {
            position: absolute;
            top: 40px;
            left: 10px;
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            list-style: none;
            padding: 0;
            margin: 0;
            z-index: 20;
            min-width: 120px;
            display: none;
        }
        .menu-opciones.show {
            display: block;
        }
        .menu-opciones li {
            padding: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #4b5563;
        }
        .menu-opciones li:hover {
            background-color: #f3f4f6;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #6b7280;
        }
        .no-posts {
            grid-column: 1 / -1;
            text-align: center;
            padding: 50px;
            background-color: #f9fafb;
            border-radius: 12px;
            border: 1px dashed #e5e7eb;
        }
        #modalEmprendedor {
            display: none;
            align-items: center;
            justify-content: center;
        }
        .modal-visible {
            display: flex !important;
        }
        .star-rating {
            display: inline-flex;
            align-items: center;
        }
        .star {
            color: #d1d5db;
            margin-right: 2px;
        }
        .star.filled {
            color: #fbbf24;
        }
        .rating-average {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
        }
        .review-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #10b981;
        }
        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .review-comment {
            color: #4b5563;
            font-style: italic;
        }
        .no-reviews {
            text-align: center;
            padding: 40px;
            color: #6b7280;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px dashed #d1d5db;
        }
        /* --- estilos nuevos para reportes --- */
        .report-grid {
            display:flex;
            gap:12px;
            margin-top:12px;
            align-items:stretch;
            flex-wrap:wrap;
        }
        .report-card {
            flex:1 1 200px;
            display:flex;
            gap:12px;
            align-items:center;
            padding:14px;
            border-radius:12px;
            box-shadow:0 8px 24px rgba(15,23,42,0.06);
            border:1px solid rgba(15,23,42,0.04);
            background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,250,250,0.9));
            min-width:180px;
        }
        .report-card .icon {
            width:54px;
            height:54px;
            border-radius:10px;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:22px;
            color:white;
            flex-shrink:0;
        }
        .report-card .content { flex:1; }
        .report-card .label { font-size:0.9rem; color:#374151; margin-bottom:4px; }
        .report-card .value { font-size:1.4rem; font-weight:800; color:#0f5132; }
        .report-card .unit { font-size:0.85rem; color:#6b7280; margin-left:6px; }

        /* colores espec√≠ficos */
        .report-co2 .icon { background: linear-gradient(135deg,#20bf6b,#0ea45f); }
        .report-agua .icon { background: linear-gradient(135deg,#60a5fa,#3b82f6); }
        .report-energia .icon { background: linear-gradient(135deg,#ffd166,#ffb020); }

        @media (max-width:640px){
            .report-grid { flex-direction:column; }
        }

        /* --- subt√≠tulo bonito para "Reportes" --- */
        .reports-subtitle {
            display:flex;
            align-items:center;
            gap:12px;
            margin:0 0 12px 0;
            font-size:1rem;
            font-weight:700;
            color:#111827;
            letter-spacing:0.2px;
        }
        .reports-subtitle .decor {
            width:44px;
            height:8px;
            border-radius:8px;
            background:linear-gradient(90deg,#10b981 0%,#06b6d4 100%);
            box-shadow:0 6px 18px rgba(6,182,150,0.12);
            flex-shrink:0;
        }
        .reports-subtitle .label-small {
            font-size:0.85rem;
            font-weight:600;
            color:#374151;
        }
        .reports-subtitle .hint {
            font-size:0.85rem;
            color:#6b7280;
            font-weight:500;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="flex justify-between items-center mb-6">
            <button id="backBtn" class="text-green-600 hover:text-green-800 transition duration-150">
                <i class="fas fa-arrow-left mr-2"></i> Volver al Dashboard
            </button>
            <h1 class="text-3xl font-extrabold text-gray-800">Mi Perfil</h1>
            <button id="logoutBtn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-150">
                <i class="fas fa-sign-out-alt"></i> Salir
            </button>
        </header>

        <!-- Secci√≥n de Datos del Usuario -->
        <section class="bg-white rounded-xl shadow-lg p-6 mb-8 border-t-4 border-green-500">
            <div class="flex items-center space-x-6">
                <div class="flex-shrink-0">
                    <div class="w-16 h-16 bg-green-200 rounded-full flex items-center justify-center text-green-700 text-3xl font-bold">
                        <i class="fas fa-user-circle"></i>
                    </div>
                </div>
                <div class="flex-1">
                    <h2 id="profileName" class="text-2xl font-bold text-gray-900">Cargando Nombre...</h2>
                    <p id="profileEmail" class="text-gray-500 text-sm">Cargando Correo...</p>
                    <div class="mt-2 flex items-center space-x-4">
                        <span class="px-3 py-1 bg-yellow-100 text-yellow-800 font-semibold text-sm rounded-full">
                            Saldo: <span id="saldoBadge">0 ‚ôªÔ∏è</span>
                        </span>
                        <button id="recargarBtn" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            Recargar Cr√©ditos
                        </button>
                    </div>
                </div>
                
                <!-- Secci√≥n de Calificaci√≥n Promedio -->
                <div class="text-center border-l pl-6 border-gray-200">
                    <div class="rating-average" id="ratingAverage">0.0</div>
                    <div class="star-rating mt-1" id="starRating">
                        <span class="star">‚òÖ</span>
                        <span class="star">‚òÖ</span>
                        <span class="star">‚òÖ</span>
                        <span class="star">‚òÖ</span>
                        <span class="star">‚òÖ</span>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">
                        <span id="reviewCount">0</span> rese√±a(s)
                    </p>
                </div>
            </div>
            
            <!-- Bot√≥n de Solicitud de Emprendedor -->
            <div class="mt-6 pt-4 border-t border-gray-100">
                <div id="emprendedorSection" class="p-4 bg-green-50 rounded-lg border border-green-200">
                    <h3 class="text-lg font-semibold text-green-800 mb-2 flex items-center">
                        <i class="fas fa-store mr-2"></i> Estado de Emprendedor
                    </h3>
                    <p id="emprendedorStatus" class="text-gray-700 mb-4">
                        Puedes postularte para obtener el rol de "Emprendedor" y empezar a monetizar.
                    </p>
                    <button 
                        id="btnSolicitarEmprendedor"
                        class="px-4 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition duration-200 shadow-md text-sm">
                        <i class="fas fa-handshake mr-1"></i> Solicitar Rol
                    </button>
                </div>
            </div>
        </section>

        <!-- Secci√≥n de Estad√≠sticas -->
        <section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white rounded-xl shadow p-4 text-center">
                <p class="text-3xl font-extrabold text-green-600" id="pubCount">0</p>
                <p class="text-gray-500 text-sm">Publicaciones Activas</p>
            </div>
            <div class="bg-white rounded-xl shadow p-4 text-center">
                <p class="text-3xl font-extrabold text-green-600" id="vendidosCount">0</p>
                <p class="text-gray-500 text-sm">Cr√©ditos Generados</p>
            </div>
            <div class="bg-white rounded-xl shadow p-4 text-center">
                <p class="text-3xl font-extrabold text-green-600" id="totalReviews">0</p>
                <p class="text-gray-500 text-sm">Rese√±as Recibidas</p>
            </div>
            <div class="bg-white rounded-xl shadow p-4 text-center">
                <p class="text-3xl font-extrabold text-green-600" id="avgRating">0.0</p>
                <p class="text-gray-500 text-sm">Calificaci√≥n Promedio</p>
            </div>
        </section>

        <!-- Secci√≥n de Rese√±as y Calificaciones -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-star mr-2 text-yellow-500"></i> Mis Rese√±as
            </h2>
            <div id="reviewsContainer" class="space-y-4">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> Cargando rese√±as...
                </div>
            </div>
        </section>

        <!-- Mis Publicaciones -->
        <section class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Mis Publicaciones</h2>
                <button id="openFormBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-150">
                    <i class="fas fa-plus"></i> Crear Nueva
                </button>
            </div>
            <div id="userPostsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Las publicaciones se renderizar√°n aqu√≠ -->
            </div>
        </section>

        <!-- Reporte de Ahorros (solo emprendedores) -->
        <div id="reportSection" style="display:none;">
            <h3 class="reports-subtitle">
                <span class="decor" aria-hidden="true"></span>
                <span class="label-small">Reportes</span>
                <span class="hint">Resumen de ahorros del vendedor</span>
            </h3>
            <div class="report-grid">
                <div class="report-card report-co2" title="CO2 ahorrado">
                    <div class="icon"><i class="fas fa-seedling"></i></div>
                    <div class="content">
                        <div class="label">CO2 ahorrado</div>
                        <div>
                            <span class="value" id="reportCo2">0</span>
                            <span class="unit">kg</span>
                        </div>
                    </div>
                </div>

                <div class="report-card report-agua" title="Agua ahorrada">
                    <div class="icon"><i class="fas fa-tint"></i></div>
                    <div class="content">
                        <div class="label">Agua ahorrada</div>
                        <div>
                            <span class="value" id="reportAgua">0</span>
                            <span class="unit">L</span>
                        </div>
                    </div>
                </div>

                <div class="report-card report-energia" title="Energ√≠a ahorrada">
                    <div class="icon"><i class="fas fa-bolt"></i></div>
                    <div class="content">
                        <div class="label">Energ√≠a ahorrada</div>
                        <div>
                            <span class="value" id="reportEnergia">0</span>
                            <span class="unit">kWh</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PARA SOLICITUD DE EMPRENDEDOR -->
    <div id="modalEmprendedor" class="fixed inset-0 bg-gray-900 bg-opacity-70 items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 m-4 transform transition-transform duration-300 scale-95 opacity-0" id="modalContent">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                <i class="fas fa-rocket mr-2 text-green-600"></i> Postulaci√≥n Emprendedor
            </h2>
            
            <form id="formSolicitudEmprendedor">
                <div class="mb-4">
                    <label for="nombreNegocio" class="block text-sm font-medium text-gray-700">Nombre del Negocio / Marca <span class="text-red-500">*</span></label>
                    <input type="text" id="nombreNegocio" required
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500">
                </div>

                <div class="mb-4">
                    <label for="descripcionNegocio" class="block text-sm font-medium text-gray-700">Describe tu modelo sostenible y por qu√© usas el trueque <span class="text-red-500">*</span></label>
                    <textarea id="descripcionNegocio" rows="3" required
                              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"></textarea>
                </div>

                <div class="mb-4">
                    <label for="productosServicios" class="block text-sm font-medium text-gray-700">Productos o Servicios Principales a Ofrecer <span class="text-red-500">*</span></label>
                    <textarea id="productosServicios" rows="2" required
                              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"></textarea>
                </div>

                <div class="mb-6">
                    <label for="urlContacto" class="block text-sm font-medium text-gray-700">Sitio Web / Red Social (Opcional)</label>
                    <input type="url" id="urlContacto" 
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500">
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" id="btnCerrarModal"
                            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition duration-150">
                        Cancelar
                    </button>
                    <button type="submit"
                            class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition duration-150">
                        Enviar Postulaci√≥n
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { supabase } from './config/db.js';

        async function fetchUsuarioByIdOrAuth(id) {
            if (!id) return null;
            let { data, error } = await supabase
                .from('usuario')
                .select('*')
                .eq('id_usuario', id)
                .maybeSingle();
            if (data) return data;

            const res = await supabase
                .from('usuario')
                .select('*')
                .eq('auth_id', id)
                .maybeSingle();
            return res.data || null;
        }

        async function fetchReviewsForUser(targetId) {
            const candidates = ['Resena','Resenas','rese√±a','rese√±as','Review','reviews','Valoracion','valoraciones','calificacion'];
            for (const tbl of candidates) {
                try {
                    const { data, error } = await supabase
                        .from(tbl)
                        .select('*')
                        .eq('usuario_id', targetId)
                        .order('fecha', { ascending: false });
                    if (!error && Array.isArray(data)) return data;
                } catch (e) {
                    console.warn(`Tabla ${tbl} no disponible o error al consultarla.`);
                }
            }
            return [];
        }

        function renderReviewsList(reviews, authorsMap) {
            const container = document.getElementById('userReviews');
            if (!container) return;
            if (!reviews || reviews.length === 0) {
                container.innerHTML = '<div class="no-reviews">Este usuario no tiene rese√±as.</div>';
                return;
            }

            container.innerHTML = reviews.map(r => {
                const rating = r.calificacion ?? r.rating ?? r.puntuacion ?? '';
                const comment = r.comentario ?? r.contenido ?? r.mensaje ?? '';
                const date = r.fecha ? new Date(r.fecha).toLocaleString() : (r.created_at ? new Date(r.created_at).toLocaleString() : '');
                const autorId = r.emisor_id ?? r.revisor_id ?? r.usuario_emisor ?? r.autor_id;
                const autorNombre = authorsMap[autorId] || 'An√≥nimo';

                return `
                    <div class="review-card" style="background:white;padding:12px;border-radius:8px;border:1px solid #eee;">
                        <div class="review-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <div style="font-weight:700;">${autorNombre}</div>
                            <div style="color:#ffb400;font-weight:700;">${rating ? '‚òÖ '.repeat(Math.round(rating)) + (rating ? ` (${rating})` : '') : ''}</div>
                        </div>
                        <div class="review-comment" style="color:#444;">${comment ? comment : '<i>Sin comentario</i>'}</div>
                        <div style="font-size:0.8rem;color:#888;margin-top:8px;">${date}</div>
                    </div>
                `;
            }).join('');
        }

        async function fetchAuthorsMap(emisorIds) {
            if (!emisorIds || emisorIds.length === 0) return {};
            const uniq = [...new Set(emisorIds)];
            const { data } = await supabase
                .from('usuario')
                .select('id_usuario,nombre_completo,auth_id')
                .in('id_usuario', uniq);
            const map = {};
            (data || []).forEach(u => {
                map[u.id_usuario || u.auth_id] = u.nombre_completo || 'Usuario';
            });
            return map;
        }

        async function fetchAndRenderSavings(targetIdForQuery, showIfNotEmprendedor = false) {
            const reportCo2El = document.getElementById('reportCo2');
            const reportAguaEl = document.getElementById('reportAgua');
            const reportEnergiaEl = document.getElementById('reportEnergia');
            const reportSection = document.getElementById('reportSection');
            if (!reportCo2El || !reportAguaEl || !reportEnergiaEl || !reportSection) return;

            // Obtener publicaciones y sumar en cliente (m√°s fiable que agregados postgrest si no se configuran)
            const { data: pubs, error } = await supabase
                .from('Publicacion')
                .select('ahorro_co2,ahorro_agua,ahorro_energia,estado')
                .eq('usuario_id', targetIdForQuery);

            if (error) {
                console.warn('Error al cargar publicaciones para calcular ahorros:', error);
                reportSection.style.display = 'none';
                return;
            }

            const items = pubs || [];
            const totals = items.reduce((acc, p) => {
                acc.co2 += Number(p.ahorro_co2) || 0;
                acc.agua += Number(p.ahorro_agua) || 0;
                acc.energia += Number(p.ahorro_energia) || 0;
                return acc;
            }, { co2: 0, agua: 0, energia: 0 });

            reportCo2El.textContent = totals.co2.toFixed(2);
            reportAguaEl.textContent = totals.agua.toFixed(2);
            reportEnergiaEl.textContent = totals.energia.toFixed(2);

            // Mostrar solo si el usuario es emprendedor (o si forced show)
            if (showIfNotEmprendedor) reportSection.style.display = 'flex';
        }

        (async function() {
            try {
                const params = new URLSearchParams(window.location.search);
                const usuarioIdParam = params.get('usuario_id') || params.get('user_id');

                let targetUsuario = null;
                if (usuarioIdParam) {
                    targetUsuario = await fetchUsuarioByIdOrAuth(usuarioIdParam);
                }

                if (!targetUsuario) {
                    const { data: authRes } = await supabase.auth.getUser();
                    const currentAuth = authRes?.user;
                    if (!currentAuth) {
                        document.getElementById('profileName').textContent = 'Usuario no encontrado';
                        document.getElementById('profileEmail').textContent = '';
                        document.getElementById('userReviews').innerHTML = '<div class="no-reviews">No se encontr√≥ usuario.</div>';
                        return;
                    }
                    targetUsuario = await fetchUsuarioByIdOrAuth(currentAuth.id);
                }

                if (!targetUsuario) {
                    document.getElementById('profileName').textContent = 'Usuario no encontrado';
                    document.getElementById('profileEmail').textContent = '';
                    document.getElementById('userReviews').innerHTML = '<div class="no-reviews">No se encontr√≥ usuario.</div>';
                    return;
                }

                // Mostrar s√≥lo nombre y correo
                document.getElementById('profileName').textContent = targetUsuario.nombre_completo || targetUsuario.nombre || 'Sin nombre';
                document.getElementById('profileEmail').textContent = targetUsuario.correo_electronico || targetUsuario.email || '';

                if (targetUsuario.avatar_url) {
                    const avatar = document.getElementById('profileAvatar');
                    if (avatar) avatar.src = targetUsuario.avatar_url;
                }

                // Calcular y mostrar ahorros solo si el usuario es emprendedor
                const targetIdForQuery = targetUsuario.auth_id ?? targetUsuario.id_usuario ?? targetUsuario.id;
                const isEmprendedor = (String(targetUsuario.rol || '').toLowerCase().includes('emprendedor'));
                if (isEmprendedor) {
                    await fetchAndRenderSavings(targetIdForQuery, true);
                    document.getElementById('reportSection').style.display = 'flex';
                } else {
                    // ocultar secci√≥n si no es emprendedor
                    document.getElementById('reportSection').style.display = 'none';
                }

                // Cargar rese√±as
                const reviews = await fetchReviewsForUser(targetIdForQuery);
                const emisorIds = (reviews || []).map(r => r.emisor_id ?? r.revisor_id ?? r.autor_id).filter(Boolean);
                const authorsMap = await fetchAuthorsMap(emisorIds);
                renderReviewsList(reviews, authorsMap);

            } catch (err) {
                console.error('Error cargando perfil (solo nombre/email/rese√±as):', err);
                document.getElementById('profileName').textContent = 'Error cargando perfil';
                document.getElementById('profileEmail').textContent = '';
                document.getElementById('userReviews').innerHTML = '<div class="no-reviews">Error al cargar rese√±as.</div>';
            }
        })();
    </script>
    <script type="module">
        import { supabase } from './config/db.js';

        // --- Elementos del DOM ---
        const backBtn = document.getElementById('backBtn');
        const openFormBtn = document.getElementById('openFormBtn');
        const userPostsGrid = document.getElementById('userPostsGrid');
        const profileName = document.getElementById('profileName');
        const profileEmail = document.getElementById('profileEmail');
        const saldoBadge = document.getElementById('saldoBadge');
        const pubCount = document.getElementById('pubCount');
        const vendidosCount = document.getElementById('vendidosCount');
        const logoutBtn = document.getElementById('logoutBtn');
        const recargarBtn = document.getElementById('recargarBtn');
        const emprendedorStatusDiv = document.getElementById('emprendedorSection');
        const btnSolicitarEmprendedor = document.getElementById('btnSolicitarEmprendedor');
        const modalEmprendedor = document.getElementById('modalEmprendedor');
        const modalContent = document.getElementById('modalContent');
        const btnCerrarModal = document.getElementById('btnCerrarModal');
        const formSolicitudEmprendedor = document.getElementById('formSolicitudEmprendedor');
        
        // Nuevos elementos para calificaciones
        const ratingAverage = document.getElementById('ratingAverage');
        const starRating = document.getElementById('starRating');
        const reviewCount = document.getElementById('reviewCount');
        const reviewsContainer = document.getElementById('reviewsContainer');
        const totalReviews = document.getElementById('totalReviews');
        const avgRating = document.getElementById('avgRating');

        let currentUserId = null;
        let currentUserRol = 'Usuario';

        // ---------------------------------------------------
        // --- FUNCIONES PARA CALIFICACIONES Y RESE√ëAS ---
        // ---------------------------------------------------

        function renderStars(rating, container) {
            const stars = container.querySelectorAll('.star');
            stars.forEach((star, index) => {
                if (index < Math.floor(rating)) {
                    star.classList.add('filled');
                } else if (index < rating) {
                    star.classList.add('filled');
                } else {
                    star.classList.remove('filled');
                }
            });
        }

        async function loadUserRatings() {
            if (!currentUserId) return;

            try {
                const { data: ratings, error } = await supabase
                    .from('calificacion')
                    .select(`
                        puntuacion,
                        comentario,
                        fecha_calificacion,
                        calificador_id,
                        usuario:calificador_id(nombre_completo)
                    `)
                    .eq('calificado_id', currentUserId)
                    .order('fecha_calificacion', { ascending: false });

                if (error) throw error;

                const reviews = ratings || [];
                const total = reviews.length;
                
                const average = total > 0 
                    ? (reviews.reduce((sum, review) => sum + review.puntuacion, 0) / total).toFixed(1)
                    : 0;

                reviewCount.textContent = total;
                totalReviews.textContent = total;
                ratingAverage.textContent = average;
                avgRating.textContent = average;

                renderStars(average, starRating);
                renderReviews(reviews);

            } catch (error) {
                console.error('Error al cargar calificaciones:', error);
                reviewsContainer.innerHTML = `
                    <div class="no-reviews">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>Error al cargar las rese√±as</p>
                    </div>
                `;
            }
        }

        function renderReviews(reviews) {
            if (reviews.length === 0) {
                reviewsContainer.innerHTML = `
                    <div class="no-reviews">
                        <i class="fas fa-star text-2xl mb-2"></i>
                        <h3 class="text-lg font-semibold mb-2">A√∫n no tienes rese√±as</h3>
                        <p class="text-gray-600">Las rese√±as aparecer√°n aqu√≠ cuando otros usuarios te califiquen despu√©s de realizar intercambios.</p>
                    </div>
                `;
                return;
            }

            reviewsContainer.innerHTML = reviews.map(review => `
                <div class="review-card">
                    <div class="review-header">
                        <div class="star-rating">
                            ${Array.from({length: 5}, (_, i) => 
                                `<span class="star ${i < review.puntuacion ? 'filled' : ''}">‚òÖ</span>`
                            ).join('')}
                        </div>
                        <span class="text-sm text-gray-500">
                            ${new Date(review.fecha_calificacion).toLocaleDateString('es-ES')}
                        </span>
                    </div>
                    <div class="review-comment">
                        "${review.comentario || 'Sin comentario'}"
                    </div>
                    <div class="text-sm text-gray-600 mt-2">
                        - ${review.usuario?.nombre_completo || 'Usuario'}
                    </div>
                </div>
            `).join('');
        }

        // ---------------------------------------------------
        // --- FUNCIONES EXISTENTES DEL PERFIL ---
        // ---------------------------------------------------

        function mostrarFormularioEmprendedor() {
            modalEmprendedor.classList.add('modal-visible');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function cerrarFormularioEmprendedor() {
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modalEmprendedor.classList.remove('modal-visible');
                formSolicitudEmprendedor.reset();
            }, 300); 
        }

        async function verificarEstadoEmprendedor(userId) {
            if (currentUserRol === 'Emprendedor') {
                emprendedorStatusDiv.innerHTML = `
                    <h3 class="text-lg font-semibold text-green-700 mb-2 flex items-center">
                        <i class="fas fa-award mr-2"></i> Rol: Emprendedor Certificado
                    </h3>
                    <p class="text-gray-700">¬°Felicidades! Tienes permiso para crear ofertas de monetizaci√≥n.</p>
                `;
                return;
            }

            const { data, error } = await supabase
                .from('perfil_emprendedor')
                .select('estado_solicitud')
                .eq('usuario_id', userId)
                .order('fecha_solicitud', { ascending: false })
                .limit(1)
                .single();

            if (error && error.code !== 'PGRST116') {
                console.error('Error al verificar solicitud:', error.message);
            }

            if (data && data.estado_solicitud === 'pendiente') {
                btnSolicitarEmprendedor.disabled = true;
                btnSolicitarEmprendedor.classList.remove('bg-green-600', 'hover:bg-green-700');
                btnSolicitarEmprendedor.classList.add('bg-gray-400', 'cursor-not-allowed');
                btnSolicitarEmprendedor.innerHTML = '<i class="fas fa-clock mr-1"></i> Solicitud Pendiente';
                document.getElementById('emprendedorStatus').textContent = 'Tu solicitud de emprendedor est√° siendo revisada por el administrador.';
            }
        }

        async function enviarSolicitudEmprendedor(event) {
            event.preventDefault();

            if (!currentUserId) {
                alert("Debes iniciar sesi√≥n para enviar una solicitud.");
                return;
            }

            const nombreNegocio = document.getElementById('nombreNegocio').value.trim();
            const descripcion = document.getElementById('descripcionNegocio').value.trim();
            const productos = document.getElementById('productosServicios').value.trim();
            const urlContacto = document.getElementById('urlContacto').value.trim();

            if (!nombreNegocio || !descripcion || !productos) {
                alert("Por favor, completa todos los campos obligatorios.");
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('perfil_emprendedor')
                    .insert({
                        usuario_id: currentUserId,
                        nombre_negocio: nombreNegocio,
                        descripcion_negocio: descripcion,
                        productos_servicios: productos,
                        url_contacto: urlContacto,
                        estado_solicitud: 'pendiente'
                    });

                if (error) throw error;

                alert('‚úÖ Solicitud enviada con √©xito. Recibir√°s una notificaci√≥n cuando sea aprobada.');
                
                cerrarFormularioEmprendedor();
                currentUserRol = 'Usuario'; 
                verificarEstadoEmprendedor(currentUserId);

            } catch (error) {
                console.error('Error al enviar solicitud de emprendedor:', error);
                alert('‚ùå Error al enviar la solicitud: ' + error.message);
            }
        }

        async function loadCreditosGenerados() {
            if (!currentUserId) {
                vendidosCount.textContent = '0';
                return;
            }

            try {
                const { data, error } = await supabase.rpc('get_creditos_generados', {
                    p_usuario_id: currentUserId
                });

                if (error) {
                    console.error('Error al cargar cr√©ditos generados:', error);
                    vendidosCount.textContent = 'Error';
                    return;
                }

                const totalGenerado = data !== null ? data : 0;
                vendidosCount.textContent = totalGenerado.toLocaleString('es-BO', { maximumFractionDigits: 0 }); 

            } catch (error) {
                console.error('Error en loadCreditosGenerados:', error);
                vendidosCount.textContent = 'Error';
            }
        }

        async function loadUserData() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    console.log('Debes iniciar sesi√≥n para ver tu perfil');
                    window.location.href = 'index.html';
                    return;
                }

                currentUserId = user.id;

                const { data: usuario, error } = await supabase
                    .from('usuario')
                    .select('*')
                    .eq('auth_id', user.id)
                    .single();

                if (error) throw error;

                if (usuario) {
                    profileName.textContent = usuario.nombre_completo || 'Usuario';
                    profileEmail.textContent = usuario.correo_electronico || user.email;
                    
                    const saldo = usuario.saldo_creditos || 0;
                    saldoBadge.textContent = `${saldo} ‚ôªÔ∏è`;
                    localStorage.setItem('user_saldo', saldo);
                    
                    currentUserRol = usuario.rol || 'Usuario'; 
                    localStorage.setItem('user_rol', currentUserRol); 
                    
                    verificarEstadoEmprendedor(currentUserId);
                } 

            } catch (error) {
                console.error('Error al cargar datos del usuario:', error);
                const userName = localStorage.getItem('user_name') || 'Usuario';
                const userEmail = localStorage.getItem('user_email') || '';
                const userSaldo = localStorage.getItem('user_saldo') || '0';
                
                profileName.textContent = userName;
                profileEmail.textContent = userEmail;
                saldoBadge.textContent = `${userSaldo} ‚ôªÔ∏è`;
            }
        }

        async function fetchUserPosts() {
            if (!currentUserId) {
                console.log('No hay currentUserId, no se pueden cargar publicaciones');
                return;
            }

            userPostsGrid.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Cargando publicaciones...</div>';
            
            try {
                const { data: posts, error } = await supabase
                    .from('Publicacion')
                    .select('*')
                    .eq('usuario_id', currentUserId)
                    .order('id_publicacion', { ascending: false });

                if (error) throw error;
                
                renderPostsGrid(posts || []);
                updateStats(posts || []);

            } catch (err) {
                console.error('Error completo al cargar publicaciones:', err);
                userPostsGrid.innerHTML = `
                    <div class="no-posts">
                        <h3>‚ùå Error al cargar las publicaciones</h3>
                        <p>${err.message}</p>
                        <button onclick="window.location.href='publicar.html'" 
                                class="btn-publicar" style="margin-top: 15px;">
                            <i class="fas fa-plus"></i>
                            Intentar Crear Publicaci√≥n
                        </button>
                    </div>
                `;
            }
        }

        function renderPostsGrid(posts) {
            userPostsGrid.innerHTML = '';
            
            if (posts.length === 0) {
                userPostsGrid.innerHTML = `
                    <div class="no-posts">
                        <h3>üì≠ A√∫n no tienes publicaciones</h3>
                        <p>Comienza tu journey en el trueque digital creando tu primera publicaci√≥n</p>
                        <button onclick="window.location.href='publicar.html'" 
                                class="btn-publicar" style="margin-top: 20px;">
                            <i class="fas fa-plus"></i>
                            Crear Mi Primera Publicaci√≥n
                        </button>
                    </div>
                `;
            } else {
                posts.forEach(p => {
                    const card = document.createElement('div');
                    card.className = 'pub-card';
                    card.dataset.id = p.id_publicacion;
                    
                    const titulo = p.titulo || p.description || 'Sin t√≠tulo';
                    const descripcion = p.descripcion || p.meaning_of_text || 'Sin descripci√≥n';
                    const precio = p.precio || p.private || 0;
                    const categoria = p.nombre_categoria || p.mention_anticipator || 'General';
                    const imagen = p.imagen_url || p.images_url || null;
                    
                    card.innerHTML = `
                        ${imagen ? `
                            <img src="${imagen}" alt="${titulo}" 
                                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                        ` : `
                            <div style="width: 100%; height: 200px; background: linear-gradient(135deg, #f0f3f0 0%, #e6f4ea 100%); 
                                        display: flex; align-items: center; justify-content: center; color: #999;">
                                <i class="fas fa-image" style="font-size: 3rem;"></i>
                            </div>
                        `}
                        
                        <div class="pub-credit">${precio} ‚ôªÔ∏è</div>
                        
                        <div class="menu-dots" data-id="${p.id_publicacion}">
                            <i class="fas fa-ellipsis-v"></i>
                        </div>
                        
                        <ul class="menu-opciones" id="menu-${p.id_publicacion}">
                            <li data-action="edit" data-id="${p.id_publicacion}">
                                <i class="fas fa-edit"></i> Editar
                            </li>
                            <li data-action="delete" data-id="${p.id_publicacion}" style="color: #f44336;">
                                <i class="fas fa-trash"></i> Eliminar
                            </li>
                        </ul>

                        <div class="pub-content">
                            <strong>${titulo}</strong>
                            <p>${descripcion}</p>
                            <small>
                                <i class="fas fa-tag"></i> Categor√≠a: ${categoria}
                            </small>
                        </div>
                    `;
                    userPostsGrid.appendChild(card);
                });
            }
        }

        function updateStats(posts) {
            pubCount.textContent = posts.length;
        }

        async function handleDeletePost(postId) {
            if (!window.confirm('¬øEst√°s seguro de que quieres eliminar esta publicaci√≥n? Esta acci√≥n es irreversible.')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('Publicacion')
                    .delete()
                    .eq('id_publicacion', postId)
                    .eq('usuario_id', currentUserId);

                if (error) throw error;

                alert('‚úÖ Publicaci√≥n eliminada con √©xito.');
                fetchUserPosts();

            } catch (err) {
                console.error('Error al eliminar publicaci√≥n:', err);
                alert('‚ùå Error al eliminar la publicaci√≥n.');
            }
        }

        async function handleLogout() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;

                localStorage.removeItem('user_id');
                localStorage.removeItem('user_email');
                localStorage.removeItem('user_name');
                localStorage.removeItem('user_saldo');
                localStorage.removeItem('user_rol');

                alert('Sesi√≥n cerrada correctamente');
                window.location.href = 'index.html?logout=true';

            } catch (error) {
                console.error('Error al cerrar sesi√≥n:', error);
                alert('Error al cerrar sesi√≥n');
            }
        }

        // --- Event Listeners ---
        backBtn.addEventListener('click', () => {
            window.location.href = 'index2.html';
        });

        openFormBtn.addEventListener('click', () => {
            window.location.href = 'publicar.html';
        });

        logoutBtn.addEventListener('click', handleLogout);

        recargarBtn.addEventListener('click', () => {
            window.location.href = 'compra.html';
        });

        btnSolicitarEmprendedor.addEventListener('click', mostrarFormularioEmprendedor);
        btnCerrarModal.addEventListener('click', cerrarFormularioEmprendedor);
        formSolicitudEmprendedor.addEventListener('submit', enviarSolicitudEmprendedor);

        userPostsGrid.addEventListener('click', function(event) {
            const target = event.target;
            const menuDots = target.closest('.menu-dots');
            const menuItem = target.closest('li[data-action]');
            
            if (menuDots) {
                const postId = menuDots.dataset.id;
                const menu = document.getElementById(`menu-${postId}`);
                
                document.querySelectorAll('.menu-opciones.show').forEach(m => {
                    if (m.id !== `menu-${postId}`) m.classList.remove('show');
                });

                menu.classList.toggle('show');
            }

            if (menuItem) {
                const action = menuItem.dataset.action;
                const postId = menuItem.dataset.id;

                menuItem.closest('.menu-opciones').classList.remove('show');

                if (action === 'delete') {
                    handleDeletePost(postId);
                } else if (action === 'edit') {
                    window.location.href = `editar.html?id=${postId}`;
                }
            }
        });

        document.addEventListener('click', function(event) {
            if (!event.target.closest('.menu-dots') && !event.target.closest('.menu-opciones')) {
                document.querySelectorAll('.menu-opciones.show').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
            
            if (modalEmprendedor.classList.contains('modal-visible') && !modalContent.contains(event.target) && !btnSolicitarEmprendedor.contains(event.target)) {
                cerrarFormularioEmprendedor();
            }
        });

        // Inicializar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', async () => {
            modalEmprendedor.classList.remove('modal-visible');

            await loadUserData(); 
            await fetchUserPosts();
            await loadCreditosGenerados();
            await loadUserRatings();
        });
    </script>
</body>
</html>