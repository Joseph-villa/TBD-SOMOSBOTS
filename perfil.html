<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ver Perfil</title>
  <link rel="stylesheet" href="styles/estilos.css">

  <style>
    /* Estilo general */
    body {
        font-family: 'Arial', sans-serif;
        background-color: #f9f9f9;
        margin: 0;
        padding: 0;
        color: #333;
    }

    .perfil-container {
        max-width: 800px;
        margin: 40px auto;
        padding: 24px;
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    h2 {
        color: #2F9A34;
        font-size: 1.8rem;
        margin-bottom: 8px;
    }

    h3 {
        color: #2F9A34;
        font-size: 1.4rem;
        margin-bottom: 16px;
    }

    p {
        margin: 0;
        font-size: 1rem;
        color: #555;
    }

    /* Estilo para el bot√≥n "Volver" */
    .back-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 8px 16px;
        background-color: #2F9A34; /* Verde principal */
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        transition: background-color 0.3s ease, box-shadow 0.2s ease;
    }

    .back-btn:hover {
        background-color: #036d19; /* Verde m√°s oscuro */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .back-btn:active {
        background-color: #025a14; /* Verde a√∫n m√°s oscuro */
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* Estilo para la informaci√≥n del perfil */
    .perfil-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 1rem;
        margin-bottom: 24px;
    }

    .perfil-info {
        display: flex;
        justify-content: center;
        gap: 1rem;
    }

    .perfil-detalle h2 {
        margin: 0;
        font-size: 1.5rem;
        color: #2F9A34;
    }

    .perfil-detalle p {
        font-size: 1rem;
        color: #666;
    }

    .perfil-saldo {
        text-align: center;
        margin-top: 16px;
    }

    .saldo-badge {
        display: inline-block;
        padding: 8px 16px;
        background-color: #e8f5e9;
        color: #2F9A34;
        font-weight: bold;
        border-radius: 8px;
        font-size: 1.2rem;
    }

    .historial-link {
        display: inline-block;
        margin-top: 8px;
        color: #2F9A34;
        text-decoration: none;
        font-weight: 600;
        font-size: 1rem;
    }

    .historial-link:hover {
        text-decoration: underline;
    }

    /* Estilo para las publicaciones */
    .perfil-publicaciones {
        margin-top: 24px;
    }

    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 16px;
        margin-top: 16px;
    }

    .pub-card {
        background-color: #ffffff;
        border: 1px solid #e6e6e6;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .pub-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .pub-card img {
        width: 100%;
        height: 150px;
        object-fit: cover;
    }

    .pub-card div {
        padding: 12px;
    }

    .pub-card strong {
        display: block;
        font-size: 1.1rem;
        color: #333;
        margin-bottom: 8px;
    }

    .pub-card p {
        font-size: 0.9rem;
        color: #666;
        margin: 0;
    }

    .pub-credit {
        display: inline-block;
        padding: 4px 8px;
        background-color: #e8f5e9;
        color: #2F9A34;
        font-weight: bold;
        border-radius: 6px;
        font-size: 0.9rem;
        margin-top: 8px;
    }

    /* Men√∫ de opciones */
    .menu-dots {
        position: absolute;
        top: 8px;
        right: 8px;
        cursor: pointer;
        font-size: 1.2rem;
        color: #666;
    }

    .menu-opciones {
        display: none;
        position: absolute;
        top: 32px;
        right: 8px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        list-style: none;
        padding: 8px 0;
        z-index: 10;
    }

    .menu-opciones li {
        padding: 8px 16px;
        font-size: 0.9rem;
        color: #333;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .menu-opciones li:hover {
        background-color: #f9f9f9;
    }

    .menu-opciones.show {
        display: block;
    }
  </style>
</head>

<body class="perfil-body">
  <section class="perfil-container">
    <!-- Flecha para volver -->
    <button class="back-btn" id="backBtn" title="Volver">‚Üê Volver</button>

    <!-- Encabezado del perfil -->
    <div class="perfil-header">
      <div class="perfil-info">
        <div class="perfil-detalle">
          <h2 id="profileName"></h2>
          <p class="publicaciones" id="pubCounts">0 Publicaciones ¬∑ 0 Vendidos</p>
        </div>
      </div>

      <div class="perfil-saldo">
        <p><strong>Saldo</strong></p>
        <div class="saldo-badge" id="saldoBadge">0 ‚ôªÔ∏è</div>
        <a href="historial.html" class="historial-link">Ver Historial de Compras/Ventas</a>
      </div>

    </div>

    <!-- Publicaciones -->
    <div class="perfil-publicaciones">
      <h3>Publicaciones</h3>
    </div>

    <!-- Galer√≠a de publicaciones (renderizado por JS) -->
    <div class="grid publicaciones-grid" id="userPostsGrid">
      <!-- JS insertar√° las tarjetas aqu√≠ -->
    </div>
  </section>

<script type="module">
// C√ìDIGO: Importar supabase desde db.js
import { supabase } from './config/db.js';

    // --- Elementos del DOM ---
    const backBtn = document.getElementById('backBtn');
    const userPostsGrid = document.getElementById('userPostsGrid');
    const pubCounts = document.getElementById('pubCounts');
    const profileName = document.getElementById('profileName');
    const saldoBadge = document.getElementById('saldoBadge');

    // --- Funciones de Utilidad ---

    // Renderizar las tarjetas de publicaci√≥n
    function renderPostsGrid(posts) {
        userPostsGrid.innerHTML = '';
        if (posts.length === 0) {
            userPostsGrid.innerHTML = '<div>No hay publicaciones para mostrar.</div>';
        } else {
            posts.forEach(p => {
                const card = document.createElement('div');
                card.className = 'pub-card';
                card.dataset.id = p.id_publicacion; 
                card.innerHTML = `
                ${p.imagen_url ? `<img src="${p.imagen_url}" alt="${p.titulo || 'Publicaci√≥n'}" />` : ''}
                   
                <span class="menu-dots" data-id="${p.id_publicacion}">...</span>
                    <ul class="menu-opciones" id="menu-${p.id_publicacion}">
                        <li data-action="edit" data-id="${p.id_publicacion}">‚úèÔ∏è Editar</li>
                        <li data-action="delete" data-id="${p.id_publicacion}">üóëÔ∏è Eliminar</li>
                    </ul>

                <div style="padding: 8px;">
                        <div class="pub-credit" style="position: static; margin-bottom: 8px; background: #eee; color: #333; display: inline-block;">
                            ${p.precio || 0} ‚ôªÔ∏è
                        </div>

                        <strong style="display: block;">${p.titulo || 'Sin t√≠tulo'}</strong>
                        
                        <p style="font-size: 0.8rem; color: #666; margin-top: 4px;">Descripci√≥n: ${p.descripcion || 'Sin descripci√≥n'}</p>
                    </div>
                `;
                userPostsGrid.appendChild(card);
            });
        }
        pubCounts.textContent = `${posts.length} Publicaciones ¬∑ 0 Vendidos`;
    }

// perfil.html - A√±ade esta nueva funci√≥n
// ----------------------------------------------------------------------

async function fetchUserProfile(userId) {
    if (!userId) {
        profileName.textContent = 'Usuario Desconocido';
        return;
    }

    try {
        const { data, error } = await supabase
            .from('usuario') 
            .select('nombre_completo, saldo_creditos') // ‚úÖ CAMBIO: saldo_credito ‚Üí saldo_creditos
            .eq('auth_id', userId)
            .single();

        if (error) throw error;

        if (data) {
            profileName.textContent = data.nombre_completo || 'Perfil';            
            saldoBadge.textContent = `${data.saldo_creditos || 0} ‚ôªÔ∏è`; // ‚úÖ CAMBIO: saldo_credito ‚Üí saldo_creditos

            localStorage.setItem('auth_username', data.nombre_completo);            
        } else {
            profileName.textContent = 'Usuario no encontrado';
        }

    } catch (err) {
        console.error('Error al cargar el perfil de usuario:', err);
        profileName.textContent = 'Error de perfil';
    }
}
// ----------------------------------------------------------------------

    // Cargar todas las publicaciones
    async function fetchAllPosts(userId) {
    // üö® 1. Obtener el ID del usuario logueado

    if (!userId) {
        userPostsGrid.innerHTML = '<div>Inicia sesi√≥n para ver tus publicaciones.</div>';
        pubCounts.textContent = '0 Publicaciones ¬∑ 0 Vendidos';
        console.warn("Usuario no autenticado. No se pueden cargar publicaciones.");
        return; 
    }
userPostsGrid.innerHTML = '<div>Cargando publicaciones...</div>';
    try {
        const { data: posts, error } = await supabase
            .from('Publicacion') 
            .select('id_publicacion, titulo, descripcion, precio, imagen_url') 
            // üö® 2. FILTRO CLAVE: Solo publicaciones donde usuario_id sea igual al userId
            .eq('usuario_id', userId) 
            .order('id_publicacion', { ascending: false });

        if (error) {
            console.error('Detalle del error de Supabase (Posts):', error.message);
            throw error;
        }
        
        renderPostsGrid(posts || []);

    } catch (err) {
        console.error('Error al cargar publicaciones:', err);
        // Sugerencia: El error puede ser por RLS.
        userPostsGrid.innerHTML = '<div>Error al cargar las publicaciones. (Verifica tu pol√≠tica RLS en Supabase: debe permitir SELECT si el usuario_id = auth_id())</div>';
    }
}
    // Cargar saldo desde localStorage
    function fetchSaldo() {
        let saldo = localStorage.getItem('saldo');
        if (!saldo) {
            saldo = 0;
            localStorage.setItem('saldo', saldo);
        }
        saldoBadge.textContent = `${saldo} ‚ôªÔ∏è`;
    }

    // Eliminar publicaci√≥n
    async function handleDeletePost(postId, userId) {
        if (!confirm('¬øEst√°s seguro de que quieres eliminar esta publicaci√≥n? Esta acci√≥n es irreversible.')) {
            return;
        }

        try {
            const { error } = await supabase
                .from('Publicacion')
                .delete()
                .eq('id_publicacion', postId)
                .eq('usuario_id', userId); // Asegura que solo se elimine si es del usuario

            if (error) throw error;

            alert('Publicaci√≥n eliminada con √©xito.');
            fetchAllPosts(userId); // üö® PASAR userId AQU√ç

        } catch (err) {
            console.error('Error al eliminar publicaci√≥n:', err);
            alert('Error al eliminar la publicaci√≥n. Revise la consola y las pol√≠ticas RLS.');
        }
    }

    // --- Event Listeners ---

    // Flecha volver
    backBtn.addEventListener('click', function () {
        if (history.length > 1) history.back(); else window.location.href = 'index2.html';
    });

    // Inicializar al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Obtener el ID del usuario
        const userId = localStorage.getItem('auth_id'); 
        
        if (!userId) {
            // Si no hay ID, forzamos la redirecci√≥n al login o a la p√°gina principal
            alert('Debes iniciar sesi√≥n para ver tu perfil.');
            window.location.href = 'index2.html';
            return;
        }

        // 2. Cargar datos del perfil (Nombre y Saldo)
        fetchUserProfile(userId);

        // 3. Cargar publicaciones del usuario üö® PASAR EL userId AQU√ç
        fetchAllPosts(userId);
    });

    // Event listener para men√∫ y acciones de publicaciones
    userPostsGrid.addEventListener('click', function(event) {
        const target = event.target;
        
        // Mostrar/Ocultar el men√∫
        if (target.classList.contains('menu-dots')) {
            const postId = target.dataset.id;
            const menu = document.getElementById(`menu-${postId}`);
            
            document.querySelectorAll('.menu-opciones.show').forEach(m => {
                if (m.id !== `menu-${postId}`) {
                    m.classList.remove('show');
                }
            });

            menu.classList.toggle('show');
        }

        // Ejecutar la acci√≥n (Editar o Eliminar)
        if (target.tagName === 'LI' && target.closest('.menu-opciones')) {
            const action = target.dataset.action;
            const postId = target.dataset.id;

            target.closest('.menu-opciones').classList.remove('show');

            if (action === 'delete') {
                handleDeletePost(postId, userId); // üö® PASAR userId AQU√ç TAMBI√âN
            } else if (action === 'edit') {
                window.location.href = `editar.html?id=${postId}`;
            }
        }
    });
    
</script>
</body>
</html>