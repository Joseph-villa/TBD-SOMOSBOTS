<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - Trueque Digital</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .pub-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
            transition: transform 0.2s;
        }
        .pub-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .pub-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .pub-credit {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #22c55e;
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.875rem;
        }
        .pub-content {
            padding: 15px;
        }
        .menu-dots {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            cursor: pointer;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .menu-opciones {
            position: absolute;
            top: 40px;
            left: 10px;
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            list-style: none;
            padding: 0;
            margin: 0;
            z-index: 20;
            min-width: 120px;
            display: none;
        }
        .menu-opciones.show {
            display: block;
        }
        .menu-opciones li {
            padding: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #4b5563;
        }
        .menu-opciones li:hover {
            background-color: #f3f4f6;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #6b7280;
        }
        .no-posts {
            grid-column: 1 / -1;
            text-align: center;
            padding: 50px;
            background-color: #f9fafb;
            border-radius: 12px;
            border: 1px dashed #e5e7eb;
        }
        #modalEmprendedor {
            display: none;
            align-items: center;
            justify-content: center;
        }
        .modal-visible {
            display: flex !important;
        }
        .star-rating {
            display: inline-flex;
            align-items: center;
        }
        .star {
            color: #d1d5db;
            margin-right: 2px;
        }
        .star.filled {
            color: #fbbf24;
        }
        .rating-average {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
        }
        .review-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #10b981;
        }
        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .review-comment {
            color: #4b5563;
            font-style: italic;
        }
        .no-reviews {
            text-align: center;
            padding: 40px;
            color: #6b7280;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px dashed #d1d5db;
        }
        /* --- estilos nuevos para reportes --- */
        .report-grid {
            display:flex;
            gap:12px;
            margin-top:12px;
            align-items:stretch;
            flex-wrap:wrap;
        }
        .report-card {
            flex:1 1 200px;
            display:flex;
            gap:12px;
            align-items:center;
            padding:14px;
            border-radius:12px;
            box-shadow:0 8px 24px rgba(15,23,42,0.06);
            border:1px solid rgba(15,23,42,0.04);
            background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,250,250,0.9));
            min-width:180px;
        }
        .report-card .icon {
            width:54px;
            height:54px;
            border-radius:10px;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:22px;
            color:white;
            flex-shrink:0;
        }
        .report-card .content { flex:1; }
        .report-card .label { font-size:0.9rem; color:#374151; margin-bottom:4px; }
        .report-card .value { font-size:1.4rem; font-weight:800; color:#0f5132; }
        .report-card .unit { font-size:0.85rem; color:#6b7280; margin-left:6px; }

        /* colores espec√≠ficos */
        .report-co2 .icon { background: linear-gradient(135deg,#20bf6b,#0ea45f); }
        .report-agua .icon { background: linear-gradient(135deg,#60a5fa,#3b82f6); }
        .report-energia .icon { background: linear-gradient(135deg,#ffd166,#ffb020); }

        @media (max-width:640px){
            .report-grid { flex-direction:column; }
        }

        /* --- subt√≠tulo bonito para "Reportes" --- */
        .reports-subtitle {
            display:flex;
            align-items:center;
            gap:12px;
            margin:0 0 12px 0;
            font-size:1rem;
            font-weight:700;
            color:#111827;
            letter-spacing:0.2px;
        }
        .reports-subtitle .decor {
            width:44px;
            height:8px;
            border-radius:8px;
            background:linear-gradient(90deg,#10b981 0%,#06b6d4 100%);
            box-shadow:0 6px 18px rgba(6,182,150,0.12);
            flex-shrink:0;
        }
        .reports-subtitle .label-small {
            font-size:0.85rem;
            font-weight:600;
            color:#374151;
        }
        .reports-subtitle .hint {
            font-size:0.85rem;
            color:#6b7280;
            font-weight:500;
        }

        /* --- Nuevos estilos para el banner "Vendido" --- */
        .vendido-banner {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: #ef4444;
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.875rem;
            z-index: 5;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .pub-card.vendido {
            opacity: 0.85;
            filter: grayscale(0.3);
        }
        .pub-card.vendido .pub-credit {
            background-color: #6b7280;
        }

        /* --- Estilos para la funcionalidad "Ver m√°s" --- */
        .posts-container {
            position: relative;
        }
        .posts-container.collapsed {
            max-height: 600px;
            overflow: hidden;
            position: relative;
        }
        .posts-container.collapsed::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100px;
            background: linear-gradient(transparent, rgba(249, 250, 251, 0.9));
            pointer-events: none;
        }
        .reviews-container.collapsed {
            max-height: 400px;
            overflow: hidden;
            position: relative;
        }
        .reviews-container.collapsed::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(transparent, rgba(249, 250, 251, 0.9));
            pointer-events: none;
        }
        .see-more-btn {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .see-more-btn:hover {
            background-color: #2563eb;
        }
        .see-less-btn {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            background-color: #6b7280;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .see-less-btn:hover {
            background-color: #4b5563;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="flex justify-between items-center mb-6">
            <button id="backBtn" class="text-green-600 hover:text-green-800 transition duration-150">
                <i class="fas fa-arrow-left mr-2"></i> Volver al Dashboard
            </button>
            <h1 class="text-3xl font-extrabold text-gray-800">Mi Perfil</h1>
            <button id="logoutBtn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-150">
                <i class="fas fa-sign-out-alt"></i> Salir
            </button>
        </header>

        <!-- Secci√≥n de Datos del Usuario -->
        <section class="bg-white rounded-xl shadow-lg p-6 mb-8 border-t-4 border-green-500">
            <div class="flex items-center space-x-6">
                <div class="flex-shrink-0">
                    <div class="w-16 h-16 bg-green-200 rounded-full flex items-center justify-center text-green-700 text-3xl font-bold">
                        <i class="fas fa-user-circle"></i>
                    </div>
                </div>
                <div class="flex-1">
                    <h2 id="profileName" class="text-2xl font-bold text-gray-900">Cargando Nombre...</h2>
                    <p id="profileEmail" class="text-gray-500 text-sm">Cargando Correo...</p>
                    <div class="mt-2 flex items-center space-x-4">
                        <span class="px-3 py-1 bg-yellow-100 text-yellow-800 font-semibold text-sm rounded-full">
                            Saldo: <span id="saldoBadge">0 ‚ôªÔ∏è</span>
                        </span>
                        <button id="recargarBtn" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            Recargar Cr√©ditos
                        </button>
                    </div>
                </div>
                
                <!-- Secci√≥n de Calificaci√≥n Promedio -->
                <div class="text-center border-l pl-6 border-gray-200">
                    <div class="rating-average" id="ratingAverage">0.0</div>
                    <div class="star-rating mt-1" id="starRating">
                        <span class="star">‚òÖ</span>
                        <span class="star">‚òÖ</span>
                        <span class="star">‚òÖ</span>
                        <span class="star">‚òÖ</span>
                        <span class="star">‚òÖ</span>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">
                        <span id="reviewCount">0</span> rese√±a(s)
                    </p>
                </div>
            </div>
            
            <!-- Bot√≥n de Solicitud de Emprendedor -->
            <div class="mt-6 pt-4 border-t border-gray-100">
                <div id="emprendedorSection" class="p-4 bg-green-50 rounded-lg border border-green-200">
                    <h3 class="text-lg font-semibold text-green-800 mb-2 flex items-center">
                        <i class="fas fa-store mr-2"></i> Estado de Emprendedor
                    </h3>
                    <p id="emprendedorStatus" class="text-gray-700 mb-4">
                        Puedes postularte para obtener el rol de "Emprendedor" y empezar a monetizar.
                    </p>
                    <button 
                        id="btnSolicitarEmprendedor"
                        class="px-4 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition duration-200 shadow-md text-sm">
                        <i class="fas fa-handshake mr-1"></i> Solicitar Rol
                    </button>
                </div>
            </div>
        </section>

        <!-- Secci√≥n de Estad√≠sticas -->
        <section class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
            <div class="bg-white rounded-xl shadow p-4 text-center">
                <p class="text-3xl font-extrabold text-green-600" id="pubCount">0</p>
                <p class="text-gray-500 text-sm">Publicaciones Activas</p>
            </div>
            <div class="bg-white rounded-xl shadow p-4 text-center">
                <p class="text-3xl font-extrabold text-green-600" id="vendidasCount">0</p>
                <p class="text-gray-500 text-sm">Publicaciones Vendidas</p>
            </div>
            <div class="bg-white rounded-xl shadow p-4 text-center">
                <p class="text-3xl font-extrabold text-green-600" id="creditosGenerados">0</p>
                <p class="text-gray-500 text-sm">Cr√©ditos Generados</p>
            </div>
            <div class="bg-white rounded-xl shadow p-4 text-center">
                <p class="text-3xl font-extrabold text-green-600" id="totalReviews">0</p>
                <p class="text-gray-500 text-sm">Rese√±as Recibidas</p>
            </div>
            <div class="bg-white rounded-xl shadow p-4 text-center">
                <p class="text-3xl font-extrabold text-green-600" id="avgRating">0.0</p>
                <p class="text-gray-500 text-sm">Calificaci√≥n Promedio</p>
            </div>
        </section>

        <!-- Secci√≥n de Rese√±as y Calificaciones -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-star mr-2 text-yellow-500"></i> Mis Rese√±as
            </h2>
            <div id="reviewsContainer" class="reviews-container collapsed space-y-4">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> Cargando rese√±as...
                </div>
            </div>
            <button id="toggleReviewsBtn" class="see-more-btn" style="display: none;">
                <i class="fas fa-chevron-down mr-2"></i> Ver m√°s rese√±as
            </button>
        </section>

        <!-- Mis Publicaciones -->
        <section class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Mis Publicaciones</h2>
                <button id="openFormBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-150">
                    <i class="fas fa-plus"></i> Crear Nueva
                </button>
            </div>
            <div class="posts-container collapsed">
                <div id="userPostsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Las publicaciones se renderizar√°n aqu√≠ -->
                </div>
            </div>
            <button id="togglePostsBtn" class="see-more-btn" style="display: none;">
                <i class="fas fa-chevron-down mr-2"></i> Ver m√°s publicaciones
            </button>
        </section>

        <!-- Reporte de Ahorros (solo emprendedores) -->
        <div id="reportSection" style="display:none;">
            <h3 class="reports-subtitle">
                <span class="decor" aria-hidden="true"></span>
                <span class="label-small">Reportes</span>
                <span class="hint">Resumen de ahorros del vendedor</span>
            </h3>
            <div class="report-grid">
                <div class="report-card report-co2" title="CO2 ahorrado">
                    <div class="icon"><i class="fas fa-seedling"></i></div>
                    <div class="content">
                        <div class="label">CO2 ahorrado</div>
                        <div>
                            <span class="value" id="reportCo2">0</span>
                            <span class="unit">kg</span>
                        </div>
                    </div>
                </div>

                <div class="report-card report-agua" title="Agua ahorrada">
                    <div class="icon"><i class="fas fa-tint"></i></div>
                    <div class="content">
                        <div class="label">Agua ahorrada</div>
                        <div>
                            <span class="value" id="reportAgua">0</span>
                            <span class="unit">L</span>
                        </div>
                    </div>
                </div>

                <div class="report-card report-energia" title="Energ√≠a ahorrada">
                    <div class="icon"><i class="fas fa-bolt"></i></div>
                    <div class="content">
                        <div class="label">Energ√≠a ahorrada</div>
                        <div>
                            <span class="value" id="reportEnergia">0</span>
                            <span class="unit">kWh</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PARA SOLICITUD DE EMPRENDEDOR -->
    <div id="modalEmprendedor" class="fixed inset-0 bg-gray-900 bg-opacity-70 items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 m-4 transform transition-transform duration-300 scale-95 opacity-0" id="modalContent">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                <i class="fas fa-rocket mr-2 text-green-600"></i> Postulaci√≥n Emprendedor
            </h2>
            
            <form id="formSolicitudEmprendedor">
                <div class="mb-4">
                    <label for="nombreNegocio" class="block text-sm font-medium text-gray-700">Nombre del Negocio / Marca <span class="text-red-500">*</span></label>
                    <input type="text" id="nombreNegocio" required
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500">
                </div>

                <div class="mb-4">
                    <label for="descripcionNegocio" class="block text-sm font-medium text-gray-700">Describe tu modelo sostenible y por qu√© usas el trueque <span class="text-red-500">*</span></label>
                    <textarea id="descripcionNegocio" rows="3" required
                              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"></textarea>
                </div>

                <div class="mb-4">
                    <label for="productosServicios" class="block text-sm font-medium text-gray-700">Productos o Servicios Principales a Ofrecer <span class="text-red-500">*</span></label>
                    <textarea id="productosServicios" rows="2" required
                              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"></textarea>
                </div>

                <div class="mb-6">
                    <label for="urlContacto" class="block text-sm font-medium text-gray-700">Sitio Web / Red Social (Opcional)</label>
                    <input type="url" id="urlContacto" 
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500">
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" id="btnCerrarModal"
                            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition duration-150">
                        Cancelar
                    </button>
                    <button type="submit"
                            class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition duration-150">
                        Enviar Postulaci√≥n
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { supabase } from './config/db.js';

        // --- Elementos del DOM ---
        const backBtn = document.getElementById('backBtn');
        const openFormBtn = document.getElementById('openFormBtn');
        const userPostsGrid = document.getElementById('userPostsGrid');
        const profileName = document.getElementById('profileName');
        const profileEmail = document.getElementById('profileEmail');
        const saldoBadge = document.getElementById('saldoBadge');
        const pubCount = document.getElementById('pubCount');
        const logoutBtn = document.getElementById('logoutBtn');
        const recargarBtn = document.getElementById('recargarBtn');
        const emprendedorStatusDiv = document.getElementById('emprendedorSection');
        const btnSolicitarEmprendedor = document.getElementById('btnSolicitarEmprendedor');
        const modalEmprendedor = document.getElementById('modalEmprendedor');
        const modalContent = document.getElementById('modalContent');
        const btnCerrarModal = document.getElementById('btnCerrarModal');
        const formSolicitudEmprendedor = document.getElementById('formSolicitudEmprendedor');
        
        // Elementos para calificaciones
        const ratingAverage = document.getElementById('ratingAverage');
        const starRating = document.getElementById('starRating');
        const reviewCount = document.getElementById('reviewCount');
        const reviewsContainer = document.getElementById('reviewsContainer');
        const totalReviews = document.getElementById('totalReviews');
        const avgRating = document.getElementById('avgRating');
        const vendidasCount = document.getElementById('vendidasCount');
        const creditosGenerados = document.getElementById('creditosGenerados');
        
        // Elementos para funcionalidad "Ver m√°s"
        const togglePostsBtn = document.getElementById('togglePostsBtn');
        const toggleReviewsBtn = document.getElementById('toggleReviewsBtn');
        const postsContainer = document.querySelector('.posts-container');
        const reviewsContainerElement = document.querySelector('.reviews-container');

        let currentUserId = null;
        let currentUserRol = 'Usuario';
        let allPosts = [];
        let allReviews = [];

        // Funci√≥n para debug
        function debug(message, data = null) {
            console.log(`[DEBUG] ${message}`, data || '');
        }

        // ---------------------------------------------------
        // --- FUNCIONES PRINCIPALES CORREGIDAS ---
        // ---------------------------------------------------

        async function loadUserData() {
            try {
                debug('Iniciando carga de datos del usuario...');
                
                const { data: { user }, error: authError } = await supabase.auth.getUser();
                
                if (authError || !user) {
                    console.error('Error de autenticaci√≥n:', authError);
                    window.location.href = 'index.html';
                    return;
                }

                currentUserId = user.id;
                debug('Usuario autenticado:', user.id);

                // Buscar usuario en la tabla 'usuario' usando auth_id
                const { data: usuario, error: usuarioError } = await supabase
                    .from('usuario')
                    .select('*')
                    .eq('auth_id', currentUserId)
                    .single();

                if (usuarioError) {
                    debug('Error al buscar usuario por auth_id:', usuarioError);
                    throw usuarioError;
                }

                if (!usuario) {
                    console.error('Usuario no encontrado en la base de datos');
                    return;
                }

                debug('Usuario encontrado:', usuario);

                // Actualizar UI con datos del usuario
                profileName.textContent = usuario.nombre_completo || 'Usuario';
                profileEmail.textContent = usuario.correo_electronico || user.email;
                currentUserRol = usuario.rol || 'Usuario';

                // Cargar saldo desde billetera
                const { data: billetera, error: billeteraError } = await supabase
                    .from('billetera')
                    .select('credito_actual')
                    .eq('usuario_id', currentUserId)
                    .single();

                let saldo = 0;
                if (!billeteraError && billetera) {
                    saldo = billetera.credito_actual || 0;
                } else {
                    // Fallback al saldo en usuario
                    saldo = usuario.saldo_creditos || 0;
                }
                
                saldoBadge.textContent = `${saldo} ‚ôªÔ∏è`;

                // Verificar estado de emprendedor
                await verificarEstadoEmprendedor(currentUserId);

            } catch (error) {
                console.error('Error al cargar datos del usuario:', error);
                profileName.textContent = 'Error al cargar usuario';
                profileEmail.textContent = 'Por favor recarga la p√°gina';
            }
        }

        async function fetchUserPosts() {
            if (!currentUserId) {
                debug('No hay currentUserId');
                return;
            }

            userPostsGrid.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Cargando publicaciones...</div>';
            
            try {
                debug('Buscando publicaciones para usuario:', currentUserId);
                
                // Usar el nombre exacto de tu tabla: Publicacion
                const { data: posts, error: postsError } = await supabase
                    .from('Publicacion')
                    .select('*')
                    .eq('usuario_id', currentUserId)
                    .order('fecha_publicacion', { ascending: false });

                if (postsError) {
                    debug('Error al cargar publicaciones:', postsError);
                    throw postsError;
                }

                debug(`Publicaciones encontradas:`, posts?.length || 0);

                if (!posts || posts.length === 0) {
                    userPostsGrid.innerHTML = `
                        <div class="no-posts">
                            <h3>üì≠ A√∫n no tienes publicaciones</h3>
                            <p>Comienza creando tu primera publicaci√≥n</p>
                            <button onclick="window.location.href='publicar.html'" 
                                    class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-150">
                                <i class="fas fa-plus"></i> Crear Publicaci√≥n
                            </button>
                        </div>
                    `;
                    updateStats([], []);
                    return;
                }

                debug('Publicaciones cargadas:', posts);
                
                // Guardar todas las publicaciones
                allPosts = posts;
                
                // Buscar publicaciones vendidas
                const soldPosts = await findSoldPosts(posts);
                debug('Publicaciones vendidas:', soldPosts);
                
                // Renderizar solo las primeras 8 publicaciones (2 filas)
                const initialPosts = posts.slice(0, 8);
                renderPostsGrid(initialPosts, soldPosts);
                updateStats(posts, soldPosts);
                
                // Mostrar bot√≥n "Ver m√°s" si hay m√°s de 8 publicaciones
                if (posts.length > 8) {
                    togglePostsBtn.style.display = 'block';
                    togglePostsBtn.innerHTML = '<i class="fas fa-chevron-down mr-2"></i> Ver m√°s publicaciones (' + (posts.length - 8) + ' m√°s)';
                    postsContainer.classList.add('collapsed');
                } else {
                    togglePostsBtn.style.display = 'none';
                    postsContainer.classList.remove('collapsed');
                }

            } catch (err) {
                console.error('Error al cargar publicaciones:', err);
                userPostsGrid.innerHTML = `
                    <div class="no-posts">
                        <h3>‚ùå Error al cargar las publicaciones</h3>
                        <p>${err.message}</p>
                        <button onclick="location.reload()" 
                                class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition duration-150 mt-2">
                            <i class="fas fa-refresh"></i> Reintentar
                        </button>
                    </div>
                `;
            }
        }

        async function findSoldPosts(posts) {
            if (!posts || posts.length === 0) return [];
            
            const postIds = posts.map(p => p.id_publicacion);
            let soldPosts = [];

            // Buscar en la tabla Intercambio con estado 'completado'
            try {
                const { data: transactions, error } = await supabase
                    .from('Intercambio')
                    .select('publicacion_id, estado')
                    .in('publicacion_id', postIds)
                    .eq('estado', 'completado');

                if (!error && transactions && transactions.length > 0) {
                    soldPosts = transactions.map(t => t.publicacion_id);
                    debug(`Transacciones completadas encontradas:`, soldPosts.length);
                }
            } catch (e) {
                debug('Error al buscar transacciones:', e);
            }

            // Si no hay transacciones, buscar en campos directos de las publicaciones
            if (soldPosts.length === 0) {
                soldPosts = posts
                    .filter(p => p.estado === 'vendido' || p.estado === 'completado')
                    .map(p => p.id_publicacion);
                debug('Publicaciones vendidas por campos directos:', soldPosts.length);
            }

            return soldPosts;
        }

        function renderPostsGrid(posts, soldPosts = []) {
            userPostsGrid.innerHTML = '';
            
            if (posts.length === 0) {
                userPostsGrid.innerHTML = `
                    <div class="no-posts">
                        <h3>üì≠ A√∫n no tienes publicaciones</h3>
                        <p>Comienza creando tu primera publicaci√≥n</p>
                        <button onclick="window.location.href='publicar.html'" 
                                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-150">
                            <i class="fas fa-plus"></i> Crear Publicaci√≥n
                        </button>
                    </div>
                `;
                return;
            }

            posts.forEach(p => {
                const isSold = soldPosts.includes(p.id_publicacion);
                const card = document.createElement('div');
                card.className = `pub-card ${isSold ? 'vendido' : ''}`;
                card.dataset.id = p.id_publicacion;
                
                const titulo = p.titulo || 'Sin t√≠tulo';
                const descripcion = p.descripcion || 'Sin descripci√≥n';
                const precio = p.precio || 0;
                const categoria = p.nombre_categoria || 'General';
                const imagen = p.imagen_url;
                
                card.innerHTML = `
                    ${isSold ? `
                        <div class="vendido-banner">
                            <i class="fas fa-check-circle"></i>
                            Vendido
                        </div>
                    ` : ''}
                    
                    ${imagen ? `
                        <img src="${imagen}" alt="${titulo}" 
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                    ` : ''}
                    
                    ${!imagen ? `
                        <div style="width: 100%; height: 200px; background: linear-gradient(135deg, #f0f3f0 0%, #e6f4ea 100%); 
                                    display: flex; align-items: center; justify-content: center; color: #999;">
                                <i class="fas fa-image" style="font-size: 3rem;"></i>
                        </div>
                    ` : ''}
                    
                    <div class="pub-credit">${precio} ‚ôªÔ∏è</div>
                    
                    ${!isSold ? `
                        <div class="menu-dots" data-id="${p.id_publicacion}">
                            <i class="fas fa-ellipsis-v"></i>
                        </div>
                        
                        <ul class="menu-opciones" id="menu-${p.id_publicacion}">
                            <li data-action="edit" data-id="${p.id_publicacion}">
                                <i class="fas fa-edit"></i> Editar
                            </li>
                            <li data-action="delete" data-id="${p.id_publicacion}" style="color: #f44336;">
                                <i class="fas fa-trash"></i> Eliminar
                            </li>
                        </ul>
                    ` : ''}

                    <div class="pub-content">
                        <strong>${titulo}</strong>
                        <p>${descripcion.substring(0, 100)}${descripcion.length > 100 ? '...' : ''}</p>
                        <small>
                            <i class="fas fa-tag"></i> ${categoria}
                        </small>
                        <br>
                        <small>
                            <i class="fas fa-calendar"></i> ${new Date(p.fecha_publicacion).toLocaleDateString('es-ES')}
                        </small>
                    </div>
                `;
                userPostsGrid.appendChild(card);
            });
        }

        function updateStats(posts, soldPosts = []) {
            const totalPosts = posts.length;
            const soldCount = soldPosts.length;
            const activeCount = totalPosts - soldCount;
            
            debug(`Estad√≠sticas: ${activeCount} activas, ${soldCount} vendidas, total: ${totalPosts}`);
            
            // Actualizar contadores
            if (pubCount) pubCount.textContent = activeCount;
            if (vendidasCount) vendidasCount.textContent = soldCount;
            
            // Calcular cr√©ditos generados (suma de precios de publicaciones vendidas)
            const creditos = posts
                .filter(p => soldPosts.includes(p.id_publicacion))
                .reduce((total, p) => total + (Number(p.precio) || 0), 0);
            
            if (creditosGenerados) {
                creditosGenerados.textContent = creditos;
            }
        }

        async function loadUserRatings() {
            if (!currentUserId) return;

            try {
                // Usar la tabla calificacion de tu esquema
                const { data: reviews, error } = await supabase
                    .from('calificacion')
                    .select('*')
                    .eq('calificado_id', currentUserId)
                    .order('fecha_calificacion', { ascending: false });

                if (error) {
                    debug('Error al cargar calificaciones:', error);
                    throw error;
                }

                const total = reviews?.length || 0;
                const average = total > 0 
                    ? (reviews.reduce((sum, review) => sum + (review.puntuacion || 0), 0) / total).toFixed(1)
                    : 0;

                // Actualizar UI
                if (reviewCount) reviewCount.textContent = total;
                if (totalReviews) totalReviews.textContent = total;
                if (ratingAverage) ratingAverage.textContent = average;
                if (avgRating) avgRating.textContent = average;

                // Actualizar estrellas
                if (starRating) {
                    const stars = starRating.querySelectorAll('.star');
                    const rating = Math.round(average);
                    stars.forEach((star, index) => {
                        star.classList.toggle('filled', index < rating);
                    });
                }

                // Guardar todas las rese√±as
                allReviews = reviews || [];
                
                // Renderizar solo las primeras 3 rese√±as
                const initialReviews = allReviews.slice(0, 3);
                renderReviews(initialReviews);
                
                // Mostrar bot√≥n "Ver m√°s" si hay m√°s de 3 rese√±as
                if (allReviews.length > 3) {
                    toggleReviewsBtn.style.display = 'block';
                    toggleReviewsBtn.innerHTML = '<i class="fas fa-chevron-down mr-2"></i> Ver m√°s rese√±as (' + (allReviews.length - 3) + ' m√°s)';
                    reviewsContainerElement.classList.add('collapsed');
                } else {
                    toggleReviewsBtn.style.display = 'none';
                    reviewsContainerElement.classList.remove('collapsed');
                }

            } catch (error) {
                console.error('Error al cargar calificaciones:', error);
                if (reviewsContainer) {
                    reviewsContainer.innerHTML = `
                        <div class="no-reviews">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                            <p>Error al cargar las rese√±as</p>
                        </div>
                    `;
                }
            }
        }

        function renderReviews(reviews) {
            if (!reviewsContainer) return;
            
            if (reviews.length === 0) {
                reviewsContainer.innerHTML = `
                    <div class="no-reviews">
                        <i class="fas fa-star text-2xl mb-2"></i>
                        <h3 class="text-lg font-semibold mb-2">A√∫n no tienes rese√±as</h3>
                        <p class="text-gray-600">Las rese√±as aparecer√°n aqu√≠ cuando otros usuarios te califiquen.</p>
                    </div>
                `;
                return;
            }

            reviewsContainer.innerHTML = reviews.map(review => `
                <div class="review-card">
                    <div class="review-header">
                        <div class="star-rating">
                            ${Array.from({length: 5}, (_, i) => 
                                `<span class="star ${i < (review.puntuacion || 0) ? 'filled' : ''}">‚òÖ</span>`
                            ).join('')}
                        </div>
                        <span class="text-sm text-gray-500">
                            ${review.fecha_calificacion ? new Date(review.fecha_calificacion).toLocaleDateString('es-ES') : 'Fecha no disponible'}
                        </span>
                    </div>
                    <div class="review-comment">
                        "${review.comentario || 'Sin comentario'}"
                    </div>
                </div>
            `).join('');
        }

        // Funciones para mostrar/ocultar contenido
        function togglePostsVisibility() {
            if (postsContainer.classList.contains('collapsed')) {
                // Mostrar todas las publicaciones
                renderPostsGrid(allPosts, []);
                postsContainer.classList.remove('collapsed');
                togglePostsBtn.innerHTML = '<i class="fas fa-chevron-up mr-2"></i> Ver menos';
            } else {
                // Mostrar solo las primeras 8 publicaciones
                const initialPosts = allPosts.slice(0, 8);
                renderPostsGrid(initialPosts, []);
                postsContainer.classList.add('collapsed');
                togglePostsBtn.innerHTML = '<i class="fas fa-chevron-down mr-2"></i> Ver m√°s publicaciones (' + (allPosts.length - 8) + ' m√°s)';
            }
        }

        function toggleReviewsVisibility() {
            if (reviewsContainerElement.classList.contains('collapsed')) {
                // Mostrar todas las rese√±as
                renderReviews(allReviews);
                reviewsContainerElement.classList.remove('collapsed');
                toggleReviewsBtn.innerHTML = '<i class="fas fa-chevron-up mr-2"></i> Ver menos rese√±as';
            } else {
                // Mostrar solo las primeras 3 rese√±as
                const initialReviews = allReviews.slice(0, 3);
                renderReviews(initialReviews);
                reviewsContainerElement.classList.add('collapsed');
                toggleReviewsBtn.innerHTML = '<i class="fas fa-chevron-down mr-2"></i> Ver m√°s rese√±as (' + (allReviews.length - 3) + ' m√°s)';
            }
        }

        async function verificarEstadoEmprendedor(userId) {
            try {
                const { data: perfil, error } = await supabase
                    .from('perfil_emprendedor')
                    .select('*')
                    .eq('usuario_id', userId)
                    .single();

                if (error && error.code !== 'PGRST116') { // PGRST116 = no encontrado
                    debug('Error al verificar perfil emprendedor:', error);
                    return;
                }

                if (perfil) {
                    // Usuario ya tiene perfil de emprendedor
                    const estado = perfil.estado_solicitud;
                    const emprendedorStatus = document.getElementById('emprendedorStatus');
                    const btnSolicitar = document.getElementById('btnSolicitarEmprendedor');

                    if (estado === 'aprobado') {
                        emprendedorStatus.innerHTML = `
                            <span class="text-green-600 font-semibold">‚úÖ ¬°Eres un Emprendedor Verificado!</span>
                            <p class="text-gray-700 mt-1">Tu negocio: <strong>${perfil.nombre_negocio}</strong></p>
                        `;
                        btnSolicitar.innerHTML = '<i class="fas fa-check"></i> Solicitud Aprobada';
                        btnSolicitar.disabled = true;
                        btnSolicitar.classList.remove('bg-green-600', 'hover:bg-green-700');
                        btnSolicitar.classList.add('bg-gray-400', 'cursor-not-allowed');

                        // Mostrar reportes de ahorros para emprendedores
                        document.getElementById('reportSection').style.display = 'block';
                        await cargarReportesAhorros();

                    } else if (estado === 'pendiente') {
                        emprendedorStatus.innerHTML = `
                            <span class="text-yellow-600 font-semibold">‚è≥ Solicitud en revisi√≥n</span>
                            <p class="text-gray-700 mt-1">Tu solicitud como "${perfil.nombre_negocio}" est√° siendo revisada.</p>
                        `;
                        btnSolicitar.innerHTML = '<i class="fas fa-clock"></i> En Revisi√≥n';
                        btnSolicitar.disabled = true;
                        btnSolicitar.classList.remove('bg-green-600', 'hover:bg-green-700');
                        btnSolicitar.classList.add('bg-yellow-500', 'cursor-not-allowed');

                    } else if (estado === 'rechazado') {
                        emprendedorStatus.innerHTML = `
                            <span class="text-red-600 font-semibold">‚ùå Solicitud rechazada</span>
                            <p class="text-gray-700 mt-1">Puedes volver a enviar tu solicitud con informaci√≥n mejorada.</p>
                        `;
                        btnSolicitar.innerHTML = '<i class="fas fa-redo"></i> Volver a Solicitar';
                    }
                } else {
                    // No tiene perfil de emprendedor, mostrar bot√≥n normal
                    document.getElementById('emprendedorStatus').textContent = 
                        'Puedes postularte para obtener el rol de "Emprendedor" y empezar a monetizar.';
                }

            } catch (error) {
                console.error('Error al verificar estado emprendedor:', error);
            }
        }

        async function cargarReportesAhorros() {
            try {
                // Calcular ahorros sumando las publicaciones del usuario
                const { data: publicaciones, error } = await supabase
                    .from('Publicacion')
                    .select('ahorro_co2, ahorro_agua, ahorro_energia')
                    .eq('usuario_id', currentUserId);

                if (error) throw error;

                const totals = publicaciones.reduce((acc, pub) => ({
                    co2: acc.co2 + (pub.ahorro_co2 || 0),
                    agua: acc.agua + (pub.ahorro_agua || 0),
                    energia: acc.energia + (pub.ahorro_energia || 0)
                }), { co2: 0, agua: 0, energia: 0 });

                // Actualizar UI
                document.getElementById('reportCo2').textContent = totals.co2.toFixed(2);
                document.getElementById('reportAgua').textContent = totals.agua.toFixed(2);
                document.getElementById('reportEnergia').textContent = totals.energia.toFixed(2);

            } catch (error) {
                console.error('Error al cargar reportes:', error);
            }
        }

        function mostrarFormularioEmprendedor() {
            modalEmprendedor.classList.add('modal-visible');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function cerrarFormularioEmprendedor() {
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modalEmprendedor.classList.remove('modal-visible');
                formSolicitudEmprendedor.reset();
            }, 300);
        }

        async function enviarSolicitudEmprendedor(event) {
            event.preventDefault();
            
            const nombreNegocio = document.getElementById('nombreNegocio').value;
            const descripcionNegocio = document.getElementById('descripcionNegocio').value;
            const productosServicios = document.getElementById('productosServicios').value;
            const urlContacto = document.getElementById('urlContacto').value;

            try {
                const { data, error } = await supabase
                    .from('perfil_emprendedor')
                    .insert([
                        {
                            usuario_id: currentUserId,
                            nombre_negocio: nombreNegocio,
                            descripcion_negocio: descripcionNegocio,
                            productos_servicios: productosServicios,
                            url_contacto: urlContacto,
                            estado_solicitud: 'pendiente'
                        }
                    ]);

                if (error) throw error;

                alert('‚úÖ Solicitud enviada correctamente. Ser√° revisada por nuestro equipo.');
                cerrarFormularioEmprendedor();
                await verificarEstadoEmprendedor(currentUserId);

            } catch (error) {
                console.error('Error al enviar solicitud:', error);
                alert('‚ùå Error al enviar la solicitud. Por favor, intenta nuevamente.');
            }
        }

        async function handleDeletePost(postId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta publicaci√≥n?')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('Publicacion')
                    .delete()
                    .eq('id_publicacion', postId)
                    .eq('usuario_id', currentUserId);

                if (error) throw error;

                alert('‚úÖ Publicaci√≥n eliminada correctamente');
                await fetchUserPosts(); // Recargar publicaciones

            } catch (error) {
                console.error('Error al eliminar publicaci√≥n:', error);
                alert('‚ùå Error al eliminar la publicaci√≥n');
            }
        }

        async function handleLogout() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Error al cerrar sesi√≥n:', error);
            }
        }

        // --- Event Listeners ---
        backBtn.addEventListener('click', () => {
            window.location.href = 'index2.html';
        });

        openFormBtn.addEventListener('click', () => {
            window.location.href = 'publicar.html';
        });

        logoutBtn.addEventListener('click', handleLogout);

        recargarBtn.addEventListener('click', () => {
            window.location.href = 'compra.html';
        });

        btnSolicitarEmprendedor.addEventListener('click', mostrarFormularioEmprendedor);
        btnCerrarModal.addEventListener('click', cerrarFormularioEmprendedor);
        formSolicitudEmprendedor.addEventListener('submit', enviarSolicitudEmprendedor);

        // Event listeners para funcionalidad "Ver m√°s"
        togglePostsBtn.addEventListener('click', togglePostsVisibility);
        toggleReviewsBtn.addEventListener('click', toggleReviewsVisibility);

        // Event listeners para men√∫s de publicaciones
        userPostsGrid.addEventListener('click', function(event) {
            const target = event.target;
            const menuDots = target.closest('.menu-dots');
            const menuItem = target.closest('li[data-action]');
            
            if (menuDots) {
                const postId = menuDots.dataset.id;
                const menu = document.getElementById(`menu-${postId}`);
                
                // Cerrar otros men√∫s abiertos
                document.querySelectorAll('.menu-opciones.show').forEach(m => {
                    if (m.id !== `menu-${postId}`) m.classList.remove('show');
                });

                menu.classList.toggle('show');
            }

            if (menuItem) {
                const action = menuItem.dataset.action;
                const postId = menuItem.dataset.id;

                menuItem.closest('.menu-opciones').classList.remove('show');

                if (action === 'delete') {
                    handleDeletePost(postId);
                } else if (action === 'edit') {
                    window.location.href = `editar.html?id=${postId}`;
                }
            }
        });

        // Cerrar men√∫s al hacer click fuera
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.menu-dots') && !event.target.closest('.menu-opciones')) {
                document.querySelectorAll('.menu-opciones.show').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
            
            // Cerrar modal al hacer click fuera
            if (modalEmprendedor.classList.contains('modal-visible') && 
                !modalContent.contains(event.target) && 
                !btnSolicitarEmprendedor.contains(event.target)) {
                cerrarFormularioEmprendedor();
            }
        });

        // Inicializar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', async () => {
            modalEmprendedor.classList.remove('modal-visible');

            await loadUserData(); 
            await fetchUserPosts();
            await loadUserRatings();
            
            debug('P√°gina cargada completamente');
        });
    </script>
</body>
</html>